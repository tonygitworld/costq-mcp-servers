# MCP Server å‚æ•°ç±»å‹é—®é¢˜æ ¹å› åˆ†æ

**è°ƒæŸ¥æ—¶é—´**: 2026-01-20 14:08
**ç°è±¡**: CloudTrail å’Œ RISP MCP Server é‡åˆ°å‚æ•°ç±»å‹é”™è¯¯ï¼Œä½† Billing-Cost-Management MCP Server æ­£å¸¸

---

## ğŸ”´ é—®é¢˜ç°è±¡

### CloudTrail MCP - lookup_events

**è°ƒç”¨å‚æ•°**:
```json
{
  "attribute_key": "EventName",
  "attribute_value": "RunInstances",
  "start_time": "2026-01-20T00:00:00Z",
  "end_time": "2026-01-20T23:59:59Z",
  "max_results": "50",  // âŒ å­—ç¬¦ä¸²ç±»å‹
  "target_account_id": "859082029538"
}
```

**é”™è¯¯ä¿¡æ¯**:
```
JsonSchemaException - Parameter validation failed: Invalid request parameters:
- Field 'max_results' has invalid type: $.max_results: string found, integer expected
- Field 'max_results' has invalid type: $.max_results: string found, null expected
```

### RISP MCP - get_sp_coverage

**è°ƒç”¨å‚æ•°**:
```json
{
  "start_date": "2026-01-16",
  "end_date": "2026-01-20",
  "granularity": "DAILY",
  "filter_expression": {  // âŒ å¯¹è±¡ç±»å‹
    "Dimensions": {
      "Key": "SERVICE",
      "Values": ["Amazon Elastic Compute Cloud - Compute"]
    }
  },
  "target_account_id": "859082029538"
}
```

**é”™è¯¯ä¿¡æ¯**:
```
JsonSchemaException - Parameter validation failed: Invalid request parameters:
- Field 'filter_expression' has invalid type: $.filter_expression: string found, object expected
- Field 'filter_expression' has invalid type: $.filter_expression: string found, null expected
```

### Billing-Cost-Management MCP - cost_explorer âœ… æ­£å¸¸

**è°ƒç”¨å‚æ•°**:
```json
{
  "operation": "getCostAndUsage",
  "start_date": "2026-01-16",
  "end_date": "2026-01-20",
  "granularity": "DAILY",
  "metrics": "[\"UnblendedCost\"]",  // âœ… å­—ç¬¦ä¸²ï¼ˆJSONåºåˆ—åŒ–ï¼‰
  "filter": "{\"Dimensions\": {\"Key\": \"SERVICE\", \"Values\": [\"Amazon RDS\"]}}"  // âœ… å­—ç¬¦ä¸²ï¼ˆJSONåºåˆ—åŒ–ï¼‰
}
```

---

## ğŸ” æ ¹å› åˆ†æ

### 1ï¸âƒ£ **å‚æ•°ç±»å‹å®šä¹‰å·®å¼‚**

#### CloudTrail MCP Server (`tools.py`)

```python
async def lookup_events(
    self,
    ctx: Context,
    # ... å…¶ä»–å‚æ•° ...
    max_results: Annotated[
        Optional[int],  # âŒ å®šä¹‰ä¸º int ç±»å‹
        Field(description='Maximum number of events to return (1-50, default: 10)'),
    ] = None,
    # ... å…¶ä»–å‚æ•° ...
) -> Dict[str, Any]:
```

**å…³é”®ç‚¹**:
- å‚æ•°ç±»å‹: `Optional[int]`
- æœŸæœ›æ¥æ”¶ Python åŸç”Ÿç±»å‹ï¼ˆæ•´æ•°ï¼‰
- **Pydantic ä¼šè‡ªåŠ¨éªŒè¯å¹¶æ‹’ç»å­—ç¬¦ä¸²è¾“å…¥**

---

#### RISP MCP Server (`handlers/sp_handler.py`)

```python
async def get_savings_plans_coverage(
    ctx: Context,
    start_date: Annotated[str, Field(description="Start date in YYYY-MM-DD format")],
    end_date: Annotated[str, Field(description="End date in YYYY-MM-DD format")],
    # ... å…¶ä»–å‚æ•° ...
    filter_expression: Annotated[
        Optional[dict],  # âŒ å®šä¹‰ä¸º dict ç±»å‹
        Field(
            description="Filter expression for Cost Explorer API. "
            "Supported dimensions: LINKED_ACCOUNT, REGION, SERVICE, INSTANCE_FAMILY"
        ),
    ] = None,
    # ... å…¶ä»–å‚æ•° ...
) -> dict[str, Any]:
```

**å…³é”®ç‚¹**:
- å‚æ•°ç±»å‹: `Optional[dict]`
- æœŸæœ›æ¥æ”¶ Python åŸç”Ÿç±»å‹ï¼ˆå­—å…¸å¯¹è±¡ï¼‰
- **Pydantic ä¼šè‡ªåŠ¨éªŒè¯å¹¶æ‹’ç» JSON å­—ç¬¦ä¸²**

---

#### Billing-Cost-Management MCP Server (`tools/cost_explorer_tools.py`)

```python
@cost_explorer_server.tool(
    name='cost-explorer',
    description="""...""",
)
async def cost_explorer(
    ctx: Context,
    target_account_id: Optional[str] = None,
    operation: str = None,
    start_date: Optional[str] = None,
    end_date: Optional[str] = None,
    granularity: str = 'DAILY',
    metrics: Optional[str] = None,  # âœ… å®šä¹‰ä¸º str ç±»å‹
    group_by: Optional[str] = None,  # âœ… å®šä¹‰ä¸º str ç±»å‹
    filter: Optional[str] = None,  # âœ… å®šä¹‰ä¸º str ç±»å‹
    # ... å…¶ä»–å‚æ•° ...
) -> Dict[str, Any]:
```

**å…³é”®ç‚¹**:
- å‚æ•°ç±»å‹: `Optional[str]`
- **æ¥æ”¶ JSON åºåˆ—åŒ–çš„å­—ç¬¦ä¸²**ï¼ˆä¾‹å¦‚ `"[\"UnblendedCost\"]"` æˆ– `"{\"Dimensions\": ...}"`ï¼‰
- åœ¨å‡½æ•°å†…éƒ¨æ‰‹åŠ¨ååºåˆ—åŒ–ï¼š

```python
# åœ¨ cost_explorer_operations.py ä¸­
async def get_cost_and_usage(
    ctx: Context,
    ce_client,
    start_date: Optional[str],
    end_date: Optional[str],
    granularity: str,
    metrics: Optional[str],  # æ¥æ”¶å­—ç¬¦ä¸²
    group_by: Optional[str],  # æ¥æ”¶å­—ç¬¦ä¸²
    filter: Optional[str],  # æ¥æ”¶å­—ç¬¦ä¸²
    next_token: Optional[str] = None,
    max_pages: Optional[int] = None,
) -> Dict[str, Any]:
    # æ‰‹åŠ¨è§£æ JSON å­—ç¬¦ä¸²
    if metrics:
        metrics_list = json.loads(metrics)  # âœ… æ‰‹åŠ¨ååºåˆ—åŒ–
    else:
        metrics_list = ['UnblendedCost']

    if group_by:
        group_by_list = json.loads(group_by)  # âœ… æ‰‹åŠ¨ååºåˆ—åŒ–

    if filter:
        filter_dict = json.loads(filter)  # âœ… æ‰‹åŠ¨ååºåˆ—åŒ–
```

---

### 2ï¸âƒ£ **MCP Schema ç”Ÿæˆå·®å¼‚**

#### CloudTrail / RISP (ä½¿ç”¨ Python åŸç”Ÿç±»å‹)

**ç”Ÿæˆçš„ MCP Schema**:
```json
{
  "name": "lookup_events",
  "inputSchema": {
    "type": "object",
    "properties": {
      "max_results": {
        "type": "integer",  // âŒ Schema æœŸæœ›æ•´æ•°
        "description": "Maximum number of events to return"
      },
      "filter_expression": {
        "type": "object",  // âŒ Schema æœŸæœ›å¯¹è±¡
        "description": "Filter expression"
      }
    }
  }
}
```

**é—®é¢˜**:
- AgentCore Gateway ä¼šä¸¥æ ¼éªŒè¯å‚æ•°ç±»å‹
- å¦‚æœ LLM ç”Ÿæˆå­—ç¬¦ä¸²ï¼ˆå¦‚ `"50"`ï¼‰ï¼Œä¼šè¢«æ‹’ç»
- å¦‚æœ LLM ç”Ÿæˆå­—ç¬¦ä¸²ï¼ˆå¦‚ `"{\"Dimensions\": ...}"`ï¼‰ï¼Œä¼šè¢«æ‹’ç»

---

#### Billing-Cost-Management (ä½¿ç”¨å­—ç¬¦ä¸²ç±»å‹)

**ç”Ÿæˆçš„ MCP Schema**:
```json
{
  "name": "cost_explorer",
  "inputSchema": {
    "type": "object",
    "properties": {
      "metrics": {
        "type": "string",  // âœ… Schema æœŸæœ›å­—ç¬¦ä¸²
        "description": "Metrics to include (JSON array string)"
      },
      "filter": {
        "type": "string",  // âœ… Schema æœŸæœ›å­—ç¬¦ä¸²
        "description": "Filter expression (JSON object string)"
      }
    }
  }
}
```

**ä¼˜åŠ¿**:
- **å…¼å®¹æ€§å¼º**: æ— è®º LLM å¦‚ä½•åºåˆ—åŒ–å‚æ•°ï¼Œéƒ½ä¼šè¢«æ¥å—ä¸ºå­—ç¬¦ä¸²
- **çµæ´»æ€§é«˜**: å¯ä»¥æ‰‹åŠ¨æ§åˆ¶ååºåˆ—åŒ–é€»è¾‘
- **é¿å…ç±»å‹é”™è¯¯**: ä¸ä¼šå› ä¸º LLM çš„åºåˆ—åŒ–æ–¹å¼è€Œå¤±è´¥

---

### 3ï¸âƒ£ **AgentCore Gateway çš„è¡Œä¸º**

æ ¹æ®é”™è¯¯ä¿¡æ¯ `string found, object expected`ï¼Œæˆ‘ä»¬å¯ä»¥æ¨æ–­ï¼š

1. **LLM ç”Ÿæˆçš„å‚æ•°**ï¼ˆBedrock Agentï¼‰:
   ```json
   {
     "max_results": "50",  // LLM å¯èƒ½å€¾å‘äºç”Ÿæˆå­—ç¬¦ä¸²
     "filter_expression": "{\"Dimensions\": {\"Key\": \"SERVICE\", \"Values\": [\"RDS\"]}}"  // JSON åºåˆ—åŒ–å­—ç¬¦ä¸²
   }
   ```

2. **AgentCore Gateway éªŒè¯**:
   - è¯»å– MCP Schemaï¼ŒæœŸæœ› `max_results: integer` å’Œ `filter_expression: object`
   - å‘ç°å®é™…ç±»å‹æ˜¯ `string`
   - **æ‹’ç»è¯·æ±‚ï¼Œè¿”å› `JsonSchemaException`**

3. **Billing MCP æ­£å¸¸çš„åŸå› **:
   - Schema æœŸæœ› `metrics: string` å’Œ `filter: string`
   - LLM ç”Ÿæˆçš„å‚æ•°æ°å¥½æ˜¯å­—ç¬¦ä¸²
   - **éªŒè¯é€šè¿‡ï¼Œå‚æ•°è¢«æ­£ç¡®ä¼ é€’**

---

## ğŸ¯ ç»“è®º

### æ ¸å¿ƒé—®é¢˜

**CloudTrail å’Œ RISP MCP Server çš„å‚æ•°å®šä¹‰ä½¿ç”¨äº† Python åŸç”Ÿå¤æ‚ç±»å‹ï¼ˆ`int`, `dict`, `list`ï¼‰ï¼Œå¯¼è‡´ï¼š**

1. âœ… **Schema æ­£ç¡®æ€§**: MCP Schema å‡†ç¡®åæ˜ äº† Python ç±»å‹ï¼ˆ`integer`, `object`, `array`ï¼‰
2. âŒ **LLM å…¼å®¹æ€§å·®**: Bedrock Agent å€¾å‘äºå°†å¤æ‚å‚æ•°åºåˆ—åŒ–ä¸º JSON å­—ç¬¦ä¸²
3. âŒ **Gateway ä¸¥æ ¼éªŒè¯**: AgentCore Gateway ä¸¥æ ¼éªŒè¯ç±»å‹ï¼Œæ‹’ç»å­—ç¬¦ä¸²è¾“å…¥
4. âŒ **ç”¨æˆ·ä½“éªŒå·®**: å³ä½¿å‚æ•°å€¼æ­£ç¡®ï¼Œä¹Ÿä¼šå› ç±»å‹ä¸åŒ¹é…è€Œå¤±è´¥

### Billing MCP Server æˆåŠŸçš„åŸå› 

**æ‰€æœ‰å¤æ‚å‚æ•°éƒ½å®šä¹‰ä¸ºå­—ç¬¦ä¸²ç±»å‹ï¼ˆ`str`ï¼‰ï¼Œç„¶ååœ¨å†…éƒ¨æ‰‹åŠ¨ååºåˆ—åŒ–ï¼š**

1. âœ… **Schema å…¼å®¹æ€§å¼º**: Schema æœŸæœ›å­—ç¬¦ä¸²ï¼ŒLLM è‡ªç„¶ç”Ÿæˆå­—ç¬¦ä¸²
2. âœ… **Gateway éªŒè¯é€šè¿‡**: å­—ç¬¦ä¸²å‚æ•°ç¬¦åˆ Schema å®šä¹‰
3. âœ… **çµæ´»æ€§é«˜**: å†…éƒ¨å¯ä»¥å¤„ç†å„ç§ JSON æ ¼å¼ï¼ˆå¸¦å¼•å·ã€ä¸å¸¦å¼•å·ã€è½¬ä¹‰ç­‰ï¼‰
4. âœ… **ç”¨æˆ·ä½“éªŒå¥½**: å‚æ•°ä¼ é€’æˆåŠŸï¼ŒåŠŸèƒ½æ­£å¸¸

---

## ğŸ’¡ ä¿®å¤å»ºè®®

### æ–¹æ¡ˆ 1: ä¿®æ”¹å‚æ•°ç±»å‹ä¸ºå­—ç¬¦ä¸²ï¼ˆæ¨èï¼‰â­

**ä¿®æ”¹ CloudTrail MCP Server**:

```python
# tools.py
async def lookup_events(
    self,
    ctx: Context,
    # ... å…¶ä»–å‚æ•° ...
    max_results: Annotated[
        Optional[str],  # âœ… æ”¹ä¸º str
        Field(description='Maximum number of events to return (1-50, default: 10)'),
    ] = None,
    # ... å…¶ä»–å‚æ•° ...
) -> Dict[str, Any]:
    # æ·»åŠ ç±»å‹è½¬æ¢é€»è¾‘
    if max_results:
        max_results = int(max_results)  # âœ… æ‰‹åŠ¨è½¬æ¢
    max_results = validate_max_results(max_results, default=10, max_allowed=50)
```

**ä¿®æ”¹ RISP MCP Server**:

```python
# handlers/sp_handler.py
async def get_savings_plans_coverage(
    ctx: Context,
    start_date: Annotated[str, Field(description="Start date in YYYY-MM-DD format")],
    end_date: Annotated[str, Field(description="End date in YYYY-MM-DD format")],
    # ... å…¶ä»–å‚æ•° ...
    filter_expression: Annotated[
        Optional[str],  # âœ… æ”¹ä¸º str
        Field(
            description="Filter expression for Cost Explorer API (JSON string). "
            "Example: '{\"Dimensions\": {\"Key\": \"SERVICE\", \"Values\": [\"EC2\"]}}'"
        ),
    ] = None,
    # ... å…¶ä»–å‚æ•° ...
) -> dict[str, Any]:
    # æ·»åŠ  JSON è§£æé€»è¾‘
    if filter_expression:
        import json
        filter_expression = json.loads(filter_expression)  # âœ… æ‰‹åŠ¨ååºåˆ—åŒ–
```

**ä¼˜ç‚¹**:
- âœ… å®Œå…¨å…¼å®¹ LLM è¡Œä¸ºï¼ˆæ— è®ºå¦‚ä½•åºåˆ—åŒ–éƒ½èƒ½æ¥å—ï¼‰
- âœ… ä¸ Billing MCP Server ä¿æŒä¸€è‡´
- âœ… ä¿®å¤ç®€å•ï¼Œé£é™©ä½

**ç¼ºç‚¹**:
- âš ï¸ éœ€è¦æ‰‹åŠ¨éªŒè¯å’Œè½¬æ¢ç±»å‹
- âš ï¸ Schema å¯èƒ½ä¸å¦‚åŸç”Ÿç±»å‹ç›´è§‚

---

### æ–¹æ¡ˆ 2: åœ¨ AgentCore Gateway å±‚è½¬æ¢ï¼ˆéœ€è¦ AWS ä¿®å¤ï¼‰

**æœŸæœ›è¡Œä¸º**:
- Gateway è‡ªåŠ¨å°†å­—ç¬¦ä¸²å‚æ•°è½¬æ¢ä¸ºç›®æ ‡ç±»å‹
- ä¾‹å¦‚: `"50"` â†’ `50`, `"{\"key\": \"value\"}"` â†’ `{"key": "value"}`

**ä¼˜ç‚¹**:
- âœ… æ— éœ€ä¿®æ”¹ MCP Server ä»£ç 
- âœ… Schema ä¿æŒè¯­ä¹‰å‡†ç¡®

**ç¼ºç‚¹**:
- âŒ éœ€è¦ AWS ä¿®å¤ AgentCore Gateway
- âŒ çŸ­æœŸå†…æ— æ³•å®æ–½

---

### æ–¹æ¡ˆ 3: ä¿®æ”¹ LLM Promptï¼ˆä¸å¯é ï¼‰

**è°ƒæ•´ Bedrock Agent çš„æç¤ºè¯**:
```
When calling MCP tools, ensure all parameters match their expected types:
- Integer parameters: send as numbers (50, not "50")
- Object parameters: send as objects ({"key": "value"}, not '{"key": "value"}')
```

**ä¼˜ç‚¹**:
- âœ… æ— éœ€ä¿®æ”¹ä»£ç 

**ç¼ºç‚¹**:
- âŒ LLM è¡Œä¸ºä¸å¯æ§ï¼Œå¯èƒ½ä»ç„¶ç”Ÿæˆå­—ç¬¦ä¸²
- âŒ ä¸æ˜¯å¯é çš„è§£å†³æ–¹æ¡ˆ

---

## ğŸ“‹ å®æ–½è®¡åˆ’

### ç«‹å³æ‰§è¡Œï¼ˆæ–¹æ¡ˆ 1ï¼‰

1. **ä¿®æ”¹ CloudTrail MCP Server**:
   - [ ] å°† `max_results: Optional[int]` æ”¹ä¸º `Optional[str]`
   - [ ] åœ¨å‡½æ•°å†…éƒ¨æ·»åŠ  `int(max_results)` è½¬æ¢
   - [ ] æ›´æ–° description è¯´æ˜å‚æ•°æ ¼å¼

2. **ä¿®æ”¹ RISP MCP Server**:
   - [ ] å°†æ‰€æœ‰å¤æ‚ç±»å‹å‚æ•°ï¼ˆ`dict`, `list`ï¼‰æ”¹ä¸º `str`
   - [ ] æ·»åŠ  `json.loads()` ååºåˆ—åŒ–é€»è¾‘
   - [ ] æ›´æ–° description æä¾› JSON ç¤ºä¾‹

3. **æµ‹è¯•éªŒè¯**:
   - [ ] æµ‹è¯• CloudTrail `lookup_events` å·¥å…·
   - [ ] æµ‹è¯• RISP æ‰€æœ‰ Savings Plans å·¥å…·
   - [ ] ç¡®è®¤å‚æ•°ä¼ é€’æ­£ç¡®

4. **æ–‡æ¡£æ›´æ–°**:
   - [ ] æ›´æ–°å·¥å…· description è¯´æ˜å‚æ•°æ ¼å¼
   - [ ] æä¾› JSON å­—ç¬¦ä¸²ç¤ºä¾‹
   - [ ] æ·»åŠ å‚æ•°æ ¼å¼éªŒè¯è¯´æ˜

### é•¿æœŸæ”¹è¿›

1. **å»ºç«‹ç¼–ç è§„èŒƒ**:
   - æ‰€æœ‰ MCP Server ç»Ÿä¸€ä½¿ç”¨å­—ç¬¦ä¸²ç±»å‹ä¼ é€’å¤æ‚å‚æ•°
   - åœ¨å†…éƒ¨æ‰‹åŠ¨ååºåˆ—åŒ–å’ŒéªŒè¯
   - æä¾›æ¸…æ™°çš„ JSON ç¤ºä¾‹

2. **åˆ›å»ºå·¥å…·å‡½æ•°**:
   ```python
   def parse_json_param(param: Optional[str], param_name: str) -> Optional[dict]:
       """ç»Ÿä¸€çš„ JSON å‚æ•°è§£æå‡½æ•°"""
       if not param:
           return None
       try:
           return json.loads(param)
       except json.JSONDecodeError as e:
           raise ValueError(f"Invalid JSON format for {param_name}: {e}")
   ```

3. **æ·»åŠ åˆ°å¼€å‘æ£€æŸ¥æ¸…å•**:
   - âœ… å¤æ‚å‚æ•°ä½¿ç”¨ `str` ç±»å‹å®šä¹‰
   - âœ… æä¾› JSON ç¤ºä¾‹
   - âœ… æ·»åŠ ååºåˆ—åŒ–é€»è¾‘
   - âœ… éªŒè¯å‚æ•°æ ¼å¼

---

## ğŸ”— ç›¸å…³æ–‡ä»¶

- CloudTrail MCP Server: `/src/cloudtrail-mcp-server/awslabs/cloudtrail_mcp_server/tools.py`
- RISP MCP Server: `/src/costq-risp-mcp-server/handlers/sp_handler.py`
- Billing MCP Server: `/src/billing-cost-management-mcp-server/awslabs/billing_cost_management_mcp_server/tools/cost_explorer_tools.py`
- æ£€æŸ¥æ¸…å•: `/costq/docs/20260117_MCPå¤šè´¦å·æ”¹é€ åˆ†æ/05_MCP_SERVER_å¼€å‘æ£€æŸ¥æ¸…å•.md`

---

## ğŸ“ é™„å½•: å‚æ•°ç±»å‹å¯¹æ¯”è¡¨

| MCP Server | å‚æ•°å | åŸå§‹ç±»å‹ | åº”æ”¹ä¸º | è¯´æ˜ |
|-----------|--------|---------|--------|------|
| CloudTrail | `max_results` | `Optional[int]` | `Optional[str]` | éœ€è½¬æ¢ä¸ºæ•´æ•° |
| CloudTrail | `attribute_value` | `Optional[str]` | `Optional[str]` | âœ… å·²æ­£ç¡® |
| RISP | `filter_expression` | `Optional[dict]` | `Optional[str]` | éœ€ JSON ååºåˆ—åŒ– |
| RISP | `group_by` | `Optional[list[str]]` | `Optional[str]` | éœ€ JSON ååºåˆ—åŒ– |
| RISP | `max_results` | `Optional[int]` | `Optional[str]` | éœ€è½¬æ¢ä¸ºæ•´æ•° |
| Billing | `metrics` | `Optional[str]` | `Optional[str]` | âœ… å·²æ­£ç¡® |
| Billing | `filter` | `Optional[str]` | `Optional[str]` | âœ… å·²æ­£ç¡® |
| Billing | `group_by` | `Optional[str]` | `Optional[str]` | âœ… å·²æ­£ç¡® |

---

**åˆ†æå®Œæˆæ—¶é—´**: 2026-01-20 14:30
**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**: å®æ–½æ–¹æ¡ˆ 1ï¼Œä¿®æ”¹å‚æ•°ç±»å‹å®šä¹‰
