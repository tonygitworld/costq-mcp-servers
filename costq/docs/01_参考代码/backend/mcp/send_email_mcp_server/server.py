"""Send Email MCP Server - é‚®ä»¶å‘é€æœåŠ¡

ä¸“æ³¨äºé‚®ä»¶å‘é€åŠŸèƒ½ï¼Œä½¿ç”¨ AWS SESï¼ˆSimple Email Serviceï¼‰ã€‚

è®¾è®¡ç†å¿µï¼š
    - å•ä¸€èŒè´£ï¼šåªè´Ÿè´£é‚®ä»¶å‘é€
    - é€šç”¨æ€§å¼ºï¼šä»»ä½•åœºæ™¯éƒ½å¯ä½¿ç”¨ï¼ˆå‘Šè­¦ã€é€šçŸ¥ã€éªŒè¯ç ç­‰ï¼‰
    - æ— çŠ¶æ€è®¾è®¡ï¼šä¸ä¾èµ–æ•°æ®åº“ï¼Œæ¯æ¬¡è°ƒç”¨ç‹¬ç«‹
    - ç®€å•çº¯ç²¹ï¼šå‚æ•°ç®€æ´ï¼ŒåŠŸèƒ½ä¸“æ³¨
"""

import logging
import os
import sys

logger = logging.getLogger(__name__)
from mcp.server.fastmcp import FastMCP

from .handlers.email_handler import send_email

# é…ç½®æ—¥å¿—

# Server è¯´æ˜æ–‡æ¡£
SERVER_INSTRUCTIONS = """
# Send Email MCP Server - é‚®ä»¶å‘é€æœåŠ¡

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

ä¸“æ³¨äºé‚®ä»¶å‘é€ï¼Œä½¿ç”¨ AWS SESï¼ˆSimple Email Serviceï¼‰ã€‚

**ç‰¹æ€§ï¼š**
- âœ… å‘é€ HTML/çº¯æ–‡æœ¬é‚®ä»¶
- âœ… æ”¯æŒå¤šä¸ªæ”¶ä»¶äºº
- âœ… è‡ªåŠ¨é‡è¯•æœºåˆ¶ï¼ˆæœ€å¤š3æ¬¡ï¼‰
- âœ… è¯¦ç»†çš„å‘é€æ—¥å¿—
- âœ… å®Œå–„çš„é”™è¯¯å¤„ç†

## ğŸ”§ å·¥å…·

### send_email - å‘é€é‚®ä»¶

å‘é€é‚®ä»¶åˆ°æŒ‡å®šæ”¶ä»¶äººï¼Œæ”¯æŒ HTML å’Œçº¯æ–‡æœ¬æ ¼å¼ã€‚

**å‚æ•°ï¼š**
- `to_emails` (List[str], å¿…éœ€): æ”¶ä»¶äººé‚®ç®±åˆ—è¡¨
- `subject` (str, å¿…éœ€): é‚®ä»¶ä¸»é¢˜
- `body_html` (str, å¯é€‰): HTMLæ ¼å¼é‚®ä»¶æ­£æ–‡
- `body_text` (str, å¯é€‰): çº¯æ–‡æœ¬æ ¼å¼é‚®ä»¶æ­£æ–‡

**æ³¨æ„ï¼š** `body_html` å’Œ `body_text` è‡³å°‘æä¾›ä¸€ä¸ªã€‚

**è¿”å›å€¼ï¼š**
```json
{
  "success": true,
  "message_id": "010101234567890-abcdef...",
  "to_emails": ["user@example.com"]
}
```

**å¤±è´¥æ—¶è¿”å›ï¼š**
```json
{
  "success": false,
  "error": "é”™è¯¯ä¿¡æ¯",
  "to_emails": ["user@example.com"]
}
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**

1. å‘é€ç®€å•çš„ HTML é‚®ä»¶ï¼š
```json
{
  "to_emails": ["user@example.com"],
  "subject": "æ¬¢è¿ä½¿ç”¨ CostQ",
  "body_html": "<h1>æ¬¢è¿</h1><p>æ„Ÿè°¢æ‚¨ä½¿ç”¨ CostQ æˆæœ¬ç®¡ç†å¹³å°ã€‚</p>"
}
```

2. å‘é€çº¯æ–‡æœ¬é‚®ä»¶ï¼š
```json
{
  "to_emails": ["user@example.com"],
  "subject": "å¯†ç é‡ç½®",
  "body_text": "æ‚¨çš„å¯†ç é‡ç½®éªŒè¯ç æ˜¯ï¼š123456"
}
```

3. åŒæ—¶å‘é€ HTML å’Œçº¯æ–‡æœ¬ï¼ˆæ¨èï¼‰ï¼š
```json
{
  "to_emails": ["user@example.com", "admin@example.com"],
  "subject": "AWS æˆæœ¬å‘Šè­¦",
  "body_html": "<h2>æˆæœ¬å‘Šè­¦</h2><p>æ‚¨çš„ AWS æˆæœ¬å·²è¶…è¿‡é¢„ç®—ã€‚</p>",
  "body_text": "æˆæœ¬å‘Šè­¦\\n\\næ‚¨çš„ AWS æˆæœ¬å·²è¶…è¿‡é¢„ç®—ã€‚"
}
```

## ğŸ“ é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡

- `SES_REGION`: SES æœåŠ¡åŒºåŸŸï¼ˆé»˜è®¤ï¼šap-northeast-1ï¼‰
- `SES_SENDER_EMAIL`: å‘ä»¶äººé‚®ç®±ï¼ˆé»˜è®¤ï¼šno_reply@costq-mail.cloudminos.jpï¼‰
- `SES_CONFIGURATION_SET`: SES é…ç½®é›†ï¼ˆå¯é€‰ï¼‰
- `LOG_LEVEL`: æ—¥å¿—çº§åˆ«ï¼ˆé»˜è®¤ï¼šWARNINGï¼‰

### AWS æƒé™è¦æ±‚

éœ€è¦ä»¥ä¸‹ SES æƒé™ï¼š
- `ses:SendEmail`
- `ses:SendRawEmail`

**æƒé™æ¥æºï¼š**
- æœ¬åœ°å¼€å‘ï¼šä½¿ç”¨ `AWS_PROFILE` ç¯å¢ƒå˜é‡
- ç”Ÿäº§ç¯å¢ƒï¼šä½¿ç”¨ IAM Roleï¼ˆEKS Pod ServiceAccountï¼‰

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å‘ä»¶äººé‚®ç®±**
   - é»˜è®¤å‘ä»¶äººï¼šno_reply@costq-mail.cloudminos.jp
   - å‘ä»¶äººé‚®ç®±å¿…é¡»åœ¨ SES ä¸­éªŒè¯

2. **æ²™ç›’æ¨¡å¼**
   - æ–° AWS è´¦å·é»˜è®¤å¤„äºæ²™ç›’æ¨¡å¼
   - æ²™ç›’æ¨¡å¼ä¸‹ï¼Œæ”¶ä»¶äººé‚®ç®±ä¹Ÿéœ€è¦éªŒè¯
   - ç”Ÿäº§ç¯å¢ƒéœ€è¦ç”³è¯·ç§»å‡ºæ²™ç›’

3. **å‘é€é™åˆ¶**
   - AWS SES æœ‰å‘é€é€Ÿç‡é™åˆ¶
   - é»˜è®¤é™åˆ¶ï¼š1 å°/ç§’ï¼Œ200 å°/å¤©
   - å¯ä»¥ç”³è¯·æé«˜é™åˆ¶

4. **é‡è¯•æœºåˆ¶**
   - è‡ªåŠ¨é‡è¯•æœ€å¤š 3 æ¬¡
   - æŸäº›é”™è¯¯ä¸ä¼šé‡è¯•ï¼ˆå¦‚é‚®ç®±æœªéªŒè¯ï¼‰

5. **é‚®ä»¶æ ¼å¼**
   - æ¨èåŒæ—¶æä¾› HTML å’Œçº¯æ–‡æœ¬
   - HTML é‚®ä»¶éœ€è¦ä½¿ç”¨å†…è” CSS
   - é¿å…ä½¿ç”¨å¤–éƒ¨å›¾ç‰‡ï¼ˆå¯èƒ½è¢«è¿‡æ»¤ï¼‰

## ğŸ”— ç›¸å…³ MCP

- **Alert MCP**: å‘Šè­¦ç®¡ç†æœåŠ¡ï¼ˆå‘Šè­¦è§¦å‘åè°ƒç”¨æœ¬æœåŠ¡å‘é€é‚®ä»¶ï¼‰
- **å…¶ä»–æœåŠ¡**: ä»»ä½•éœ€è¦å‘é€é‚®ä»¶çš„æœåŠ¡éƒ½å¯ä»¥ä½¿ç”¨

## ğŸ’¡ æœ€ä½³å®è·µ

1. **é‚®ä»¶ä¸»é¢˜**
   - ç®€æ´æ˜ç¡®
   - åŒ…å«å…³é”®ä¿¡æ¯
   - ç¤ºä¾‹ï¼š"AWS æˆæœ¬å‘Šè­¦ - è¶…å‡ºé¢„ç®— 50%"

2. **é‚®ä»¶å†…å®¹**
   - æä¾› HTML å’Œçº¯æ–‡æœ¬ä¸¤ä¸ªç‰ˆæœ¬
   - HTML ä½¿ç”¨ç®€å•æ¸…æ™°çš„ç»“æ„
   - åŒ…å«å¿…è¦çš„ä¿¡æ¯å’Œè¡ŒåŠ¨å»ºè®®

3. **æ”¶ä»¶äººç®¡ç†**
   - éªŒè¯é‚®ç®±æ ¼å¼
   - é¿å…å‘é€åˆ°æ— æ•ˆé‚®ç®±
   - æ‰¹é‡å‘é€æ—¶æ³¨æ„é€Ÿç‡é™åˆ¶

4. **é”™è¯¯å¤„ç†**
   - æ£€æŸ¥è¿”å›çš„ success çŠ¶æ€
   - è®°å½•å¤±è´¥åŸå› 
   - å¯¹äºé‡è¦é‚®ä»¶ï¼Œå®ç°è¡¥å¿æœºåˆ¶
"""

# åˆå§‹åŒ– FastMCP
mcp = FastMCP("send-email", instructions=SERVER_INSTRUCTIONS)


@mcp.tool()
async def send_email_tool(
    to_emails: list[str], subject: str, body_html: str = "", body_text: str = ""
) -> dict:
    """å‘é€é‚®ä»¶

    Args:
        to_emails: æ”¶ä»¶äººé‚®ç®±åˆ—è¡¨
        subject: é‚®ä»¶ä¸»é¢˜
        body_html: HTMLé‚®ä»¶æ­£æ–‡ï¼ˆå¯é€‰ï¼‰
        body_text: çº¯æ–‡æœ¬é‚®ä»¶æ­£æ–‡ï¼ˆå¯é€‰ï¼‰

    Returns:
        dict: å‘é€ç»“æœ
        {
            'success': True/False,
            'message_id': 'ses-message-id',
            'to_emails': ['user@example.com'],
            'error': 'error message'  # å¤±è´¥æ—¶è¿”å›
        }
    """
    return await send_email(
        to_emails=to_emails, subject=subject, body_html=body_html, body_text=body_text
    )


if __name__ == "__main__":
    mcp.run()
