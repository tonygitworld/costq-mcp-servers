AWSTemplateFormatVersion: '2010-09-09'
Description: >
  CostQ - IAM Role é›†æˆæ¨¡æ¿

  æ­¤æ¨¡æ¿ä¸º CostQ å¹³å°åˆ›å»ºä¸€ä¸ª IAM Roleï¼Œå…è®¸å¹³å°ä½¿ç”¨ä¸´æ—¶å‡­è¯è®¿é—®æ‚¨çš„ AWS è´¦å·ã€‚

  æƒé™è¯´æ˜ï¼š
  1. ReadOnlyAccessï¼ˆAWS Managedç­–ç•¥ï¼‰- æ‰€æœ‰ AWS æœåŠ¡çš„åªè¯»æƒé™
  2. refresh-sp-recommendationsï¼ˆCustomç­–ç•¥ï¼‰- å¯åŠ¨ Savings Plans recommendation generation

  å®‰å…¨ç‰¹æ€§ï¼š
  - ä¸´æ—¶å‡­è¯ï¼ˆ15åˆ†é’Ÿ-12å°æ—¶è‡ªåŠ¨è¿‡æœŸï¼‰
  - External IDï¼ˆé˜²æ­¢æ··æ·†ä»£ç†äººæ”»å‡»ï¼‰
  - æœ€å°æƒé™åŸåˆ™ï¼ˆåªè¯» + å•ä¸€å†™æ“ä½œï¼‰

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "CostQ å¹³å°é…ç½®"
        Parameters:
          - CostQPlatformAccountId
          - ExternalId
      - Label:
          default: "è§’è‰²é…ç½®"
        Parameters:
          - RoleName
          - SessionDuration
    ParameterLabels:
      CostQPlatformAccountId:
        default: "CostQ å¹³å° AWS è´¦å· ID"
      ExternalId:
        default: "External IDï¼ˆå®‰å…¨å¯†é’¥ï¼‰"
      RoleName:
        default: "IAM Role name"
      SessionDuration:
        default: "ä¼šè¯æ—¶é•¿ï¼ˆç§’ï¼‰"

Parameters:
  CostQPlatformAccountId:
    Type: String
    Description: "CostQ å¹³å°çš„ AWS è´¦å· IDï¼ˆç”± CostQ æä¾›ï¼Œè¯·å‹¿ä¿®æ”¹ï¼‰"
    AllowedPattern: '^\d{12}$'
    ConstraintDescription: "å¿…é¡»æ˜¯ 12 ä½æ•°å­—"
    Default: "000451883532"  # ğŸ”§ TODO: æ›¿æ¢ä¸ºå®é™…å¹³å°è´¦å· ID

  ExternalId:
    Type: String
    Description: "External IDï¼ˆç”± CostQ å¹³å°è‡ªåŠ¨ç”Ÿæˆï¼Œè¯·å‹¿ä¿®æ”¹ï¼‰"
    MinLength: 16
    MaxLength: 128
    NoEcho: false  # ä¸éœ€è¦éšè—ï¼ŒExternal ID ä¸æ˜¯å¯†é’¥
    Default: "REPLACE_WITH_YOUR_EXTERNAL_ID"  # ğŸ”§ ç”±å‰ç«¯è‡ªåŠ¨å¡«å……

  RoleName:
    Type: String
    Description: "IAM Role çš„åç§°ï¼ˆå»ºè®®ä¿æŒé»˜è®¤ï¼‰"
    Default: "CostQRole"
    AllowedPattern: '^[\w+=,.@-]{1,64}$'
    ConstraintDescription: "è§’è‰²åç§°åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œ +=,.@- å­—ç¬¦ï¼Œé•¿åº¦ 1-64"

  SessionDuration:
    Type: Number
    Description: "Temporary credential validity periodï¼ˆç§’ï¼‰ï¼ŒèŒƒå›´ 900-43200"
    Default: 3600
    MinValue: 900
    MaxValue: 43200

Resources:
  # Customç­–ç•¥ï¼šSavings Plans recommendation generation
  RefreshSPRecommendationsPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: !Sub "${RoleName}-RefreshSPRecommendations"
      Description: "å…è®¸ CostQ å¯åŠ¨ Savings Plans è´­ä¹°recommendation generationä»»åŠ¡"
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowSavingsPlansRecommendationGeneration
            Effect: Allow
            Action:
              - ce:StartSavingsPlansPurchaseRecommendationGeneration
            Resource: '*'
            # è¯´æ˜ï¼š
            # - æ­¤æ“ä½œä¸ä¼šè‡ªåŠ¨è´­ä¹° Savings Plans
            # - ä»…ç”Ÿæˆæ¨èæŠ¥å‘Šï¼Œæœ€ç»ˆè´­ä¹°å†³ç­–ç”±æ‚¨æ§åˆ¶
            # - æ¨èæŠ¥å‘Šå¸®åŠ©æ‚¨ä¼˜åŒ–æˆæœ¬

  # IAM Roleï¼šä¿¡ä»» CostQ å¹³å°è´¦å·
  CostQIAMRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Ref RoleName
      Description: "CostQ integration role - ReadOnlyAccess + SP recommendations"
      MaxSessionDuration: !Ref SessionDuration
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowCostQPlatformAssumeRole
            Effect: Allow
            Principal:
              AWS: !Sub "arn:aws:iam::${CostQPlatformAccountId}:root"
            Action: sts:AssumeRole
            Condition:
              StringEquals:
                sts:ExternalId: !Ref ExternalId
      ManagedPolicyArns:
        # AWS Managedç­–ç•¥ï¼šæ‰€æœ‰æœåŠ¡åªè¯»æƒé™
        - arn:aws:iam::aws:policy/ReadOnlyAccess
        # Customç­–ç•¥ï¼šSP recommendation generation
        - !Ref RefreshSPRecommendationsPolicy
      Tags:
        - Key: Purpose
          Value: CostQIntegration
        - Key: Platform
          Value: CostQ
        - Key: ManagedBy
          Value: CloudFormation
        - Key: StackName
          Value: !Ref AWS::StackName

Outputs:
  RoleArn:
    Description: |
      âœ… å¤åˆ¶æ­¤ ARN å¹¶ç²˜è´´åˆ° CostQ å¹³å°

      æ­¥éª¤ï¼š
      1. å¤åˆ¶ä¸‹æ–¹çš„ Role ARN
      2. Return to CostQ platform
      3. ç²˜è´´åˆ°"Role ARN"è¾“å…¥æ¡†
      4. ç‚¹å‡»"éªŒè¯å¹¶æ·»åŠ "
    Value: !GetAtt CostQIAMRole.Arn
    Export:
      Name: !Sub "${AWS::StackName}-RoleArn"

  RoleName:
    Description: "IAM Role name"
    Value: !Ref RoleName

  ExternalId:
    Description: "External ID (configured for security verification)"
    Value: !Ref ExternalId

  TrustedPrincipal:
    Description: "Trusted AWS account (CostQ Platform)"
    Value: !Sub "arn:aws:iam::${CostQPlatformAccountId}:root"

  SessionDuration:
    Description: "Temporary credential validity period"
    Value: !Sub "${SessionDuration} seconds (${SessionDuration} / 3600 = ${SessionDuration} / 3600 hours)"

  AttachedPolicies:
    Description: "Attached policies"
    Value: "ReadOnlyAccessï¼ˆAWS Managedï¼‰+ refresh-sp-recommendationsï¼ˆCustomï¼‰"

  QuickLaunchURL:
    Description: |
      One-click deployment link (shareable)

      âš ï¸ WARNING: Replace External ID before sharing
    Value: !Sub |
      https://console.aws.amazon.com/cloudformation/home?region=${AWS::Region}#/stacks/create/review?templateURL=https://costq-storage.s3.amazonaws.com/cloudformation/costq-iam-role.yaml&stackName=${RoleName}&param_CostQPlatformAccountId=${CostQPlatformAccountId}&param_ExternalId=${ExternalId}&param_RoleName=${RoleName}

  NextSteps:
    Description: "Next steps"
    Value: |
      1. Copy the RoleArn above
      2. Return to CostQ platform
      3. Select IAM Role method in Add AWS Account dialog
      4. Paste Role ARN and complete configuration
      5. Start using cost analysis features

  SecurityNote:
    Description: "Security information"
    Value: |
      âœ… æ­¤ Role ä½¿ç”¨ä¸´æ—¶å‡­è¯ï¼ˆè‡ªåŠ¨è¿‡æœŸï¼Œé»˜è®¤ 1 hours)
      âœ… External ID prevents unauthorized access
      âœ… Read-only permissions + SP recommendations only (no auto-purchase)
      âœ… Complies with AWS security best practices

      To revoke access, delete this CloudFormation Stack.

  SupportedFeatures:
    Description: "Supported features"
    Value: |
      âœ… Cost analysisï¼ˆCost Explorerã€Cost Optimization Hubï¼‰
      âœ… Resource inventoryï¼ˆEC2ã€RDSã€S3 all servicesï¼‰
      âœ… Audit queriesï¼ˆCloudTrail events and Lake analysisï¼‰
      âœ… RI/SP utilization and coverage analysis
      âœ… Savings Plans recommendation generation
      âœ… Cost optimization recommendationsï¼ˆCompute Optimizerï¼‰
      âœ… Right-sizing recommendationsï¼ˆRight-Sizingï¼‰

      âŒ Unsupported operations:
      - Create/delete/modify any resources (read-only)
      - Auto-purchase RI/SP (requires manual confirmation)

  CostEstimate:
    Description: "Cost estimate"
    Value: |
      Using this Role incurs no additional charges.

      CostQ platform API calls included in AWS Free Tier:
      - STS AssumeRole: Free
      - Cost Explorer API: å‰ 2000 æ¬¡è°ƒç”¨/æœˆFree
      - CloudTrail LookupEvents: å‰ 100,000 æ¬¡/æœˆFree

      è¶…å‡ºFreeé¢åº¦åï¼Œè´¹ç”¨æä½ï¼ˆé€šå¸¸ < $1/æœˆï¼‰ã€‚

  TroubleshootingGuide:
    Description: "Troubleshooting guide"
    Value: |
      Common issues:

      1. "AssumeRole failed: Access Denied"
         â†’ Check if External ID matches
         â†’ Verify CostQ platform account ID is correct

      2. "Permission denied"
         â†’ Confirm ReadOnlyAccess policy is attached
         â†’ Check AWS service quotas

      3. "Session expired"
         â†’ CostQ platform auto-renews, no action needed
         â†’ If frequently expiring, increase SessionDuration parameter

      Need help? Visit CostQ documentation or contact support.

Metadata:
  # æ¨¡æ¿ç‰ˆæœ¬ä¿¡æ¯
  Version: 1.0.0
  LastUpdated: 2025-10-30
  Author: CostQ Team

  # è®¸å¯è¯
  License: MIT

  # å˜æ›´æ—¥å¿—
  ChangeLog: |
    v1.0.0 (2025-10-30):
    - åˆå§‹ç‰ˆæœ¬
    - ä½¿ç”¨ ReadOnlyAccess æ‰˜ç®¡ç­–ç•¥
    - æ·»åŠ  refresh-sp-recommendations Customç­–ç•¥
    - æ”¯æŒ External ID å®‰å…¨éªŒè¯
    - å¯é…ç½®ä¼šè¯æ—¶é•¿
