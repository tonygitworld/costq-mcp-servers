#!/bin/bash
#
# æ„å»º Docker é•œåƒå¹¶æ¨é€åˆ° ECR
#
# ç”¨é€”ï¼šå°† CostQ Agent æ‰“åŒ…æˆ ARM64 é•œåƒå¹¶ä¸Šä¼ åˆ° AWS ECR
#

set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

# =============================================================================
# é…ç½®
# =============================================================================
AWS_PROFILE="3532"
AWS_REGION="ap-northeast-1"
AWS_ACCOUNT="000451883532"
ECR_REPO="costq-agentcore"
IMAGE_TAG="v$(date +%Y%m%d-%H%M%S)"

# è®¡ç®—å®Œæ•´çš„ ECR URI
ECR_URI="${AWS_ACCOUNT}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO}"
FULL_IMAGE="${ECR_URI}:${IMAGE_TAG}"

# =============================================================================
# è¾“å‡ºæ¨ªå¹…
# =============================================================================
echo "============================================================"
echo "ğŸš€ æ„å»ºå¹¶æ¨é€ CostQ Agent é•œåƒ"
echo "============================================================"
echo "ECR ä»“åº“: ${ECR_URI}"
echo "é•œåƒæ ‡ç­¾: latest, ${IMAGE_TAG}"
echo "å¹³å°: linux/arm64"
echo "============================================================"
echo ""

# =============================================================================
# Step 1: ç™»å½• ECR
# =============================================================================
echo "ğŸ” Step 1: ç™»å½• ECR..."
AWS_PROFILE=${AWS_PROFILE} aws ecr get-login-password --region ${AWS_REGION} | \
  docker login --username AWS --password-stdin ${AWS_ACCOUNT}.dkr.ecr.${AWS_REGION}.amazonaws.com

if [ $? -eq 0 ]; then
    echo "âœ… ECR ç™»å½•æˆåŠŸ"
    echo ""
else
    echo "âŒ ECR ç™»å½•å¤±è´¥"
    exit 1
fi

# =============================================================================
# Step 2: æ„å»º ARM64 é•œåƒ
# =============================================================================
echo "ğŸ”¨ Step 2: æ„å»º ARM64 Docker é•œåƒï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰..."
echo "   âš ï¸  é¦–æ¬¡æ„å»ºå¯èƒ½éœ€è¦ 5-10 åˆ†é’Ÿï¼Œåç»­æ„å»ºä¼šæ›´å¿«..."
echo ""

# åˆ‡æ¢åˆ°é¡¹ç›®æ ¹ç›®å½•ï¼ˆagent_runtime.py éœ€è¦ backend æ¨¡å—ï¼‰
cd ../..

docker buildx build \
  --platform linux/arm64 \
  -f deployment/agentcore/Dockerfile \
  -t ${FULL_IMAGE} \
  --load \
  .

if [ $? -eq 0 ]; then
    echo ""
    echo "âœ… é•œåƒæ„å»ºæˆåŠŸ"
    echo ""
else
    echo ""
    echo "âŒ é•œåƒæ„å»ºå¤±è´¥"
    exit 1
fi

# =============================================================================
# Step 3: æ‰“æ ‡ç­¾å¹¶æ¨é€åˆ° ECR
# =============================================================================
echo "ğŸ·ï¸  Step 3: æ‰“æ ‡ç­¾..."
docker tag ${FULL_IMAGE} ${ECR_URI}:latest
echo "âœ… æ ‡ç­¾å·²åˆ›å»º: latest, ${IMAGE_TAG}"
echo ""

echo "ğŸ“¤ Step 4: æ¨é€é•œåƒåˆ° ECR..."
docker push ${FULL_IMAGE}
docker push ${ECR_URI}:latest

if [ $? -eq 0 ]; then
    echo ""
    echo "âœ… é•œåƒæ¨é€æˆåŠŸ"
    echo ""
else
    echo ""
    echo "âŒ é•œåƒæ¨é€å¤±è´¥"
    exit 1
fi

# =============================================================================
# å®Œæˆ
# =============================================================================
echo "============================================================"
echo "âœ… é•œåƒéƒ¨ç½²å®Œæˆ!"
echo "============================================================"
echo "é•œåƒæ ‡ç­¾: latest, ${IMAGE_TAG}"
echo "é•œåƒ URI: ${FULL_IMAGE}"
echo ""
