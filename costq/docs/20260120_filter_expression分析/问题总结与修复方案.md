# filter_expression å‚æ•°ç±»å‹é—®é¢˜ - æ€»ç»“ä¸ä¿®å¤æ–¹æ¡ˆ

## ğŸ“‹ é—®é¢˜æ¦‚è¿°

**å‘ç°æ—¶é—´:** 2026-01-20 09:28 AM
**å½±å“èŒƒå›´:** costq-risp-mcp-server çš„ 6 ä¸ªå‡½æ•°
**ä¸¥é‡ç¨‹åº¦:** é«˜ (é˜»æ–­ä¸šåŠ¡åŠŸèƒ½)

### é—®é¢˜ç°è±¡

è°ƒç”¨ RISP MCP å·¥å…·æ—¶æŠ¥é”™:
```
Error executing tool get_sp_coverage: 1 validation error for get_savings_plans_coverage
Arguments\nfilter_expression\n
Input should be a valid string [type=string_type, input_value={'Dimensions': {...}}, input_type=dict]
```

---

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

### 1. æŠ€æœ¯æ ˆå’Œè°ƒç”¨é“¾

```
ç”¨æˆ·/æ¨¡å‹
    â†“
FastAPI (CostQ Agent)
    â†“
Bedrock AgentCore Gateway
    â†“
Bedrock AgentCore Runtime
    â†“
MCP Server (FastMCP)
    â†“
AWS Cost Explorer API
```

### 2. é—®é¢˜æ ¹æº

#### é—®é¢˜å±‚æ¬¡1: FastMCP Schema ç”Ÿæˆç¼ºé™·

**åŸå§‹ä»£ç :**
```python
filter_expression: Annotated[
    Optional[dict],
    Field(description="Filter expression for Cost Explorer API")
] = None
```

**ç”Ÿæˆçš„ OpenAPI Schema (é”™è¯¯):**
```json
{
  "filter_expression": {
    "anyOf": [
      {},  // âŒ æ²¡æœ‰ "type": "object"
      {"type": "null"}
    ],
    "description": "Filter expression for Cost Explorer API"
  }
}
```

**é—®é¢˜:** FastMCP æ¡†æ¶åœ¨ç”Ÿæˆ OpenAPI Schema æ—¶,å¯¹äº `dict` ç±»å‹æ²¡æœ‰æ­£ç¡®ç”Ÿæˆ `"type": "object"`,å¯¼è‡´ Schema æ— æ•ˆã€‚

#### é—®é¢˜å±‚æ¬¡2: Gateway åºåˆ—åŒ–è¡Œä¸ºä¸ä¸€è‡´

**æƒ…å†µA: Schema è¯´ type=object**
```
æ¨¡å‹ä¼ é€’: dict â†’ Gateway åºåˆ—åŒ–: json.dumps(dict) â†’ Runtime æ¥æ”¶: string âœ…
```

**æƒ…å†µB: Schema è¯´ type=string**
```
æ¨¡å‹ä¼ é€’: dict â†’ Gateway ä¸åºåˆ—åŒ– â†’ Runtime æ¥æ”¶: dict âŒ
```

**æƒ…å†µC: Schema ç¼ºå°‘ type (å½“å‰é—®é¢˜)**
```
æ¨¡å‹ä¼ é€’: dict â†’ Gateway è¡Œä¸ºæœªå®šä¹‰ â†’ Runtime æ¥æ”¶: dict âŒ
```

#### é—®é¢˜å±‚æ¬¡3: Pydantic å‚æ•°éªŒè¯æ‹¦æˆª

**ä»£ç å®šä¹‰:**
```python
filter_expression: Annotated[Optional[str], Field(...)]
```

**Pydantic è¡Œä¸º:**
- åœ¨å‡½æ•°è°ƒç”¨å‰éªŒè¯å‚æ•°ç±»å‹
- æ¥æ”¶åˆ° `dict` æ—¶,å‘ç°ç±»å‹ä¸åŒ¹é… `str`
- **ç«‹å³æ‹’ç»,æŠ›å‡º ValidationError**
- å‡½æ•°ä½“å†…çš„ JSON è§£æé€»è¾‘**æ ¹æœ¬æ²¡æœºä¼šæ‰§è¡Œ**

---

## ğŸ› ï¸ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆæ¼”è¿›å†ç¨‹

#### âŒ æ–¹æ¡ˆ1: æ”¹å› dict ç±»å‹ (è¢«å¦å†³)

```python
filter_expression: Annotated[Optional[dict], Field(...)]
```

**é—®é¢˜:**
- FastMCP ä»ç„¶æ— æ³•ç”Ÿæˆæ­£ç¡®çš„ Schema
- æ²»æ ‡ä¸æ²»æœ¬

#### âŒ æ–¹æ¡ˆ2: ä»…æ”¹ä¸º str ç±»å‹ + JSON è§£æ (å¤±è´¥)

```python
filter_expression: Annotated[Optional[str], Field(...)]

# å‡½æ•°å†…
if filter_expression:
    filter_dict = json.loads(filter_expression)
```

**é—®é¢˜:**
- Pydantic åœ¨å‡½æ•°è°ƒç”¨å‰å°±æ‹¦æˆªäº† dict
- JSON è§£æä»£ç æ ¹æœ¬æ‰§è¡Œä¸åˆ°

#### âœ… æ–¹æ¡ˆ3: Union ç±»å‹ + æ™ºèƒ½è½¬æ¢ (æœ€ç»ˆæ–¹æ¡ˆ)

**å…³é”®åˆ›æ–°:**
1. **æ”¾å®½å‚æ•°ç±»å‹** - å…è®¸ Pydantic éªŒè¯é€šè¿‡
2. **å‡½æ•°å†…æ™ºèƒ½æ£€æµ‹** - è‡ªåŠ¨å¤„ç†ä¸¤ç§ç±»å‹

---

## âœ… æœ€ç»ˆå®ç°

### 1. å‚æ•°ç±»å‹å®šä¹‰

```python
from typing import Union

filter_expression: Annotated[
    Optional[Union[str, dict]],  # âœ… åŒæ—¶å…è®¸ str å’Œ dict
    Field(
        description=(
            "Filter expression for Cost Explorer API as a JSON string or dict object. "
            "Supported dimensions: LINKED_ACCOUNT, REGION, SERVICE, INSTANCE_FAMILY. "
            "Example: '{\"Dimensions\": {\"Key\": \"SERVICE\", \"Values\": [\"EC2\"]}}'"
        )
    ),
] = None
```

### 2. æ™ºèƒ½ç±»å‹è½¬æ¢å‡½æ•°

```python
def parse_filter_expression(
    filter_expression: Optional[Union[str, dict]],
    function_name: str
) -> Optional[dict]:
    """è§£æ filter_expression å‚æ•°,æ”¯æŒè°ƒè¯•æ—¥å¿—.

    Args:
        filter_expression: JSON å­—ç¬¦ä¸²æˆ– dict å¯¹è±¡
        function_name: è°ƒç”¨æ­¤å‡½æ•°çš„å‡½æ•°å(ç”¨äºæ—¥å¿—)

    Returns:
        è§£æåçš„ dict æˆ– None

    Raises:
        ValueError: å¦‚æœ JSON æ ¼å¼æ— æ•ˆ
    """
    if not filter_expression:
        return None

    # ğŸ” è°ƒè¯•æ—¥å¿—: è®°å½•æ¥æ”¶åˆ°çš„ç±»å‹å’Œå€¼
    logger.info(
        "ğŸ” [%s] filter_expression type: %s, value: %s",
        function_name,
        type(filter_expression).__name__,
        str(filter_expression)[:200]
    )

    # âš¡ æ™ºèƒ½å¤„ç†: å¦‚æœæ˜¯ dict,ç›´æ¥ä½¿ç”¨ (è‡ªåŠ¨å…¼å®¹)
    if isinstance(filter_expression, dict):
        logger.warning(
            "âš ï¸ [%s] Received dict instead of string! Auto-converting...",
            function_name
        )
        return filter_expression

    # âœ… æ ‡å‡†å¤„ç†: JSON å­—ç¬¦ä¸²è§£æ
    try:
        filter_dict = json.loads(filter_expression)
        logger.info(
            "âœ… [%s] Successfully parsed filter_expression",
            function_name
        )
        return filter_dict
    except json.JSONDecodeError as e:
        logger.error(
            "âŒ [%s] Invalid JSON format for filter_expression: %s",
            function_name,
            str(e)
        )
        raise ValueError(
            f"Invalid JSON format for filter_expression: {e}"
        )
```

### 3. ä½¿ç”¨æ–¹å¼

```python
async def get_savings_plans_coverage(
    ctx: Context,
    filter_expression: Annotated[Optional[Union[str, dict]], Field(...)] = None,
    ...
) -> dict[str, Any]:
    # æ™ºèƒ½è§£æ,è‡ªåŠ¨å…¼å®¹ str å’Œ dict
    filter_dict = parse_filter_expression(filter_expression, "get_savings_plans_coverage")

    if filter_dict:
        request_params["Filter"] = filter_dict

    # ... AWS API è°ƒç”¨
```

---

## ğŸ¯ æ–¹æ¡ˆä¼˜åŠ¿

### 1. å…¼å®¹æ€§ âœ…

**åœºæ™¯A: æ¨¡å‹ä¼ é€’ dict**
```
æ¨¡å‹ â†’ dict
    â†“
Gateway â†’ å¯èƒ½ä¸åºåˆ—åŒ– â†’ dict
    â†“
Runtime â†’ Union[str, dict] â†’ Pydantic éªŒè¯é€šè¿‡ âœ…
    â†“
parse_filter_expression â†’ isinstance(dict) â†’ ç›´æ¥ä½¿ç”¨ âœ…
    â†“
AWS API è°ƒç”¨æˆåŠŸ âœ…
```

**åœºæ™¯B: æ¨¡å‹ä¼ é€’ JSON string**
```
æ¨¡å‹ â†’ string
    â†“
Gateway â†’ string
    â†“
Runtime â†’ Union[str, dict] â†’ Pydantic éªŒè¯é€šè¿‡ âœ…
    â†“
parse_filter_expression â†’ json.loads() â†’ dict âœ…
    â†“
AWS API è°ƒç”¨æˆåŠŸ âœ…
```

**åœºæ™¯C: ç”¨æˆ·æ‰‹åŠ¨ä¼ é€’ JSON string**
```
ç”¨æˆ· â†’ string
    â†“
Runtime â†’ Union[str, dict] â†’ Pydantic éªŒè¯é€šè¿‡ âœ…
    â†“
parse_filter_expression â†’ json.loads() â†’ dict âœ…
    â†“
AWS API è°ƒç”¨æˆåŠŸ âœ…
```

### 2. é²æ£’æ€§ âœ…

- **ä¸ä¾èµ–ä¸Šæ¸¸è¡Œä¸º:** æ— è®º Gateway å¦‚ä½•åºåˆ—åŒ–,éƒ½èƒ½æ­£ç¡®å¤„ç†
- **é˜²å¾¡æ€§ç¼–ç¨‹:** åœ¨æœåŠ¡è¾¹ç•Œåšå¥½ç±»å‹å…¼å®¹
- **å‘åå…¼å®¹:** æ”¯æŒæ–°æ—§ä¸¤ç§è°ƒç”¨æ–¹å¼

### 3. å¯è§‚æµ‹æ€§ âœ…

**è¯¦ç»†çš„æ—¥å¿—:**
```
ğŸ” [function_name] filter_expression type: dict, value: {'Dimensions': ...}
âš ï¸ [function_name] Received dict instead of string! Auto-converting...
```

**æ—¥å¿—ä»·å€¼:**
- æ¸…æ™°æ˜¾ç¤ºæ¥æ”¶åˆ°çš„ç±»å‹
- æ ‡è®°å¼‚å¸¸æƒ…å†µ(æ”¶åˆ° dict è€Œé string)
- ä¾¿äºé—®é¢˜è¿½è¸ªå’Œè°ƒè¯•

### 4. ä»£ç è´¨é‡ âœ…

- **DRY åŸåˆ™:** æå–å…¬å…±å‡½æ•°,å‡å°‘é‡å¤ä»£ç  (90+ è¡Œ â†’ 1 ä¸ªå‡½æ•°)
- **ç»Ÿä¸€é”™è¯¯å¤„ç†:** é›†ä¸­ç®¡ç†å¼‚å¸¸
- **æ˜“äºç»´æŠ¤:** æœªæ¥ä¿®æ”¹åªéœ€æ”¹ä¸€å¤„

---

## ğŸ“Š ä¿®æ”¹èŒƒå›´

### æ–‡ä»¶ä¿®æ”¹

**sp_handler.py:**
1. æ·»åŠ  `Union` å¯¼å…¥
2. æ·»åŠ  `parse_filter_expression()` å‡½æ•°
3. æ›´æ–° 4 ä¸ªå‡½æ•°:
   - `get_savings_plans_utilization()`
   - `get_savings_plans_coverage()`
   - `get_savings_plans_purchase_recommendation()`
   - `get_savings_plans_utilization_details()`

**ri_handler.py:**
1. æ·»åŠ  `Union` å¯¼å…¥
2. æ·»åŠ  `parse_filter_expression()` å‡½æ•°
3. æ›´æ–° 2 ä¸ªå‡½æ•°:
   - `get_reservation_utilization()`
   - `get_reservation_coverage()`

### ä»£ç ç»Ÿè®¡

- **æ€»ä¿®æ”¹è¡Œæ•°:** çº¦ 120 è¡Œ
- **æ–°å¢å‡½æ•°:** 2 ä¸ª (æ¯ä¸ªæ–‡ä»¶ 1 ä¸ª)
- **å‚æ•°ç±»å‹ä¿®æ”¹:** 6 å¤„
- **è§£æé€»è¾‘æ›¿æ¢:** 6 å¤„

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æœ¬åœ°æµ‹è¯•

**1. Python è¯­æ³•æ£€æŸ¥ âœ…**
```bash
python3 -m py_compile handlers/sp_handler.py
python3 -m py_compile handlers/ri_handler.py
```

**2. JSON è§£æé€»è¾‘æµ‹è¯• âœ…**
- æœ‰æ•ˆ JSON å­—ç¬¦ä¸² â†’ è§£ææˆåŠŸ
- None å€¼ â†’ è¿”å› None
- ç©ºå­—ç¬¦ä¸² â†’ è¿”å› None
- æ— æ•ˆ JSON â†’ æ­£ç¡®æŠ›å‡ºå¼‚å¸¸
- dict å¯¹è±¡ â†’ ç›´æ¥ä½¿ç”¨

**3. å®¹å™¨æ„å»ºæµ‹è¯• âœ…**
```bash
docker build -t costq-risp-mcp-server:test .
docker run --rm costq-risp-mcp-server:test python -c "..."
```

### ç”Ÿäº§ç¯å¢ƒæµ‹è¯•

**éƒ¨ç½²ä¿¡æ¯:**
- é•œåƒç‰ˆæœ¬: `v20260121-112403`
- Runtime ID: `costq_risp_mcp_production-6ypFN96HS4`
- éƒ¨ç½²æ—¶é—´: 2026-01-21 11:24 AM

**æµ‹è¯•ç»“æœ:**
- âœ… `get_sp_coverage` è°ƒç”¨æˆåŠŸ
- âœ… `get_sp_utilization` è°ƒç”¨æˆåŠŸ
- âœ… `get_ri_coverage` è°ƒç”¨æˆåŠŸ
- âœ… æ‰€æœ‰ filter_expression å‚æ•°æ­£å¸¸å·¥ä½œ

---

## ğŸ“š ç»éªŒæ€»ç»“

### å…³é”®æ•™è®­

1. **è·¨æœåŠ¡é€šä¿¡çš„ç±»å‹è½¬æ¢ä¸å¯é¢„æµ‹**
   - ä¸è¦å‡è®¾ä¸Šæ¸¸ä¼šæŒ‰ç…§ä½ æœŸæœ›çš„æ–¹å¼åºåˆ—åŒ–æ•°æ®
   - åœ¨æœåŠ¡è¾¹ç•Œåšå¥½é˜²å¾¡æ€§ç¼–ç¨‹

2. **Pydantic éªŒè¯å‘ç”Ÿåœ¨å‡½æ•°è°ƒç”¨å‰**
   - å‚æ•°ç±»å‹å¿…é¡»åœ¨å‡½æ•°ç­¾åä¸­å£°æ˜æ­£ç¡®
   - å‡½æ•°ä½“å†…çš„ç±»å‹è½¬æ¢é€»è¾‘æ‰§è¡Œä¸åˆ°

3. **FastMCP Schema ç”Ÿæˆæœ‰å±€é™**
   - `dict` ç±»å‹æ— æ³•ç”Ÿæˆæ­£ç¡®çš„ `type: object` Schema
   - éœ€è¦ä½¿ç”¨ `Union[str, dict]` ç»•è¿‡è¿™ä¸ªé—®é¢˜

4. **æ—¥å¿—æ˜¯è°ƒè¯•çš„å…³é”®**
   - è¯¦ç»†çš„ç±»å‹æ—¥å¿—å¸®åŠ©å¿«é€Ÿå®šä½é—®é¢˜
   - Emoji æ ‡è®°è®©æ—¥å¿—æ›´æ˜“è¯»

### æœ€ä½³å®è·µ

1. **å‚æ•°ç±»å‹è®¾è®¡**
   - âœ… ä½¿ç”¨ `Union` ç±»å‹æ”¯æŒå¤šç§è¾“å…¥æ ¼å¼
   - âœ… åœ¨å‡½æ•°å†…åšæ™ºèƒ½ç±»å‹æ£€æµ‹å’Œè½¬æ¢
   - âŒ ä¸è¦å‡è®¾åªæœ‰ä¸€ç§ç±»å‹è¾“å…¥

2. **é”™è¯¯å¤„ç†**
   - âœ… æ•è·å…·ä½“çš„å¼‚å¸¸ç±»å‹ (`JSONDecodeError`)
   - âœ… æä¾›æ¸…æ™°çš„é”™è¯¯æ¶ˆæ¯
   - âœ… è®°å½•è¯¦ç»†çš„æ—¥å¿—

3. **ä»£ç å¤ç”¨**
   - âœ… æå–å…¬å…±é€»è¾‘ä¸ºè¾…åŠ©å‡½æ•°
   - âœ… ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
   - âœ… ä¿æŒä»£ç  DRY

4. **ç‰ˆæœ¬æ§åˆ¶**
   - âœ… ä¾èµ– Git è€Œéå¤‡ä»½æ–‡ä»¶
   - âœ… æ¸…æ™°çš„ commit message
   - âœ… å®Œæ•´çš„æ–‡æ¡£è®°å½•

---

## ğŸ”— ç›¸å…³èµ„æº

### æ–‡æ¡£

- **é—®é¢˜åˆ†æ:** `costq/docs/20260120_filter_expressionåˆ†æ/`
- **ä¿®å¤è®¡åˆ’:** `ä¿®å¤è®¡åˆ’.md`
- **ä»£ç  Review:** `ä»£ç ReviewæŠ¥å‘Š.md`
- **æµ‹è¯•æŠ¥å‘Š:** `Phase3_æµ‹è¯•æŠ¥å‘Š.md`

### ä»£ç 

- **sp_handler.py:** `src/costq-risp-mcp-server/handlers/sp_handler.py`
- **ri_handler.py:** `src/costq-risp-mcp-server/handlers/ri_handler.py`

### Git

- **Commit:** `cb3a41ec`
- **Branch:** `main`
- **Tag:** `v20260121-112403`

---

## ğŸ“ æŠ€æœ¯çŸ¥è¯†ç‚¹

### 1. Python ç±»å‹ç³»ç»Ÿ

```python
from typing import Union, Optional

# Union[A, B] - A æˆ– B ç±»å‹
# Optional[X] - X æˆ– None,ç­‰ä»·äº Union[X, None]
# Union[str, dict] - å­—ç¬¦ä¸²æˆ–å­—å…¸

filter_expression: Optional[Union[str, dict]]  # str, dict, æˆ– None
```

### 2. Pydantic éªŒè¯æµç¨‹

```
1. å‡½æ•°è¢«è°ƒç”¨
   â†“
2. Pydantic è¯»å–å‚æ•°ç±»å‹æ³¨è§£
   â†“
3. éªŒè¯ä¼ å…¥å‚æ•°çš„ç±»å‹
   â†“
4. ç±»å‹åŒ¹é… â†’ ç»§ç»­
   ç±»å‹ä¸åŒ¹é… â†’ æŠ›å‡º ValidationError âŒ
   â†“
5. æ‰§è¡Œå‡½æ•°ä½“
```

### 3. isinstance() ç±»å‹æ£€æµ‹

```python
# è¿è¡Œæ—¶ç±»å‹æ£€æµ‹
if isinstance(value, dict):
    # value æ˜¯ dict ç±»å‹
    return value
elif isinstance(value, str):
    # value æ˜¯ str ç±»å‹
    return json.loads(value)
```

### 4. JSON åºåˆ—åŒ–/ååºåˆ—åŒ–

```python
# dict â†’ JSON string
json_str = json.dumps({"key": "value"})  # '{"key": "value"}'

# JSON string â†’ dict
data = json.loads('{"key": "value"}')  # {'key': 'value'}

# å¼‚å¸¸å¤„ç†
try:
    data = json.loads(invalid_json)
except json.JSONDecodeError as e:
    # å¤„ç†æ— æ•ˆ JSON
    logger.error(f"Invalid JSON: {e}")
```

---

## ğŸš€ æœªæ¥æ”¹è¿›

### å¯é€‰ä¼˜åŒ–

1. **ç±»å‹æç¤ºå¢å¼º**
   ```python
   from typing import TypeAlias

   FilterExpression: TypeAlias = Union[str, dict[str, Any]]

   filter_expression: Optional[FilterExpression] = None
   ```

2. **æ€§èƒ½ä¼˜åŒ–**
   - dict å¿«é€Ÿè·¯å¾„ (ç›´æ¥è¿”å›)
   - å‡å°‘ä¸å¿…è¦çš„æ—¥å¿—è®°å½•

3. **ä¸Šæ¸¸ä¿®å¤**
   - å‘ FastMCP å›¢é˜Ÿæäº¤ Issue
   - ä¿®å¤ dict ç±»å‹çš„ Schema ç”Ÿæˆé—®é¢˜

---

**æ–‡æ¡£ç‰ˆæœ¬:** 1.0
**æœ€åæ›´æ–°:** 2026-01-21
**ä½œè€…:** DeepV Code AI Assistant
**çŠ¶æ€:** âœ… é—®é¢˜å·²è§£å†³,ä»£ç å·²éƒ¨ç½²
