# costq-risp-mcp-server filter_expression 完整影响范围分析

## 📊 分析时间
2026-01-20

## 🔍 搜索结果汇总

通过全局搜索 `filter_expression`,在 costq-risp-mcp-server 中找到 **38 处匹配**,分布在以下文件:

### 文件分布

| 文件 | 匹配数 | 文件类型 | 优先级 |
|------|--------|---------|--------|
| `handlers/sp_handler.py` | 12 | Handler | 🔴 高 - 需修改 |
| `handlers/ri_handler.py` | 6 | Handler | 🔴 高 - 需修改 |
| `models/sp_models.py` | 8 | Model | 🟡 中 - 可能需修改 |
| `models/ri_models.py` | 2 | Model | 🟡 中 - 可能需修改 |
| `models/common_models.py` | 1 | Model | 🟡 中 - 可能需修改 |
| `utils/validators.py` | 4 | Util | 🟢 低 - 影响较小 |

---

## 🎯 Handler 层分析 (最高优先级)

### 1. sp_handler.py - Savings Plans Handler

#### 影响的函数

| 行号 | 函数名 | 参数定义位置 | 使用位置 | 状态 |
|------|--------|-------------|---------|------|
| 61 | `get_savings_plans_coverage()` | L61 | L202-203 | ❌ 需修改 |
| 296 | `get_savings_plans_utilization()` | L296 | L446-447 | ❌ 需修改 |
| 550 | `get_savings_plans_utilization_detail()` | L550 | L663-664 | ❌ 需修改 |
| 885 | 未知函数(需确认) | L885 | L991-992 | ❌ 需修改 |

#### 当前定义方式

**L61-70 (get_savings_plans_coverage):**
```python
filter_expression: Annotated[
    Optional[dict],
    Field(description="Filter expression for Cost Explorer API"),
] = None,
```

**L202-203 (使用方式):**
```python
if filter_expression:
    request_params["Filter"] = filter_expression
```

**问题:**
- ❌ 定义为 `Optional[dict]`
- ❌ Schema 生成缺少 `type: object`
- ❌ 直接赋值,无 JSON 解析

---

### 2. ri_handler.py - Reserved Instances Handler

#### 影响的函数

| 行号 | 函数名 | 参数定义位置 | 使用位置 | 状态 |
|------|--------|-------------|---------|------|
| 68 | `get_reservation_coverage()` | L68 | L186-187 | ❌ 需修改 |
| 281 | `get_reservation_utilization()` | L281 | L400-401 | ❌ 需修改 |

#### 当前定义方式

**L68-71 (get_reservation_coverage):**
```python
filter_expression: Annotated[
    Optional[dict],
    Field(description="Filter expression for Cost Explorer API"),
] = None,
```

**L186-187 (使用方式):**
```python
if filter_expression:
    request_params["Filter"] = filter_expression
```

**L281-284 (get_reservation_utilization):**
```python
filter_expression: Annotated[
    Optional[dict],
    Field(description="Filter expression for Cost Explorer API"),
] = None,
```

**L400-401 (使用方式):**
```python
if filter_expression:
    request_params["Filter"] = filter_expression
```

**问题:** 与 sp_handler.py 完全相同
- ❌ 定义为 `Optional[dict]`
- ❌ Schema 生成缺少 `type: object`
- ❌ 直接赋值,无 JSON 解析

---

## 📦 Model 层分析 (中等优先级)

### 3. models/sp_models.py

#### 涉及的模型

**L88 (使用 FilterExpression 类型):**
```python
filter_expression: FilterExpression | None = Field(...)
```

**L297 (使用 FilterExpression 类型):**
```python
filter_expression: FilterExpression | None = Field(...)
```

**L408, L447, L492 (使用 dict 类型):**
```python
filter_expression: dict[str, Any] | None = Field(default=None, description="Filter conditions")
```

**L547 (使用 dict 类型):**
```python
filter_expression: dict[str, Any] | None = Field(...)
```

**分析:**
- 🟡 部分使用 `FilterExpression` 类型别名(需要查看定义)
- 🟡 部分直接使用 `dict[str, Any]`
- ⚠️  Model 层主要用于数据验证,可能不需要修改
- ⚠️  但需要确认 `FilterExpression` 的定义

---

### 4. models/ri_models.py

**L278:**
```python
filter_expression: dict[str, Any] | None = Field(...)
```

**L333:**
```python
filter_expression: dict[str, Any] | None = Field(...)
```

**分析:** 直接使用 `dict[str, Any]`,与 sp_models.py 类似

---

### 5. models/common_models.py

**L139 (FilterExpression 类型定义?):**
```python
filter_expression: FilterExpression | None = Field(...)
```

**需要检查:** 这可能是 `FilterExpression` 类型别名的定义位置

---

## 🔧 Utils 层分析 (低优先级)

### 6. utils/validators.py

**L193 (验证函数):**
```python
def validate_filter_expression(filter_expr: dict[str, Any] | None) -> tuple[bool, str]:
```

**L210-216 (匹配选项验证):**
```python
def validate_match_options(filter_expression: dict[str, Any] | None) -> dict[str, Any] | None:
    if not filter_expression:
        return filter_expression

    filter_copy = copy.deepcopy(filter_expression)
```

**分析:**
- 🟢 这是工具函数,接收 `dict` 类型是正确的
- 🟢 在 Handler 层解析 JSON 后传递 dict 给这些函数
- ✅ **不需要修改**

---

## 📋 完整修改清单

### ✅ 必须修改的文件和函数

#### 文件1: `handlers/sp_handler.py`

| 函数名 | 行号 | 修改内容 |
|--------|------|---------|
| `get_savings_plans_coverage()` | L61 (参数定义)<br>L202-203 (使用) | 1. 参数类型改为 `Optional[str]`<br>2. 添加 JSON 解析逻辑<br>3. 更新文档 |
| `get_savings_plans_utilization()` | L296 (参数定义)<br>L446-447 (使用) | 同上 |
| `get_savings_plans_utilization_detail()` | L550 (参数定义)<br>L663-664 (使用) | 同上 |
| `get_savings_plans_utilization_details()` | L885 (参数定义)<br>L991-992 (使用) | 同上 |

#### 文件2: `handlers/ri_handler.py`

| 函数名 | 行号 | 修改内容 |
|--------|------|---------|
| `get_reservation_coverage()` | L68 (参数定义)<br>L186-187 (使用) | 1. 参数类型改为 `Optional[str]`<br>2. 添加 JSON 解析逻辑<br>3. 更新文档 |
| `get_reservation_utilization()` | L281 (参数定义)<br>L400-401 (使用) | 同上 |

**总计:** 2个文件,6个函数

---

### 🟡 可能需要修改的文件

#### models/common_models.py
- **检查:** `FilterExpression` 类型别名的定义
- **可能操作:** 如果它被定义为复杂的 `dict` 类型,可能需要改为 `str` 类型别名

#### models/sp_models.py 和 models/ri_models.py
- **检查:** 这些 Model 是否被 Handler 层使用
- **可能操作:** 如果 Handler 使用这些 Model 做参数验证,可能需要同步修改类型
- **判断原则:** 如果 Handler 层已经改为 `str` 类型,这些 Model 也应该改为 `str`

---

### ✅ 不需要修改的文件

#### utils/validators.py
- **原因:** 验证函数接收解析后的 `dict`,在 Handler 层解析后传递
- **保持不变:** 继续使用 `dict[str, Any]` 类型

---

## 🎯 修改策略

### 阶段划分

#### Phase 1: Handler 层修改 (核心)
1. 修改 `sp_handler.py` 的 4 个函数
2. 修改 `ri_handler.py` 的 2 个函数
3. **总计:** 6 个函数,所有的参数定义和使用逻辑

#### Phase 2: Model 层检查和修改 (如需要)
1. 检查 `common_models.py` 中的 `FilterExpression` 定义
2. 如果 Handler 使用了这些 Model,同步修改类型
3. 确保 Model 验证逻辑与 Handler 一致

#### Phase 3: 测试和验证
1. 单元测试
2. 集成测试
3. MCP Inspector 测试
4. 生产环境部署和验证

---

## 🔍 需要进一步确认的问题

### 1. ✅ sp_handler.py 第 4 个函数的名称 (已确认)
- **函数名:** `get_savings_plans_utilization_details()`
- **位置:** L885 定义, L991-992 使用
- **状态:** 需要修改

### 2. ✅ FilterExpression 类定义 (已确认)
- **位置:** `models/common_models.py` L62-77
- **类型:** Pydantic BaseModel 类,用于验证 Filter 结构
- **结构:** 支持 And, Or, Not, Dimensions, Tags, CostCategories
- **重要发现:** 这是一个**复杂的递归模型**,用于验证 Cost Explorer 的 Filter 结构
- **影响:**
  - ✅ **Model 层不需要修改** - 它是用于解析后的验证,继续使用 `FilterExpression` 类型
  - ✅ **Handler 层改为 str** - 接收 JSON 字符串,解析后可以用 FilterExpression 验证

### 3. ✅ Model 层的使用情况 (已确认)
- **BaseRISPRequest (L131-139):** 使用 `FilterExpression` 类型
- **结论:** Model 层用于数据验证,在 Handler 解析 JSON 后传递 dict 给 Model 验证
- **修改策略:**
  - ✅ Handler 层: `str` → 解析为 `dict` → 传递给 AWS API
  - ✅ Model 层: 保持 `FilterExpression` 类型,用于验证解析后的 dict
  - ✅ **Model 层不需要修改**

---

## 📊 工作量估算 (更新)

| 任务 | 原估算 | 新估算 | 增加 |
|------|--------|--------|------|
| Handler 层修改 | 4个函数 | 6个函数 | +2个函数 |
| 文件数量 | 1个文件 | 2个文件 | +1个文件 |
| Model 层检查 | 无 | 需要 | +30分钟 |
| 额外测试 | 无 | RI相关测试 | +30分钟 |
| **总时间** | 3.5小时 | **4.5-5小时** | +1小时 |

---

## ✅ 下一步行动

### 立即执行
1. ✅ 读取 `sp_handler.py` L885 确认第4个函数名
2. ✅ 读取 `common_models.py` L139 确认 `FilterExpression` 定义
3. ✅ 检查 Model 层是否被 Handler 使用

### 后续执行
4. 更新修复计划文档
5. 开始 Phase 1 代码修改

---

## 🚨 重要发现

**影响范围扩大:**
- 原计划: 1个文件 (`sp_handler.py`), 4个函数
- 实际范围: 2个文件 (`sp_handler.py` + `ri_handler.py`), 至少6个函数
- 可能还需要修改 Model 层

**建议:**
- ⚠️  需要更新修复计划,增加 `ri_handler.py` 的修改
- ⚠️  需要增加时间预算,从 3.5 小时增加到 4.5-5 小时
- ⚠️  需要同时测试 SP 和 RI 相关的所有功能

**优先级:**
1. 🔴 确认完整的修改范围
2. 🔴 更新修复计划
3. 🔴 开始执行修复

---

**完成时间:** 2026-01-20
**下一步:** 确认第4个函数名和 FilterExpression 定义,然后更新修复计划
