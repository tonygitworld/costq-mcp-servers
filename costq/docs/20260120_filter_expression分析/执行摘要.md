# filter_expression å‚æ•°ä¿®å¤ - æ‰§è¡Œæ‘˜è¦

## ğŸ“‹ æ¦‚è¿°

**é—®é¢˜:** `filter_expression` å‚æ•°ç±»å‹å®šä¹‰ä¸º `Optional[dict]`,å¯¼è‡´ Bedrock AgentCore Schema éªŒè¯å¤±è´¥

**å½±å“:** æ‰€æœ‰ä½¿ç”¨ `filter_expression` çš„å·¥å…·è°ƒç”¨éƒ½ä¼šæŠ¥ `JsonSchemaException`

**è§£å†³æ–¹æ¡ˆ:** éµå¾ª AWS å®˜æ–¹ MCP æœ€ä½³å®è·µ,æ”¹ä¸º `Optional[str]` ç±»å‹å¹¶åœ¨å†…éƒ¨è§£æ

---

## âœ… å®Œæ•´å½±å“èŒƒå›´ (å·²ç¡®è®¤)

### Handler å±‚ - å¿…é¡»ä¿®æ”¹

#### æ–‡ä»¶1: `handlers/sp_handler.py` (4ä¸ªå‡½æ•°)

1. **`get_savings_plans_coverage()`** (L61, L202-203)
   - Savings Plans è¦†ç›–ç‡æŸ¥è¯¢
   - å‚æ•°å®šä¹‰ + ä½¿ç”¨é€»è¾‘éƒ½éœ€è¦ä¿®æ”¹

2. **`get_savings_plans_utilization()`** (L296, L446-447)
   - Savings Plans åˆ©ç”¨ç‡æŸ¥è¯¢
   - å‚æ•°å®šä¹‰ + ä½¿ç”¨é€»è¾‘éƒ½éœ€è¦ä¿®æ”¹

3. **`get_savings_plans_utilization_detail()`** (L550, L663-664)
   - Savings Plans è¯¦ç»†åˆ©ç”¨ç‡æŸ¥è¯¢
   - å‚æ•°å®šä¹‰ + ä½¿ç”¨é€»è¾‘éƒ½éœ€è¦ä¿®æ”¹

4. **`get_savings_plans_utilization_details()`** (L885, L991-992)
   - Savings Plans è¯¦ç»†åˆ©ç”¨ç‡æŸ¥è¯¢(å¦ä¸€ç‰ˆæœ¬)
   - å‚æ•°å®šä¹‰ + ä½¿ç”¨é€»è¾‘éƒ½éœ€è¦ä¿®æ”¹

#### æ–‡ä»¶2: `handlers/ri_handler.py` (2ä¸ªå‡½æ•°)

5. **`get_reservation_coverage()`** (L68, L186-187)
   - Reserved Instances è¦†ç›–ç‡æŸ¥è¯¢
   - å‚æ•°å®šä¹‰ + ä½¿ç”¨é€»è¾‘éƒ½éœ€è¦ä¿®æ”¹

6. **`get_reservation_utilization()`** (L281, L400-401)
   - Reserved Instances åˆ©ç”¨ç‡æŸ¥è¯¢
   - å‚æ•°å®šä¹‰ + ä½¿ç”¨é€»è¾‘éƒ½éœ€è¦ä¿®æ”¹

**æ€»è®¡:** 2ä¸ªæ–‡ä»¶, 6ä¸ªå‡½æ•°, 12å¤„ä»£ç ä¿®æ”¹ç‚¹

---

### Model å±‚ - ä¸éœ€è¦ä¿®æ”¹ âœ…

- **`models/common_models.py`**
  - `FilterExpression` ç±» (L62-77): ä¿æŒ Pydantic BaseModel,ç”¨äºéªŒè¯
  - `BaseRISPRequest` ç±» (L131-139): ä¿æŒ `FilterExpression` ç±»å‹

- **`models/sp_models.py`** - ä¿æŒä¸å˜
- **`models/ri_models.py`** - ä¿æŒä¸å˜

**åŸå› :** Model å±‚ç”¨äºéªŒè¯è§£æåçš„ dict,ä¸éœ€è¦ä¿®æ”¹

---

### Utils å±‚ - ä¸éœ€è¦ä¿®æ”¹ âœ…

- **`utils/validators.py`**
  - `validate_filter_expression()` (L193)
  - `validate_match_options()` (L210-216)

**åŸå› :** éªŒè¯å‡½æ•°æ¥æ”¶è§£æåçš„ dict,Handler å±‚è§£æåä¼ é€’

---

## ğŸ”§ ä¿®æ”¹å†…å®¹

### æ¯ä¸ªå‡½æ•°çš„ä¿®æ”¹ (å…±6ä¸ªå‡½æ•°,æ¨¡å¼ç›¸åŒ)

#### 1. å‚æ•°ç±»å‹å®šä¹‰

**ä¿®æ”¹å‰:**
```python
filter_expression: Annotated[
    Optional[dict],
    Field(description="Filter expression for Cost Explorer API"),
] = None,
```

**ä¿®æ”¹å:**
```python
filter_expression: Annotated[
    Optional[str],
    Field(
        description=(
            "Filter expression for Cost Explorer API as a JSON string. "
            "Example: '{\"Dimensions\": {\"Key\": \"SERVICE\", "
            "\"Values\": [\"Amazon Elastic Compute Cloud - Compute\"]}}'"
        )
    ),
] = None,
```

#### 2. JSON è§£æé€»è¾‘

**ä¿®æ”¹å‰:**
```python
if filter_expression:
    request_params["Filter"] = filter_expression
```

**ä¿®æ”¹å:**
```python
# Parse filter_expression from JSON string if provided
filter_dict = None
if filter_expression:
    try:
        filter_dict = json.loads(filter_expression)
    except json.JSONDecodeError as e:
        logger.error(
            "Invalid JSON format for filter_expression parameter: %s",
            str(e)
        )
        raise ValueError(
            f"Invalid JSON format for filter_expression: {e}"
        )

# Use parsed filter in request
if filter_dict:
    request_params["Filter"] = filter_dict
```

#### 3. ç¡®ä¿ json æ¨¡å—å·²å¯¼å…¥

```python
import json  # åœ¨æ–‡ä»¶é¡¶éƒ¨
```

---

## âœ… ä¿®æ”¹ Checklist

### sp_handler.py (4ä¸ªå‡½æ•°)
- [ ] `get_savings_plans_coverage()` - å‚æ•°å®šä¹‰ + è§£æé€»è¾‘
- [ ] `get_savings_plans_utilization()` - å‚æ•°å®šä¹‰ + è§£æé€»è¾‘
- [ ] `get_savings_plans_utilization_detail()` - å‚æ•°å®šä¹‰ + è§£æé€»è¾‘
- [ ] `get_savings_plans_utilization_details()` - å‚æ•°å®šä¹‰ + è§£æé€»è¾‘
- [ ] ç¡®ä¿ `import json` å·²æ·»åŠ 

### ri_handler.py (2ä¸ªå‡½æ•°)
- [ ] `get_reservation_coverage()` - å‚æ•°å®šä¹‰ + è§£æé€»è¾‘
- [ ] `get_reservation_utilization()` - å‚æ•°å®šä¹‰ + è§£æé€»è¾‘
- [ ] ç¡®ä¿ `import json` å·²æ·»åŠ 

### ä»£ç è´¨é‡æ£€æŸ¥
- [ ] Ruff è¯­æ³•æ£€æŸ¥é€šè¿‡
- [ ] ç±»å‹æ³¨è§£æ­£ç¡®
- [ ] æ—¥å¿—ä½¿ç”¨ `logger.error()` éµå¾ª CODING_STANDARDS.md
- [ ] å¼‚å¸¸å¤„ç†è§„èŒƒ (æ•è· `json.JSONDecodeError`)
- [ ] ä»£ç æ ¼å¼ç¬¦åˆè§„èŒƒ (4ç©ºæ ¼ç¼©è¿›,â‰¤100å­—ç¬¦/è¡Œ)

---

## ğŸ§ª æµ‹è¯•è®¡åˆ’

### æœ¬åœ°æµ‹è¯• (MCP Inspector)
1. âœ… æµ‹è¯• SP è¦†ç›–ç‡æŸ¥è¯¢ - ä¼ é€’æœ‰æ•ˆ JSON å­—ç¬¦ä¸²
2. âœ… æµ‹è¯• RI è¦†ç›–ç‡æŸ¥è¯¢ - ä¼ é€’æœ‰æ•ˆ JSON å­—ç¬¦ä¸²
3. âœ… æµ‹è¯•æ— æ•ˆ JSON - éªŒè¯é”™è¯¯å¤„ç†
4. âœ… æµ‹è¯• filter_expression=None - éªŒè¯å¯é€‰å‚æ•°

### ç”Ÿäº§ç¯å¢ƒæµ‹è¯•åœºæ™¯

**åœºæ™¯1:** EC2 Savings Plans è¦†ç›–ç‡
```json
{
  "start_date": "2026-01-17",
  "end_date": "2026-01-21",
  "granularity": "DAILY",
  "filter_expression": "{\"Dimensions\": {\"Key\": \"SERVICE\", \"Values\": [\"Amazon Elastic Compute Cloud - Compute\"]}}",
  "target_account_id": "859082029538"
}
```

**åœºæ™¯2:** ElastiCache Savings Plans
```json
{
  "start_date": "2026-01-17",
  "end_date": "2026-01-21",
  "granularity": "DAILY",
  "filter_expression": "{\"Dimensions\": {\"Key\": \"SERVICE\", \"Values\": [\"Amazon ElastiCache\"]}}",
  "target_account_id": "859082029538"
}
```

**åœºæ™¯3:** RDS Reserved Instances è¦†ç›–ç‡
```json
{
  "start_date": "2026-01-17",
  "end_date": "2026-01-21",
  "granularity": "DAILY",
  "filter_expression": "{\"Dimensions\": {\"Key\": \"SERVICE\", \"Values\": [\"Amazon Relational Database Service\"]}}",
  "target_account_id": "859082029538"
}
```

**åœºæ™¯4:** RI åˆ©ç”¨ç‡æŸ¥è¯¢ (æ—  filter)
```json
{
  "start_date": "2026-01-01",
  "end_date": "2026-01-20",
  "granularity": "MONTHLY",
  "target_account_id": "859082029538"
}
```

---

## ğŸ“Š æ—¶é—´ä¼°ç®—

| é˜¶æ®µ | ä»»åŠ¡å†…å®¹ | é¢„ä¼°æ—¶é—´ |
|------|---------|---------|
| Phase 1 | ä»£ç å‡†å¤‡å’ŒéªŒè¯ | 30åˆ†é’Ÿ âœ… å·²å®Œæˆ |
| Phase 2 | ä¿®æ”¹ 6ä¸ªå‡½æ•° (12å¤„ä»£ç ) | 1.5å°æ—¶ |
| Phase 3 | æœ¬åœ°æµ‹è¯• (MCP Inspector) | 1.5å°æ—¶ |
| Phase 4 | éƒ¨ç½²å’Œç”Ÿäº§éªŒè¯ (4ä¸ªåœºæ™¯) | 1.5å°æ—¶ |
| **æ€»è®¡** | | **5å°æ—¶** |

**å»ºè®®æ‰§è¡Œæ—¶é—´:** é¢„ç•™ 5.5-6 å°æ—¶,åŒ…å«ç¼“å†²æ—¶é—´

---

## ğŸ¯ æˆåŠŸæ ‡å‡†

### ä»£ç è´¨é‡
- âœ… æ‰€æœ‰è¯­æ³•æ£€æŸ¥é€šè¿‡ (`ruff check`)
- âœ… æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡ (`pytest`)
- âœ… ä»£ç éµå¾ª CODING_STANDARDS.md è§„èŒƒ
- âœ… æ—¥å¿—è§„èŒƒ (ä½¿ç”¨ `logging.getLogger(__name__)`)
- âœ… å¼‚å¸¸å¤„ç†è§„èŒƒ (æ•è·å…·ä½“å¼‚å¸¸ç±»å‹)

### åŠŸèƒ½éªŒè¯
- âœ… æ‰€æœ‰ 6 ä¸ªå‡½æ•°è°ƒç”¨æˆåŠŸ
- âœ… æ—  `JsonSchemaException` é”™è¯¯
- âœ… JSON è§£ææ­£ç¡®
- âœ… æ— æ•ˆ JSON æ­£ç¡®æŠ¥é”™
- âœ… filter_expression=None æ­£å¸¸å·¥ä½œ

### ç”Ÿäº§éªŒè¯
- âœ… 4 ä¸ªæµ‹è¯•åœºæ™¯å…¨éƒ¨é€šè¿‡
- âœ… Runtime æ—¥å¿—æ— é”™è¯¯
- âœ… Gateway æ—¥å¿—æ—  Schema éªŒè¯é”™è¯¯
- âœ… AWS Spans è¿½è¸ªæ— å¼‚å¸¸

---

## ğŸ“ æäº¤ä¿¡æ¯ (éµå¾ª Conventional Commits)

```
fix(risp-mcp): ä¿®å¤ filter_expression å‚æ•°ç±»å‹é—®é¢˜

å°† filter_expression ä» dict æ”¹ä¸º str ç±»å‹,å¹¶åœ¨å†…éƒ¨è§£æä¸º JSON å¯¹è±¡,
è§£å†³ Bedrock AgentCore Schema éªŒè¯å¤±è´¥é—®é¢˜ã€‚

ä¿®æ”¹èŒƒå›´:
- handlers/sp_handler.py (4ä¸ªå‡½æ•°)
  * get_savings_plans_coverage
  * get_savings_plans_utilization
  * get_savings_plans_utilization_detail
  * get_savings_plans_utilization_details

- handlers/ri_handler.py (2ä¸ªå‡½æ•°)
  * get_reservation_coverage
  * get_reservation_utilization

æŠ€æœ¯ç»†èŠ‚:
- å‚æ•°ç±»å‹: Optional[dict] â†’ Optional[str]
- æ·»åŠ  JSON è§£æ: json.loads() + é”™è¯¯å¤„ç†
- éµå¾ª billing-cost-management-mcp-server çš„æœ€ä½³å®è·µ
- ç¬¦åˆ Bedrock AgentCore Schema è¦æ±‚

æµ‹è¯•:
- æœ¬åœ° MCP Inspector æµ‹è¯•é€šè¿‡
- ç”Ÿäº§ç¯å¢ƒ 4 ä¸ªåœºæ™¯éªŒè¯é€šè¿‡
- æ—  JsonSchemaException é”™è¯¯

å‚è€ƒ:
- costq/docs/20260120_filter_expressionåˆ†æ/step6_æ ¹æœ¬åŸå› åˆ†æ.md
- src/billing-cost-management-mcp-server (å‚è€ƒå®ç°)

Closes #filter_expression_issue
```

---

## ğŸ”„ å›æ»šè®¡åˆ’

**å¦‚æœå‡ºç°é—®é¢˜:**

```bash
# 1. ç«‹å³å›æ»šä»£ç 
git log --oneline -5  # æ‰¾åˆ°ä¿®å¤å‰çš„æäº¤
git revert <commit-hash>
git push origin main

# 2. é‡æ–°éƒ¨ç½²
cd costq/scripts
./build_and_push.sh costq-risp-mcp-server

# 3. æ›´æ–° Runtime å’Œåˆ·æ–° Gateway
# (æ‰‹åŠ¨æ“ä½œ,å‚è€ƒéƒ¨ç½²æ–‡æ¡£)
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

1. **å®Œæ•´è°ƒç ”:**
   - `costq/docs/20260120_filter_expressionåˆ†æ/README.md` - è°ƒç ”æ€»è§ˆ
   - `costq/docs/20260120_filter_expressionåˆ†æ/step6_æ ¹æœ¬åŸå› åˆ†æ.md` - æ ¹æœ¬åŸå› 
   - `costq/docs/20260120_filter_expressionåˆ†æ/å®Œæ•´å½±å“èŒƒå›´åˆ†æ.md` - å½±å“èŒƒå›´

2. **ä¿®å¤è®¡åˆ’:**
   - `costq/docs/20260120_filter_expressionåˆ†æ/ä¿®å¤è®¡åˆ’.md` - è¯¦ç»†ä¿®å¤è®¡åˆ’

3. **å‚è€ƒè§„èŒƒ:**
   - `DEVELOPER_GUIDE.md` - å¼€å‘æµç¨‹
   - `DEEPV.md` - ç¼–ç è§„èŒƒ
   - `CODING_STANDARDS.md` - Python ç¼–ç æ ‡å‡†

4. **å‚è€ƒå®ç°:**
   - `src/billing-cost-management-mcp-server/tools/sp_performance_tools.py`
   - `src/billing-cost-management-mcp-server/utilities/aws_service_base.py`

---

**å‡†å¤‡å¼€å§‹æ‰§è¡Œ?** æ‰€æœ‰å‡†å¤‡å·¥ä½œå·²å®Œæˆ,å¯ä»¥å¼€å§‹ Phase 2 ä»£ç ä¿®æ”¹ã€‚
