# MCP Server å¤šè´¦å·æ”¹é€ æ­¥éª¤æŒ‡å—

> æœ¬æ–‡æ¡£æä¾›**è¯¦ç»†çš„ã€å¯æ‰§è¡Œçš„**æ”¹é€ æ­¥éª¤ï¼ŒåŸºäº **cloudtrail-mcp-server** çš„å®é™…æ”¹é€ æ–¹æ¡ˆã€‚

---

## ğŸ¯ å¿«é€Ÿå‚è€ƒï¼šå“ªäº›æ–‡ä»¶å¯ä»¥ç›´æ¥å¤åˆ¶ï¼Ÿ

| æ–‡ä»¶/ç›®å½• | æ˜¯å¦å¯å¤åˆ¶ | éœ€è¦ä¿®æ”¹ | è¯´æ˜ |
|-----------|-----------|---------|------|
| `cred_extract_services/` | âœ… **å¯ç›´æ¥å¤åˆ¶** | âŒ æ— éœ€ä¿®æ”¹ | å®Œå…¨é€šç”¨ï¼Œè‡ªåŒ…å«ï¼Œä¸ä¾èµ–é¡¹ç›®ä»£ç  |
| `Dockerfile-AgentCore-Runtime` | âœ… **å¯ç›´æ¥å¤åˆ¶** | âš ï¸ ä¿®æ”¹ CMD | ä»…éœ€ä¿®æ”¹å¯åŠ¨å‘½ä»¤ä¸­çš„åŒ…å |
| `server.py` ä¸­çš„ `_setup_account_context()` | âœ… **å¯ç›´æ¥å¤åˆ¶** | âŒ æ— éœ€ä¿®æ”¹ | ç»Ÿä¸€è´¦å·ä¸Šä¸‹æ–‡è®¾ç½®å‡½æ•° |
| `costq/scripts/build_*.sh` | âš ï¸ **éœ€è¦ä¿®æ”¹** | âœ… ä¿®æ”¹ 1 å¤„ | ä»…éœ€ä¿®æ”¹ `MCP_SERVER_NAME` å˜é‡ |

**æ€»ç»“**ï¼š
- âœ… **90% çš„æ–‡ä»¶å¯ä»¥ç›´æ¥å¤åˆ¶**ï¼ˆcred_extract_services/ + Dockerfile + _setup_account_contextï¼‰
- âš ï¸ **10% éœ€è¦ç®€å•ä¿®æ”¹**ï¼ˆDockerfile CMDã€éƒ¨ç½²è„šæœ¬ã€FastMCP é…ç½®ï¼‰
- ğŸš€ **æ”¹é€ é€Ÿåº¦æå¿«**ï¼šé¢„è®¡ 15-20 åˆ†é’Ÿå®ŒæˆåŸºç¡€æ”¹é€ 

---

## ğŸ“‹ æ”¹é€ å‰å‡†å¤‡

### 1. ç¡®è®¤æ”¹é€ èŒƒå›´
- [ ] ç¡®è®¤ MCP Server åç§°å’Œè·¯å¾„
- [ ] ç¡®è®¤æ˜¯å¦éœ€è¦å¤šè´¦å·è®¿é—®èƒ½åŠ›
- [ ] å¤‡ä»½åŸå§‹ä»£ç ï¼ˆgit commitï¼‰

### 2. ç¯å¢ƒå‡†å¤‡
```bash
# 1. å®‰è£…ä¾èµ–
cd src/<mcp-server-name>
pip install sqlalchemy cryptography psycopg2-binary

# 2. é…ç½®ç¯å¢ƒå˜é‡ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
cat > .env << EOF
DATABASE_URL=postgresql://user:pass@localhost:5432/costq
ENCRYPTION_KEY=<base64-encoded-fernet-key>
AWS_REGION=us-east-1
EOF
```

---

## ğŸ”§ æ”¹é€ æ­¥éª¤

### Step 1: å¤åˆ¶å‡­è¯æå–æœåŠ¡å±‚ï¼ˆâœ… å¯ç›´æ¥å¤åˆ¶ï¼‰

#### 1.1 åˆ›å»ºç›®å½•å¹¶å¤åˆ¶
```bash
cd src/<mcp-server-name>/

# âœ… ç›´æ¥å¤åˆ¶æ•´ä¸ªç›®å½•ï¼ˆå®Œå…¨é€šç”¨ï¼Œæ— éœ€ä¿®æ”¹ï¼‰
cp -r ../cloudtrail-mcp-server/cred_extract_services ./
```

**ä¸ºä»€ä¹ˆå¯ä»¥ç›´æ¥å¤åˆ¶ï¼Ÿ**
- âœ… å®Œå…¨è‡ªåŒ…å«ï¼Œä¸ä¾èµ–é¡¹ç›®ç‰¹å®šä»£ç 
- âœ… æ²¡æœ‰ç¡¬ç¼–ç çš„é¡¹ç›®åç§°
- âœ… æ‰€æœ‰é…ç½®ä»ç¯å¢ƒå˜é‡è¯»å–
- âœ… å¯ä»¥åœ¨ä»»ä½• MCP Server ä¸­ç›´æ¥ä½¿ç”¨

**åŒ…å«çš„æ–‡ä»¶**ï¼š
```
cred_extract_services/
â”œâ”€â”€ __init__.py           # å…¬å…±æ¥å£å¯¼å‡º
â”œâ”€â”€ aws_client.py         # STS AssumeRoleï¼ˆé€šç”¨ï¼‰
â”œâ”€â”€ context_manager.py    # ç¯å¢ƒå˜é‡ç®¡ç†ï¼ˆé€šç”¨ï¼‰
â”œâ”€â”€ credential_extractor.py  # å‡­è¯æå–æ ¸å¿ƒï¼ˆé€šç”¨ï¼‰
â”œâ”€â”€ crypto.py             # AKSK è§£å¯†ï¼ˆé€šç”¨ï¼‰
â”œâ”€â”€ database.py           # æ•°æ®åº“æŸ¥è¯¢ï¼ˆé€šç”¨ï¼‰
â””â”€â”€ exceptions.py         # è‡ªå®šä¹‰å¼‚å¸¸ï¼ˆé€šç”¨ï¼‰
```

**éªŒè¯**ï¼š
```bash
# æµ‹è¯•å¯¼å…¥
python -c "from cred_extract_services import extract_aws_credentials; print('âœ… å¯¼å…¥æˆåŠŸ')"
```

---

### Step 2: ä¿®æ”¹ server.py

#### 2.1 æ·»åŠ  FastMCP é…ç½®å‚æ•°

**ä¿®æ”¹ FastMCP åˆå§‹åŒ–**ï¼š
```python
# åŸå§‹ä»£ç 
from mcp.server.fastmcp import FastMCP

mcp = FastMCP(
    'awslabs.your-mcp-server',
    instructions='...',
    dependencies=[...]
)
```

**æ”¹é€ å**ï¼š
```python
from mcp.server.fastmcp import FastMCP

# Create FastMCP server for AgentCore Runtime
# AgentCore requires stateless HTTP servers on 0.0.0.0:8000/mcp
mcp = FastMCP(
    name='awslabs.your-mcp-server',  # âœ… ä½¿ç”¨ name= å‚æ•°
    instructions='...',
    dependencies=[
        'boto3',
        'botocore',
        'pydantic',
    ],
    host="0.0.0.0",           # âœ… æ–°å¢ï¼šç›‘å¬åœ°å€
    stateless_http=True       # âœ… æ–°å¢ï¼šæ— çŠ¶æ€ HTTP æ¨¡å¼
)
```

---

#### 2.2 æ·»åŠ å¯¼å…¥å’Œå¼‚å¸¸ç±»å¯¼å‡º

**åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ å¯¼å…¥**ï¼š
```python
import logging

from awslabs.your_mcp_server.tools import YourTools
from mcp.server.fastmcp import FastMCP

# âœ… æ–°å¢ï¼šå¯¼å…¥å‡­è¯æœåŠ¡
from cred_extract_services.context_manager import set_aws_credentials
from cred_extract_services.credential_extractor import extract_aws_credentials
from cred_extract_services.exceptions import (
    AccountNotFoundError,
    AssumeRoleError,
    CredentialDecryptionError,
    CredentialExtractionError,
    DatabaseConnectionError,
)

logger = logging.getLogger(__name__)

# âœ… æ–°å¢ï¼šå¯¼å‡ºå¼‚å¸¸ç±»å’Œå‡½æ•°
__all__ = [
    "_setup_account_context",
    "mcp",
    "main",
    "CredentialExtractionError",
    "AccountNotFoundError",
    "CredentialDecryptionError",
    "AssumeRoleError",
    "DatabaseConnectionError",
]
```

---

#### 2.3 æ·»åŠ  _setup_account_context å‡½æ•°

**åœ¨ mcp åˆå§‹åŒ–ä¹‹åã€main() ä¹‹å‰æ·»åŠ **ï¼š

```python
async def _setup_account_context(
    target_account_id: str,
) -> dict[str, str]:
    """è®¾ç½® AWS å‡­è¯ä¸Šä¸‹æ–‡

    ç»Ÿä¸€å…¥å£å‡½æ•°ï¼Œå®Œæˆä»¥ä¸‹æ“ä½œï¼š
    1. æŸ¥è¯¢è´¦å·ä¿¡æ¯ï¼ˆè‡ªåŒ…å«æ•°æ®åº“æŸ¥è¯¢ï¼‰
    2. æå–å‡­è¯ï¼ˆAKSK è§£å¯† / IAM Role AssumeRoleï¼‰
    3. è®¾ç½®ç¯å¢ƒå˜é‡

    Args:
        target_account_id: AWS è´¦å· ID

    Returns:
        å‡­è¯ä¿¡æ¯å­—å…¸ï¼ˆå·²è„±æ•ï¼‰

    Raises:
        AccountNotFoundError: è´¦å·ä¸å­˜åœ¨
        CredentialDecryptionError: AKSK è§£å¯†å¤±è´¥
        AssumeRoleError: IAM Role AssumeRole å¤±è´¥
        DatabaseConnectionError: æ•°æ®åº“è¿æ¥å¤±è´¥
    """
    logger.info("å¼€å§‹è®¾ç½® AWS å‡­è¯ä¸Šä¸‹æ–‡")

    # 1. æå–å‡­è¯
    credentials = await extract_aws_credentials(target_account_id)

    # 2. è®¾ç½®ç¯å¢ƒå˜é‡
    set_aws_credentials(
        access_key_id=credentials["access_key_id"],
        secret_access_key=credentials["secret_access_key"],
        session_token=credentials.get("session_token"),
        region=credentials["region"],
    )

    # 3. è¿”å›è„±æ•ä¿¡æ¯
    cred_info = {
        "account_id": credentials["account_id"],
        "account_alias": credentials.get("alias", "Unknown"),
        "auth_type": credentials["auth_type"],
        "region": credentials["region"],
    }

    logger.info(f"âœ… AWS å‡­è¯ä¸Šä¸‹æ–‡è®¾ç½®å®Œæˆ: {cred_info}")
    return cred_info
```

**ğŸ’¡ è¿™ä¸ªå‡½æ•°å¯ä»¥ç›´æ¥ä» cloudtrail-mcp-server å¤åˆ¶ï¼Œæ— éœ€ä¿®æ”¹ï¼**

---

#### 2.4 ä¿®æ”¹ main() å‡½æ•°

```python
# åŸå§‹ä»£ç 
def main():
    mcp.run()
```

**æ”¹é€ å**ï¼š
```python
def main():
    """Run the MCP server with streamable HTTP transport for AgentCore."""
    # AgentCore Runtime expects servers to run with streamable-http transport
    mcp.run(transport="streamable-http")

if __name__ == '__main__':
    main()
```

---

#### 2.5 éªŒè¯ server.py ä¿®æ”¹

```bash
# æ£€æŸ¥ FastMCP é…ç½®
grep -A 5 "FastMCP(" awslabs/*/server.py

# æ£€æŸ¥ _setup_account_context å‡½æ•°
grep -A 3 "_setup_account_context" awslabs/*/server.py

# æ£€æŸ¥ main() å‡½æ•°
grep -A 3 "def main" awslabs/*/server.py
```

---

### Step 3: ä¿®æ”¹æ‰€æœ‰ Tool å‡½æ•°

#### 3.1 å®šä½æ‰€æœ‰ Tool æ–‡ä»¶
```bash
# æŸ¥æ‰¾æ‰€æœ‰ tool æ–‡ä»¶
find awslabs -name "*_tools.py" -type f
```

#### 3.2 å‚æ•°é¡ºåºè§„åˆ™ âš ï¸ é‡è¦

**ğŸ¯ æ ¸å¿ƒè§„åˆ™ï¼š`target_account_id` å¿…é¡»æ”¾åœ¨æ‰€æœ‰å¿…éœ€å‚æ•°ä¹‹åã€å…¶ä»–å¯é€‰å‚æ•°ä¹‹å‰**

```python
# âœ… æ­£ç¡®çš„å‚æ•°é¡ºåº
async def tool_function(
    ctx: Context,                             # 1. MCP Contextï¼ˆå¿…éœ€ï¼‰
    required_param: str,                      # 2. ä¸šåŠ¡å¿…éœ€å‚æ•°
    target_account_id: Optional[str] = None,  # 3. â­ target_account_idï¼ˆç¬¬ä¸€ä¸ªå¯é€‰å‚æ•°ï¼‰
    optional_param: Optional[int] = None,     # 4. å…¶ä»–å¯é€‰å‚æ•°
):

# âŒ é”™è¯¯ç¤ºä¾‹ 1ï¼štarget_account_id åœ¨å¿…éœ€å‚æ•°ä¹‹å‰
async def tool_function(
    ctx: Context,
    target_account_id: Optional[str] = None,  # âŒ é”™è¯¯ï¼
    required_param: str,                      # Python ä¸å…è®¸å¿…éœ€å‚æ•°åœ¨å¯é€‰å‚æ•°åé¢
):

# âŒ é”™è¯¯ç¤ºä¾‹ 2ï¼štarget_account_id åœ¨å…¶ä»–å¯é€‰å‚æ•°ä¹‹å
async def tool_function(
    ctx: Context,
    required_param: str,
    optional_param: Optional[int] = None,
    target_account_id: Optional[str] = None,  # âŒ ä¸è§„èŒƒï¼Œåº”è¯¥æ”¾åœ¨ç¬¬ä¸€ä¸ª
):
```

---

#### 3.3 æ ‡å‡†æ”¹é€ æ¨¡æ¿

**æ”¹é€ å‰**ï¼š
```python
@server.tool(name="tool-name", description="...")
async def tool_function(
    ctx: Context,
    param1: str,                     # å¿…éœ€å‚æ•°
    param2: Optional[int] = None,    # å¯é€‰å‚æ•°
) -> Dict[str, Any]:
    try:
        # ä¸šåŠ¡é€»è¾‘
        client = create_aws_client("service", "region")
        response = client.some_api_call(param1=param1)
        return format_response("success", response)
    except Exception as e:
        return await handle_aws_error(ctx, e, "operation", "Service")
```

**æ”¹é€ å**ï¼š
```python
# 1. å¯¼å…¥å¼‚å¸¸ç±»ï¼ˆæ–‡ä»¶é¡¶éƒ¨ï¼‰
from awslabs.your_mcp_server.server import (
    _setup_account_context,
    AccountNotFoundError,
    CredentialDecryptionError,
    AssumeRoleError,
    DatabaseConnectionError,
)

@server.tool(name="tool-name", description="...")
async def tool_function(
    ctx: Context,
    param1: str,                              # å¿…éœ€å‚æ•°ï¼ˆä¿æŒåŸä½ç½®ï¼‰
    target_account_id: Optional[str] = None,  # âœ… æ–°å¢ï¼šç¬¬ä¸€ä¸ªå¯é€‰å‚æ•°
    param2: Optional[int] = None,             # å¯é€‰å‚æ•°ï¼ˆä¿æŒåŸä½ç½®ï¼‰
) -> Dict[str, Any]:
    try:
        # ===== è´¦å·ä¸Šä¸‹æ–‡åˆå§‹åŒ– =====
        if target_account_id:
            await _setup_account_context(target_account_id)

        # ===== åŸæœ‰é€»è¾‘ï¼ˆå®Œå…¨ä¸å˜ï¼‰=====
        client = create_aws_client("service", "region")
        response = client.some_api_call(param1=param1)
        return format_response("success", response)

    # ===== å¼‚å¸¸å¤„ç† =====
    except AccountNotFoundError:
        return format_response('error', {'error_type': 'account_not_found'},
                               'Account not found. Please check the account ID.')
    except CredentialDecryptionError:
        return format_response('error', {'error_type': 'credential_error'},
                               'Failed to decrypt credentials. Please contact administrator.')
    except AssumeRoleError:
        return format_response('error', {'error_type': 'assume_role_error'},
                               'Failed to assume role. Please check IAM role configuration.')
    except DatabaseConnectionError:
        return format_response('error', {'error_type': 'database_error'},
                               'Database connection failed. Please try again later.')
    except Exception as e:
        return await handle_aws_error(ctx, e, "operation", "Service")
```

---

#### 3.4 æ‰¹é‡ä¿®æ”¹è¾…åŠ©è„šæœ¬ï¼ˆä»…ä¾›å‚è€ƒï¼‰

**âš ï¸ è­¦å‘Š**ï¼šè‡ªåŠ¨åŒ–è„šæœ¬å¯èƒ½æ— æ³•å¤„ç†æ‰€æœ‰è¾¹ç•Œæƒ…å†µï¼Œ**å¿…é¡»äººå·¥å®¡æŸ¥æ¯ä¸ªä¿®æ”¹**

```python
# scripts/add_target_account_id.py
import re
import sys
from pathlib import Path

def add_target_account_id_param(file_path: Path, package_name: str):
    """ç»™ tool å‡½æ•°æ·»åŠ  target_account_id å‚æ•°"""
    content = file_path.read_text()

    # 1. æ·»åŠ å¯¼å…¥ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    import_block = f"""
from awslabs.{package_name}.server import (
    _setup_account_context,
    AccountNotFoundError,
    CredentialDecryptionError,
    AssumeRoleError,
    DatabaseConnectionError,
)
"""
    if "_setup_account_context" not in content:
        # åœ¨æœ€åä¸€ä¸ª import åæ·»åŠ 
        lines = content.split('\n')
        last_import_idx = 0
        for i, line in enumerate(lines):
            if line.startswith('import ') or line.startswith('from '):
                last_import_idx = i
        lines.insert(last_import_idx + 1, import_block)
        content = '\n'.join(lines)

    # 2. ä¿®æ”¹å‡½æ•°ç­¾åï¼ˆæ·»åŠ  target_account_idï¼‰
    # æ¨¡å¼ï¼šasync def function_name(ctx: Context, ...
    # æ³¨æ„ï¼šè¿™åªæ˜¯ç®€å•ç¤ºä¾‹ï¼Œå®é™…éœ€è¦æ›´å¤æ‚çš„é€»è¾‘
    pattern = r'(async def \w+\(\s*ctx:\s*Context,)'
    replacement = r'\1\n    target_account_id: Optional[str] = None,'
    content = re.sub(pattern, replacement, content)

    # 3. æ·»åŠ è´¦å·ä¸Šä¸‹æ–‡åˆå§‹åŒ–ä»£ç 
    context_init = """
        # ===== Account context initialization =====
        if target_account_id:
            await _setup_account_context(target_account_id)

        # ===== Original logic (unchanged) =====
"""
    content = content.replace("    try:\n", f"    try:\n{context_init}")

    # ä¿å­˜ä¿®æ”¹
    file_path.write_text(content)
    print(f"âœ… Modified: {file_path}")


if __name__ == "__main__":
    if len(sys.argv) < 3:
        print("Usage: python add_target_account_id.py <package_name> <tool_file.py>")
        sys.exit(1)

    package_name = sys.argv[1]
    for file_path in sys.argv[2:]:
        add_target_account_id_param(Path(file_path), package_name)
```

**ä½¿ç”¨è„šæœ¬**ï¼š
```bash
# ä¿®æ”¹å•ä¸ªæ–‡ä»¶
python scripts/add_target_account_id.py your_mcp_server awslabs/.../tools/example_tools.py

# æ‰¹é‡ä¿®æ”¹ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
find awslabs -name "*_tools.py" -exec python scripts/add_target_account_id.py your_mcp_server {} \;
```

**âš ï¸ å»ºè®®**ï¼š
- å…ˆåœ¨æµ‹è¯•æ–‡ä»¶ä¸ŠéªŒè¯
- **å¿…é¡»äººå·¥å®¡æŸ¥æ¯ä¸ªä¿®æ”¹**
- å»ºè®®æ‰‹åŠ¨ä¿®æ”¹ï¼ˆæ›´å®‰å…¨ï¼‰

---

### Step 4: æ›´æ–° Tool æè¿°æ–‡æ¡£

#### 4.1 æ·»åŠ å‚æ•°è¯´æ˜
åœ¨æ¯ä¸ª tool çš„ `description` ä¸­æ·»åŠ ï¼š
```python
@server.tool(
    name="tool-name",
    description="""Tool description...

    Args:
        ctx: The MCP context object
        target_account_id: Target AWS account ID. If not provided, use default credentials.
        # ... å…¶ä»–å‚æ•°

    Returns:
        Dict containing the response data
    """
)
```

#### 4.2 æ·»åŠ ä½¿ç”¨ç¤ºä¾‹
```markdown
## ä½¿ç”¨ç¤ºä¾‹

### 1. ä½¿ç”¨é»˜è®¤å‡­è¯
```json
{
  "tool": "tool-name",
  "params": {
    "param1": "value1"
  }
}
```

### 2. ä½¿ç”¨ç›®æ ‡è´¦å·å‡­è¯
```json
{
  "tool": "tool-name",
  "params": {
    "target_account_id": "123456789012",
    "param1": "value1"
  }
}
```
```

---

### Step 4.5: æ£€æŸ¥å¹¶ç»Ÿä¸€æ—¥å¿—åº“ï¼ˆé‡è¦ï¼‰âš ï¸

#### 4.5.1 ä¸ºä»€ä¹ˆéœ€è¦ç»Ÿä¸€æ—¥å¿—åº“ï¼Ÿ

**é—®é¢˜**ï¼šæ··ç”¨ `loguru` å’Œ `logging` ä¼šå¯¼è‡´ï¼š
- âŒ **OpenTelemetry æ— æ³•æ•è· loguru æ—¥å¿—**
- âŒ **ç¼ºå°‘ trace ID å’Œ span ID**ï¼ˆæ— æ³•è¿½è¸ªè¯·æ±‚é“¾è·¯ï¼‰
- âŒ **CloudWatch æ—¥å¿—ä¸å®Œæ•´**ï¼ˆloguru çš„æ—¥å¿—åªé€šè¿‡ stderr è¾“å‡ºï¼Œæ²¡æœ‰ç»“æ„åŒ–ä¿¡æ¯ï¼‰
- âŒ **æ—¥å¿—æ ¼å¼ä¸ä¸€è‡´**ï¼ˆéš¾ä»¥ç»Ÿä¸€åˆ†æï¼‰

**æ£€æŸ¥æ–¹æ³•**ï¼š
```bash
# æŸ¥æ‰¾é¡¹ç›®ä¸­æ˜¯å¦ä½¿ç”¨ loguru
cd src/<mcp-server-name>/
grep -r "from loguru" awslabs/ --include="*.py"

# å¦‚æœæ‰¾åˆ°ï¼Œéœ€è¦è¿ç§»åˆ° logging
```

---

#### 4.5.2 è¿ç§»æ­¥éª¤

**Step 1: ä¿®æ”¹å¯¼å…¥è¯­å¥**
```python
# ä¿®æ”¹å‰ï¼ˆtools.py æˆ–å…¶ä»–æ–‡ä»¶ï¼‰
from loguru import logger

# ä¿®æ”¹å
import logging
logger = logging.getLogger(__name__)
```

**Step 2: ç§»é™¤ loguru ä¾èµ–**
```toml
# pyproject.toml
[project]
dependencies = [
    "boto3>=1.38.22",
    # "loguru>=0.7.0",  # âŒ åˆ é™¤æ­¤è¡Œ
    "mcp[cli]>=1.23.0",
    "pydantic>=2.10.6",
]
```

**Step 3: æ›´æ–° FastMCP ä¾èµ–å£°æ˜**ï¼ˆå¦‚æœæœ‰ï¼‰
```python
# server.py
mcp = FastMCP(
    name='awslabs.xxx-mcp-server',
    dependencies=[
        'boto3',
        'botocore',
        'pydantic',
        # 'loguru',  # âŒ åˆ é™¤æ­¤è¡Œ
    ],
    ...
)
```

**Step 4: éªŒè¯ä¿®æ”¹**
```bash
# ç¡®è®¤æ²¡æœ‰ loguru å¼•ç”¨
grep -r "loguru" . --include="*.py" --include="*.toml" || echo "âœ… æ²¡æœ‰æ‰¾åˆ° loguru å¼•ç”¨"

# è¯­æ³•æ£€æŸ¥
python3 -m py_compile awslabs/**/*.py
```

---

#### 4.5.3 æ—¥å¿—æ–¹æ³•å…¼å®¹æ€§

**å¥½æ¶ˆæ¯**ï¼š`logging` å’Œ `loguru` çš„åŸºç¡€ API å®Œå…¨å…¼å®¹ï¼Œæ— éœ€ä¿®æ”¹æ—¥å¿—è°ƒç”¨ä»£ç ï¼

```python
# ä»¥ä¸‹ä»£ç åœ¨ä¸¤ä¸ªåº“ä¸­éƒ½å¯ä»¥æ­£å¸¸å·¥ä½œ
logger.info(f"æ¶ˆæ¯: {å˜é‡}")
logger.error(f"é”™è¯¯: {str(e)}")
logger.warning(f"è­¦å‘Š: {å†…å®¹}")
logger.debug(f"è°ƒè¯•: {æ•°æ®}")
```

**æ³¨æ„**ï¼šå¦‚æœä½¿ç”¨äº† loguru ç‰¹æœ‰åŠŸèƒ½ï¼Œéœ€è¦è°ƒæ•´ï¼š
```python
# âŒ loguru ç‰¹æœ‰è¯­æ³•ï¼ˆéœ€è¦æ”¹ï¼‰
logger.opt(exception=True).error("é”™è¯¯")
logger.bind(request_id=123).info("æ¶ˆæ¯")
logger.catch()(my_function)

# âœ… logging ç­‰æ•ˆå†™æ³•
logger.error("é”™è¯¯", exc_info=True)
logger.info("æ¶ˆæ¯", extra={"request_id": 123})
# ä½¿ç”¨æ ‡å‡†å¼‚å¸¸å¤„ç†æ›¿ä»£ @logger.catch()
```

---

#### 4.5.4 è¿ç§»åçš„ä¼˜åŠ¿

| æ”¹è¿›é¡¹ | loguru | logging | æå‡ |
|--------|--------|---------|------|
| **OpenTelemetry é›†æˆ** | âŒ | âœ… | â­â­â­â­â­ |
| **Trace ID** | âŒ | âœ… | â­â­â­â­â­ |
| **Span ID** | âŒ | âœ… | â­â­â­â­â­ |
| **CloudWatch å®Œæ•´æ€§** | âš ï¸ éƒ¨åˆ† | âœ… å®Œæ•´ | â­â­â­â­ |
| **è¯·æ±‚é“¾è·¯è¿½è¸ª** | âŒ | âœ… | â­â­â­â­â­ |
| **æ—¥å¿—ç³»ç»Ÿç»Ÿä¸€** | âŒ | âœ… | â­â­â­â­ |

**CloudWatch æ—¥å¿—å¯¹æ¯”**ï¼š
```json
// âŒ loguruï¼ˆç¼ºå°‘è¿½è¸ªä¿¡æ¯ï¼‰
"2026-01-19 12:00:00.123 | INFO | tools:lookup_events:180 - å¼€å§‹æŸ¥è¯¢"

// âœ… logging + OpenTelemetryï¼ˆå®Œæ•´è¿½è¸ªï¼‰
{
  "timestamp": "2026-01-19T12:00:00.123Z",
  "level": "INFO",
  "logger": "awslabs.xxx_mcp_server.tools",
  "message": "å¼€å§‹æŸ¥è¯¢",
  "trace_id": "1-abc123",  // âœ… å¯è¿½è¸ªè¯·æ±‚
  "span_id": "xyz789"      // âœ… å¯è¿½è¸ªå‡½æ•°è°ƒç”¨
}
```

---

#### 4.5.5 å¿«é€Ÿè¿ç§»æ£€æŸ¥æ¸…å•

- [ ] æŸ¥æ‰¾æ‰€æœ‰ `from loguru import` å¼•ç”¨
- [ ] æ›¿æ¢ä¸º `import logging` + `logger = logging.getLogger(__name__)`
- [ ] ä» `pyproject.toml` ç§»é™¤ `loguru` ä¾èµ–
- [ ] ä» `server.py` FastMCP ä¾èµ–ç§»é™¤ `loguru`
- [ ] æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº† loguru ç‰¹æœ‰è¯­æ³•ï¼ˆéœ€è¦è°ƒæ•´ï¼‰
- [ ] éªŒè¯è¯­æ³•å’Œå¯¼å…¥æ­£ç¡®æ€§
- [ ] é‡æ–°æ„å»ºé•œåƒ

**å‚è€ƒæ–‡æ¡£**ï¼š`costq/docs/20260118_CloudTrail_MCPé—®é¢˜/20250119_loguru_è¿ç§»åˆ°_logging.md`

---

## âœ… æ”¹é€ éªŒè¯

### 1. å•å…ƒæµ‹è¯•
```python
# tests/test_account_context.py
import pytest
from awslabs.your_mcp_server.server import _setup_account_context
from awslabs.your_mcp_server.server import AccountNotFoundError

@pytest.mark.asyncio
async def test_setup_account_context_aksk():
    """æµ‹è¯• AKSK è´¦å·å‡­è¯è®¾ç½®"""
    result = await _setup_account_context("test-aksk-account-id")
    assert result["auth_type"] == "aksk"
    assert result["account_id"] is not None

@pytest.mark.asyncio
async def test_setup_account_context_iam_role():
    """æµ‹è¯• IAM Role è´¦å·å‡­è¯è®¾ç½®"""
    result = await _setup_account_context("test-role-account-id")
    assert result["auth_type"] == "iam_role"
    assert result["account_id"] is not None

@pytest.mark.asyncio
async def test_setup_account_context_not_found():
    """æµ‹è¯•è´¦å·ä¸å­˜åœ¨å¼‚å¸¸"""
    with pytest.raises(AccountNotFoundError):
        await _setup_account_context("non-existent-account")
```

### 2. æœ¬åœ°æµ‹è¯•
```bash
# å¯åŠ¨ MCP Server
python -m awslabs.your_mcp_server.server

# é¢„æœŸè¾“å‡º
INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
```

### 3. æ‰‹åŠ¨éªŒè¯æ¸…å•
- [ ] AKSK è´¦å·å‡­è¯æ­£å¸¸
- [ ] IAM Role è´¦å·å‡­è¯æ­£å¸¸
- [ ] External ID æ­£ç¡®ä¼ é€’
- [ ] Session Token å¤„ç†æ­£å¸¸
- [ ] å¤šè´¦å·åˆ‡æ¢æ­£å¸¸
- [ ] é»˜è®¤å‡­è¯ï¼ˆæ—  target_account_idï¼‰æ­£å¸¸
- [ ] æ‰€æœ‰å¼‚å¸¸å¤„ç†æ­£å¸¸
- [ ] æ—¥å¿—ä¸åŒ…å«æ•æ„Ÿä¿¡æ¯

---

## ğŸ³ Docker é•œåƒæ„å»ºå’Œéƒ¨ç½²

### Step 5: åˆ›å»º Dockerfile-AgentCore-Runtime

#### 5.1 ç›´æ¥å¤åˆ¶ Dockerfile

```bash
cd src/<mcp-server-name>/

# âœ… ç›´æ¥å¤åˆ¶
cp ../cloudtrail-mcp-server/Dockerfile-AgentCore-Runtime ./
```

#### 5.2 ä¿®æ”¹å¯åŠ¨å‘½ä»¤

**ä¿®æ”¹ Dockerfile æœ€åä¸€è¡Œçš„ CMD**ï¼š

```dockerfile
# åŸå§‹ï¼ˆcloudtrailï¼‰
CMD ["opentelemetry-instrument", "python", "-m", "awslabs.cloudtrail_mcp_server.server"]

# ä¿®æ”¹ä¸ºä½ çš„åŒ…å
CMD ["opentelemetry-instrument", "python", "-m", "awslabs.your_mcp_server.server"]
```

**å¿«é€Ÿä¿®æ”¹è„šæœ¬**ï¼š
```bash
# è‡ªåŠ¨ä¿®æ”¹ CMDï¼ˆmacOSï¼‰
sed -i '' 's/awslabs\.cloudtrail_mcp_server/awslabs.your_mcp_server/' Dockerfile-AgentCore-Runtime

# éªŒè¯ä¿®æ”¹
grep "CMD" Dockerfile-AgentCore-Runtime
```

---

#### 5.3 Dockerfile å…³é”®å†…å®¹

**å·²åŒ…å«çš„é‡è¦é…ç½®**ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰ï¼š

1. **å¤åˆ¶å‡­è¯æœåŠ¡**ï¼š
   ```dockerfile
   COPY --chown=app:app ./cred_extract_services /app/cred_extract_services
   ```

2. **å®‰è£…é¢å¤–ä¾èµ–**ï¼š
   ```dockerfile
   RUN pip install --no-cache-dir uv && \
       uv pip install --python /app/.venv/bin/python \
       aws-opentelemetry-distro==0.12.2 \
       sqlalchemy>=2.0.0 \
       psycopg2-binary>=2.9.0 \
       cryptography>=41.0.0
   ```

3. **æš´éœ²ç«¯å£**ï¼š
   ```dockerfile
   EXPOSE 9000
   EXPOSE 8000
   EXPOSE 8080
   ```

4. **ç¯å¢ƒå˜é‡**ï¼š
   ```dockerfile
   ENV UV_SYSTEM_PYTHON=1 \
       UV_NO_PROGRESS=1 \
       DOCKER_CONTAINER=1 \
       AWS_REGION=ap-northeast-1 \
       AWS_DEFAULT_REGION=ap-northeast-1
   ```

---

### Step 6: æ„å»ºå’Œæ¨é€é•œåƒ

#### 6.1 ä½¿ç”¨é€šç”¨éƒ¨ç½²è„šæœ¬ï¼ˆæ¨èâ­ï¼‰

```bash
# ä»é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
bash costq/scripts/build_and_push_template.sh <mcp-server-name>

# ç¤ºä¾‹
bash costq/scripts/build_and_push_template.sh your-mcp-server
```

**è„šæœ¬ä¼šè‡ªåŠ¨**ï¼š
1. âœ… ç™»å½• ECR
2. âœ… æ„å»º ARM64 é•œåƒ
3. âœ… æ‰“æ ‡ç­¾ï¼ˆ`latest` + æ—¶é—´æˆ³ï¼‰
4. âœ… æ¨é€åˆ° ECR

---

#### 6.2 æ‰‹åŠ¨æ„å»ºï¼ˆå¯é€‰ï¼‰

**å¦‚æœä¸ä½¿ç”¨è„šæœ¬ï¼Œå¯ä»¥æ‰‹åŠ¨æ‰§è¡Œ**ï¼š

```bash
cd src/<mcp-server-name>/

# 1. ç™»å½• ECR
aws ecr get-login-password --region ap-northeast-1 --profile 3532 | \
  docker login --username AWS --password-stdin <account-id>.dkr.ecr.ap-northeast-1.amazonaws.com

# 2. æ„å»ºé•œåƒ
docker buildx build \
  --platform linux/arm64 \
  -f Dockerfile-AgentCore-Runtime \
  -t <ecr-url>/<mcp-server-name>:latest \
  --load \
  .

# 3. æ¨é€é•œåƒ
docker push <ecr-url>/<mcp-server-name>:latest
```

---

### Step 7: æ›´æ–° Runtime å’ŒéªŒè¯

#### 7.1 æ›´æ–° Runtime
```bash
# ä½¿ç”¨ AWS CLI æ›´æ–°
aws bedrock-agentcore-control update-runtime \
  --profile 3532 \
  --region ap-northeast-1 \
  --runtime-identifier <runtime-id> \
  --container-image <ecr-url>/<mcp-server-name>:latest
```

#### 7.2 åˆ·æ–° Gateway
âš ï¸ **é‡è¦**ï¼šæŒ‰ç…§ DEEPV.md è¯´æ˜ï¼Œéœ€è¦æ‰‹åŠ¨åˆ·æ–° Gateway

#### 7.3 éªŒè¯éƒ¨ç½²

```bash
# æŸ¥çœ‹æ—¥å¿—
kubectl logs -f -n costq-fastapi deployment/costq-fastapi

# éªŒè¯å¥åº·æ£€æŸ¥
curl http://<gateway-url>/health

# æµ‹è¯• API
curl -X POST http://<gateway-url>/mcp \
  -H "Content-Type: application/json" \
  -d '{"method": "tools/list"}'
```

---

## ğŸ› å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜ 1: ModuleNotFoundError: No module named 'cred_extract_services'
**åŸå› **ï¼šæœªæ­£ç¡®å¤åˆ¶ cred_extract_services ç›®å½•

**è§£å†³**ï¼š
```bash
# ç¡®è®¤ç›®å½•å­˜åœ¨
ls -la cred_extract_services/

# é‡æ–°å¤åˆ¶
cp -r ../cloudtrail-mcp-server/cred_extract_services ./
```

### é—®é¢˜ 2: DatabaseConnectionError
**åŸå› **ï¼šæ•°æ®åº“é…ç½®é”™è¯¯

**è§£å†³**ï¼š
```bash
# æ£€æŸ¥ç¯å¢ƒå˜é‡
echo $DATABASE_URL
echo $RDS_SECRET_NAME

# æµ‹è¯•æ•°æ®åº“è¿æ¥
python -c "
from cred_extract_services.database import query_account
import asyncio
result = asyncio.run(query_account('test-account-id'))
print(result)
"
```

### é—®é¢˜ 3: CredentialDecryptionError
**åŸå› **ï¼šåŠ å¯†å¯†é’¥é”™è¯¯

**è§£å†³**ï¼š
```bash
# æ£€æŸ¥åŠ å¯†å¯†é’¥
echo $ENCRYPTION_KEY | base64 -d | xxd  # åº”è¯¥æ˜¯ 32 å­—èŠ‚

# é‡æ–°ç”Ÿæˆå¯†é’¥ï¼ˆä»…æµ‹è¯•ç¯å¢ƒï¼‰
python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"
```

### é—®é¢˜ 4: AssumeRoleError
**åŸå› **ï¼šIAM Role é…ç½®é”™è¯¯

**è§£å†³**ï¼š
```bash
# æ£€æŸ¥ Role ARN å’Œ External ID
python -c "
from cred_extract_services.database import query_account
import asyncio
account = asyncio.run(query_account('test-role-account-id'))
print(f'Role ARN: {account[\"role_arn\"]}')
print(f'External ID: {account[\"external_id\"]}')
"

# æµ‹è¯• AssumeRole
aws sts assume-role \
  --role-arn <role-arn> \
  --role-session-name test \
  --external-id <external-id>
```

### é—®é¢˜ 5: å¯åŠ¨åæ— æ³•è¿æ¥ï¼ˆ127.0.0.1:8000ï¼‰
**åŸå› **ï¼šFastMCP æœªé…ç½® `host="0.0.0.0"`

**è§£å†³**ï¼š
```python
# æ£€æŸ¥ server.py
mcp = FastMCP(
    name='awslabs.your-mcp-server',
    host="0.0.0.0",  # âœ… å¿…é¡»ï¼
    stateless_http=True
)
```

---

## ğŸ“ æ”¹é€ æ£€æŸ¥æ¸…å•

### ä»£ç ä¿®æ”¹
- [ ] å¤åˆ¶ `cred_extract_services/` ç›®å½•
- [ ] ä¿®æ”¹ `server.py` FastMCP é…ç½®ï¼ˆæ·»åŠ  `host` å’Œ `stateless_http`ï¼‰
- [ ] æ·»åŠ  `_setup_account_context()` å‡½æ•°åˆ° `server.py`
- [ ] ä¿®æ”¹æ‰€æœ‰ tool å‡½æ•°ï¼ˆæ·»åŠ  `target_account_id` å‚æ•°ï¼‰
- [ ] æ·»åŠ è´¦å·ä¸Šä¸‹æ–‡åˆå§‹åŒ–ä»£ç 
- [ ] æ·»åŠ å¼‚å¸¸å¤„ç†
- [ ] æ›´æ–° tool æè¿°æ–‡æ¡£

### æµ‹è¯•éªŒè¯
- [ ] å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] æœ¬åœ°å¯åŠ¨æµ‹è¯•é€šè¿‡
- [ ] æ‰‹åŠ¨éªŒè¯é€šè¿‡
- [ ] å¼‚å¸¸å¤„ç†éªŒè¯é€šè¿‡

### Docker éƒ¨ç½²
- [ ] å¤åˆ¶ `Dockerfile-AgentCore-Runtime`
- [ ] ä¿®æ”¹ CMD å¯åŠ¨å‘½ä»¤
- [ ] æ„å»ºé•œåƒæˆåŠŸ
- [ ] æ¨é€åˆ° ECR æˆåŠŸ
- [ ] æ›´æ–° Runtime æˆåŠŸ
- [ ] åˆ·æ–° Gateway

### æ–‡æ¡£æ›´æ–°
- [ ] README æ›´æ–°
- [ ] API æ–‡æ¡£æ›´æ–°
- [ ] ä½¿ç”¨ç¤ºä¾‹æ›´æ–°

---

## ğŸ‰ æ”¹é€ å®Œæˆ

æ­å–œï¼ä½ å·²ç»å®Œæˆäº† MCP Server çš„å¤šè´¦å·æ”¹é€ ã€‚

**ä¸‹ä¸€æ­¥**ï¼š
1. æäº¤ä»£ç åˆ° Git
2. æ›´æ–°é¡¹ç›®æ–‡æ¡£
3. é€šçŸ¥å›¢é˜Ÿæˆå‘˜æ–°åŠŸèƒ½

**å‚è€ƒèµ„æ–™**ï¼š
- [æ”¹é€ éœ€æ±‚åˆ†æ](./01_æ”¹é€ éœ€æ±‚åˆ†æ.md)
- [CloudTrail MCP Server æºç ](../../src/cloudtrail-mcp-server/)
- [æ—¥å¿—è¿ç§»æŒ‡å—](../20260118_CloudTrail_MCPé—®é¢˜/20250119_loguru_è¿ç§»åˆ°_logging.md)