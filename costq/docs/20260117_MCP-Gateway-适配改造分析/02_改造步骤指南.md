# MCP Server å¤šè´¦å·æ”¹é€ æ­¥éª¤æŒ‡å—

> æœ¬æ–‡æ¡£æä¾›**è¯¦ç»†çš„ã€å¯æ‰§è¡Œçš„**æ”¹é€ æ­¥éª¤ï¼ŒåŸºäº **cloudtrail-mcp-server** çš„å®é™…æ”¹é€ æ–¹æ¡ˆã€‚

---

## ğŸ¯ å¿«é€Ÿå‚è€ƒï¼šå“ªäº›æ–‡ä»¶å¯ä»¥ç›´æ¥å¤åˆ¶ï¼Ÿ

| æ–‡ä»¶/ç›®å½• | æ˜¯å¦å¯å¤åˆ¶ | éœ€è¦ä¿®æ”¹ | è¯´æ˜ |
|-----------|-----------|---------|------|
| `cred_extract_services/` | âœ… **å¯ç›´æ¥å¤åˆ¶** | âŒ æ— éœ€ä¿®æ”¹ | å®Œå…¨é€šç”¨ï¼Œè‡ªåŒ…å«ï¼Œä¸ä¾èµ–é¡¹ç›®ä»£ç  |
| `Dockerfile-AgentCore-Runtime` | âœ… **å¯ç›´æ¥å¤åˆ¶** | âš ï¸ ä¿®æ”¹ CMD | ä»…éœ€ä¿®æ”¹å¯åŠ¨å‘½ä»¤ä¸­çš„åŒ…å |
| `server.py` ä¸­çš„ `_setup_account_context()` | âœ… **å¯ç›´æ¥å¤åˆ¶** | âŒ æ— éœ€ä¿®æ”¹ | ç»Ÿä¸€è´¦å·ä¸Šä¸‹æ–‡è®¾ç½®å‡½æ•° |
| `costq/scripts/build_*.sh` | âš ï¸ **éœ€è¦ä¿®æ”¹** | âœ… ä¿®æ”¹ 1 å¤„ | ä»…éœ€ä¿®æ”¹ `MCP_SERVER_NAME` å˜é‡ |

**æ€»ç»“**ï¼š
- âœ… **90% çš„æ–‡ä»¶å¯ä»¥ç›´æ¥å¤åˆ¶**ï¼ˆcred_extract_services/ + Dockerfile + _setup_account_contextï¼‰
- âš ï¸ **10% éœ€è¦ç®€å•ä¿®æ”¹**ï¼ˆDockerfile CMDã€éƒ¨ç½²è„šæœ¬ã€FastMCP é…ç½®ï¼‰
- ğŸš€ **æ”¹é€ é€Ÿåº¦æå¿«**ï¼šé¢„è®¡ 15-20 åˆ†é’Ÿå®ŒæˆåŸºç¡€æ”¹é€ 

---

## ğŸ“‹ æ”¹é€ å‰å‡†å¤‡

### 1. ç¡®è®¤æ”¹é€ èŒƒå›´
- [ ] ç¡®è®¤ MCP Server åç§°å’Œè·¯å¾„
- [ ] ç¡®è®¤æ˜¯å¦éœ€è¦å¤šè´¦å·è®¿é—®èƒ½åŠ›
- [ ] å¤‡ä»½åŸå§‹ä»£ç ï¼ˆgit commitï¼‰

### 2. ç¯å¢ƒå‡†å¤‡
```bash
# 1. å®‰è£…ä¾èµ–
cd src/<mcp-server-name>
pip install sqlalchemy cryptography psycopg2-binary

# 2. é…ç½®ç¯å¢ƒå˜é‡ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
cat > .env << EOF
DATABASE_URL=postgresql://user:pass@localhost:5432/costq
ENCRYPTION_KEY=<base64-encoded-fernet-key>
AWS_REGION=us-east-1
EOF
```

---

## ğŸ”§ æ”¹é€ æ­¥éª¤

### Step 1: å¤åˆ¶å‡­è¯æå–æœåŠ¡å±‚ï¼ˆâœ… å¯ç›´æ¥å¤åˆ¶ï¼‰

#### 1.1 åˆ›å»ºç›®å½•å¹¶å¤åˆ¶
```bash
cd src/<mcp-server-name>/

# âœ… ç›´æ¥å¤åˆ¶æ•´ä¸ªç›®å½•ï¼ˆå®Œå…¨é€šç”¨ï¼Œæ— éœ€ä¿®æ”¹ï¼‰
cp -r ../cloudtrail-mcp-server/cred_extract_services ./
```

**ä¸ºä»€ä¹ˆå¯ä»¥ç›´æ¥å¤åˆ¶ï¼Ÿ**
- âœ… å®Œå…¨è‡ªåŒ…å«ï¼Œä¸ä¾èµ–é¡¹ç›®ç‰¹å®šä»£ç 
- âœ… æ²¡æœ‰ç¡¬ç¼–ç çš„é¡¹ç›®åç§°
- âœ… æ‰€æœ‰é…ç½®ä»ç¯å¢ƒå˜é‡è¯»å–
- âœ… å¯ä»¥åœ¨ä»»ä½• MCP Server ä¸­ç›´æ¥ä½¿ç”¨

**åŒ…å«çš„æ–‡ä»¶**ï¼š
```
cred_extract_services/
â”œâ”€â”€ __init__.py           # å…¬å…±æ¥å£å¯¼å‡º
â”œâ”€â”€ aws_client.py         # STS AssumeRoleï¼ˆé€šç”¨ï¼‰
â”œâ”€â”€ context_manager.py    # ç¯å¢ƒå˜é‡ç®¡ç†ï¼ˆé€šç”¨ï¼‰
â”œâ”€â”€ credential_extractor.py  # å‡­è¯æå–æ ¸å¿ƒï¼ˆé€šç”¨ï¼‰
â”œâ”€â”€ crypto.py             # AKSK è§£å¯†ï¼ˆé€šç”¨ï¼‰
â”œâ”€â”€ database.py           # æ•°æ®åº“æŸ¥è¯¢ï¼ˆé€šç”¨ï¼‰
â””â”€â”€ exceptions.py         # è‡ªå®šä¹‰å¼‚å¸¸ï¼ˆé€šç”¨ï¼‰
```

**éªŒè¯**ï¼š
```bash
# æµ‹è¯•å¯¼å…¥
python -c "from cred_extract_services import extract_aws_credentials; print('âœ… å¯¼å…¥æˆåŠŸ')"
```

---

### Step 2: ä¿®æ”¹ server.py

#### 2.1 æ·»åŠ  FastMCP é…ç½®å‚æ•°

**ä¿®æ”¹ FastMCP åˆå§‹åŒ–**ï¼š
```python
# åŸå§‹ä»£ç 
from mcp.server.fastmcp import FastMCP

mcp = FastMCP(
    'awslabs.your-mcp-server',
    instructions='...',
    dependencies=[...]
)
```

**æ”¹é€ å**ï¼š
```python
from mcp.server.fastmcp import FastMCP

# Create FastMCP server for AgentCore Runtime
# AgentCore requires stateless HTTP servers on 0.0.0.0:8000/mcp
mcp = FastMCP(
    name='awslabs.your-mcp-server',  # âœ… ä½¿ç”¨ name= å‚æ•°
    instructions='...',
    dependencies=[
        'boto3',
        'botocore',
        'pydantic',
    ],
    host="0.0.0.0",           # âœ… æ–°å¢ï¼šç›‘å¬åœ°å€
    stateless_http=True       # âœ… æ–°å¢ï¼šæ— çŠ¶æ€ HTTP æ¨¡å¼
)
```

---

#### 2.2 æ·»åŠ å¯¼å…¥å’Œå¼‚å¸¸ç±»å¯¼å‡º

**åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ å¯¼å…¥**ï¼š
```python
import logging

from awslabs.your_mcp_server.tools import YourTools
from mcp.server.fastmcp import FastMCP

# âœ… æ–°å¢ï¼šå¯¼å…¥å‡­è¯æœåŠ¡
from cred_extract_services.context_manager import set_aws_credentials
from cred_extract_services.credential_extractor import extract_aws_credentials
from cred_extract_services.exceptions import (
    AccountNotFoundError,
    AssumeRoleError,
    CredentialDecryptionError,
    CredentialExtractionError,
    DatabaseConnectionError,
)

logger = logging.getLogger(__name__)

# âœ… æ–°å¢ï¼šå¯¼å‡ºå¼‚å¸¸ç±»å’Œå‡½æ•°
__all__ = [
    "_setup_account_context",
    "mcp",
    "main",
    "CredentialExtractionError",
    "AccountNotFoundError",
    "CredentialDecryptionError",
    "AssumeRoleError",
    "DatabaseConnectionError",
]
```

---

#### 2.3 æ·»åŠ  _setup_account_context å‡½æ•°

**âš ï¸ é‡è¦è¯´æ˜ï¼šç›´æ¥æ·»åŠ åˆ° server.py æ–‡ä»¶ä¸­**

**ä½ç½®ï¼šåœ¨ mcp åˆå§‹åŒ–ä¹‹åã€main() ä¹‹å‰**

**ä¸ºä»€ä¹ˆä¸åˆ›å»ºç‹¬ç«‹æ¨¡å—ï¼Ÿ**
- âœ… ç¬¦åˆ FastMCP æ¶æ„è§„èŒƒï¼ˆserver.py è´Ÿè´£å…¬å…±å‡½æ•°ï¼‰
- âœ… å¯¼å…¥è·¯å¾„æ›´ç®€å•æ¸…æ™°
- âœ… è¿™ä¸ªå‡½æ•°å¯ä»¥ **100% ä» CloudTrail MCP å¤åˆ¶**ï¼Œæ— éœ€ä¿®æ”¹ä»»ä½•ä»£ç 
- âŒ åˆ›å»ºç‹¬ç«‹æ¨¡å—ä¼šå¢åŠ å¤æ‚åº¦ï¼Œé™ä½å¯å¤ç”¨æ€§

**å¤åˆ¶æç¤ºï¼š** è¿™ä¸ªå‡½æ•°å¯ä»¥ç›´æ¥ä» `cloudtrail-mcp-server/awslabs/cloudtrail_mcp_server/server.py` ä¸­å¤åˆ¶ï¼Œç²˜è´´åˆ°ä½ çš„ `server.py` ä¸­ï¼Œ**å®Œå…¨ä¸éœ€è¦ä¿®æ”¹**ï¼

---

**å®Œæ•´ä»£ç å¦‚ä¸‹**ï¼š

```python
async def _setup_account_context(
    target_account_id: str,
) -> dict[str, str]:
    """è®¾ç½® AWS å‡­è¯ä¸Šä¸‹æ–‡

    ç»Ÿä¸€å…¥å£å‡½æ•°ï¼Œå®Œæˆä»¥ä¸‹æ“ä½œï¼š
    1. æŸ¥è¯¢è´¦å·ä¿¡æ¯ï¼ˆè‡ªåŒ…å«æ•°æ®åº“æŸ¥è¯¢ï¼‰
    2. æå–å‡­è¯ï¼ˆAKSK è§£å¯† / IAM Role AssumeRoleï¼‰
    3. è®¾ç½®ç¯å¢ƒå˜é‡

    Args:
        target_account_id: AWS è´¦å· ID

    Returns:
        å‡­è¯ä¿¡æ¯å­—å…¸ï¼ˆå·²è„±æ•ï¼‰

    Raises:
        AccountNotFoundError: è´¦å·ä¸å­˜åœ¨
        CredentialDecryptionError: AKSK è§£å¯†å¤±è´¥
        AssumeRoleError: IAM Role AssumeRole å¤±è´¥
        DatabaseConnectionError: æ•°æ®åº“è¿æ¥å¤±è´¥
    """
    logger.info("å¼€å§‹è®¾ç½® AWS å‡­è¯ä¸Šä¸‹æ–‡")

    # 1. æå–å‡­è¯
    credentials = await extract_aws_credentials(target_account_id)

    # 2. è®¾ç½®ç¯å¢ƒå˜é‡
    set_aws_credentials(
        access_key_id=credentials["access_key_id"],
        secret_access_key=credentials["secret_access_key"],
        session_token=credentials.get("session_token"),
        region=credentials["region"],
    )

    # 3. è¿”å›è„±æ•ä¿¡æ¯
    cred_info = {
        "account_id": credentials["account_id"],
        "account_alias": credentials.get("alias", "Unknown"),
        "auth_type": credentials["auth_type"],
        "region": credentials["region"],
    }

    logger.info(f"âœ… AWS å‡­è¯ä¸Šä¸‹æ–‡è®¾ç½®å®Œæˆ: {cred_info}")
    return cred_info
```

**ğŸ’¡ è¿™ä¸ªå‡½æ•°å¯ä»¥ç›´æ¥ä» cloudtrail-mcp-server å¤åˆ¶ï¼Œæ— éœ€ä¿®æ”¹ï¼**

---

#### 2.3.1 å®Œæ•´çš„ server.py ç»“æ„ç¤ºä¾‹

**æ”¹é€ åçš„ server.py å®Œæ•´ç»“æ„**ï¼š

```python
# awslabs/your_mcp_server/server.py

import logging
from mcp.server.fastmcp import FastMCP

# âœ… å¯¼å…¥å‡­è¯æœåŠ¡
from cred_extract_services.context_manager import set_aws_credentials
from cred_extract_services.credential_extractor import extract_aws_credentials
from cred_extract_services.exceptions import (
    AccountNotFoundError,
    AssumeRoleError,
    CredentialDecryptionError,
    CredentialExtractionError,
    DatabaseConnectionError,
)

logger = logging.getLogger(__name__)

# âœ… å¯¼å‡ºå¼‚å¸¸ç±»å’Œå‡½æ•°ï¼ˆä¾› tools ä½¿ç”¨ï¼‰
__all__ = [
    "_setup_account_context",
    "mcp",
    "main",
    "CredentialExtractionError",
    "AccountNotFoundError",
    "CredentialDecryptionError",
    "AssumeRoleError",
    "DatabaseConnectionError",
]

# ===== ç¬¬ 1 éƒ¨åˆ†ï¼šFastMCP åˆå§‹åŒ– =====
mcp = FastMCP(
    name='awslabs.your-mcp-server',
    instructions='...',
    dependencies=[
        'boto3',
        'botocore',
        'pydantic',
    ],
    host="0.0.0.0",           # âœ… å¿…é¡»ï¼
    stateless_http=True       # âœ… å¿…é¡»ï¼
)

# ===== ç¬¬ 2 éƒ¨åˆ†ï¼šè´¦å·ä¸Šä¸‹æ–‡å‡½æ•°ï¼ˆâœ… 100% å¯å¤åˆ¶ï¼‰=====
async def _setup_account_context(
    target_account_id: str,
) -> dict[str, str]:
    """è®¾ç½® AWS å‡­è¯ä¸Šä¸‹æ–‡

    âš ï¸ è¿™ä¸ªå‡½æ•°å¯ä»¥ä» cloudtrail-mcp-server ç›´æ¥å¤åˆ¶ï¼Œå®Œå…¨ä¸éœ€è¦ä¿®æ”¹ï¼
    """
    logger.info("å¼€å§‹è®¾ç½® AWS å‡­è¯ä¸Šä¸‹æ–‡")

    # 1. æå–å‡­è¯
    credentials = await extract_aws_credentials(target_account_id)

    # 2. è®¾ç½®ç¯å¢ƒå˜é‡
    set_aws_credentials(
        access_key_id=credentials["access_key_id"],
        secret_access_key=credentials["secret_access_key"],
        session_token=credentials.get("session_token"),
        region=credentials["region"],
    )

    # 3. è¿”å›è„±æ•ä¿¡æ¯
    cred_info = {
        "account_id": credentials["account_id"],
        "account_alias": credentials.get("alias", "Unknown"),
        "auth_type": credentials["auth_type"],
        "region": credentials["region"],
    }

    logger.info(f"âœ… AWS å‡­è¯ä¸Šä¸‹æ–‡è®¾ç½®å®Œæˆ: {cred_info}")
    return cred_info

# ===== ç¬¬ 3 éƒ¨åˆ†ï¼šä¸»å…¥å£ =====
def main():
    """Run the MCP server with streamable HTTP transport for AgentCore."""
    mcp.run(transport="streamable-http")

if __name__ == '__main__':
    main()
```

**å…³é”®ç‚¹**ï¼š
1. âœ… `_setup_account_context()` å‡½æ•°**ç›´æ¥æ”¾åœ¨ server.py ä¸­**
2. âœ… ä½ç½®åœ¨ FastMCP åˆå§‹åŒ–**ä¹‹å**ã€main() **ä¹‹å‰**
3. âœ… é€šè¿‡ `__all__` å¯¼å‡ºï¼Œä¾› tools æ–‡ä»¶å¯¼å…¥ä½¿ç”¨
4. âœ… **ä¸éœ€è¦åˆ›å»ºç‹¬ç«‹çš„ account_context.py æ–‡ä»¶**

---

#### 2.4 ä¿®æ”¹ main() å‡½æ•°

```python
# åŸå§‹ä»£ç 
def main():
    mcp.run()
```

**æ”¹é€ å**ï¼š
```python
def main():
    """Run the MCP server with streamable HTTP transport for AgentCore."""
    # AgentCore Runtime expects servers to run with streamable-http transport
    mcp.run(transport="streamable-http")

if __name__ == '__main__':
    main()
```

---

#### 2.5 éªŒè¯ server.py ä¿®æ”¹

```bash
# æ£€æŸ¥ FastMCP é…ç½®
grep -A 5 "FastMCP(" awslabs/*/server.py

# æ£€æŸ¥ _setup_account_context å‡½æ•°
grep -A 3 "_setup_account_context" awslabs/*/server.py

# æ£€æŸ¥ main() å‡½æ•°
grep -A 3 "def main" awslabs/*/server.py
```

---

### Step 3: ä¿®æ”¹æ‰€æœ‰ Tool å‡½æ•°

#### 3.1 å®šä½æ‰€æœ‰ Tool æ–‡ä»¶
```bash
# æŸ¥æ‰¾æ‰€æœ‰ tool æ–‡ä»¶
find awslabs -name "*_tools.py" -type f
```

#### 3.2 å‚æ•°é¡ºåºè§„åˆ™ âš ï¸ é‡è¦

**ğŸ¯ æ ¸å¿ƒè§„åˆ™ï¼š`target_account_id` å¿…é¡»æ”¾åœ¨æ‰€æœ‰å¿…éœ€å‚æ•°ä¹‹åã€å…¶ä»–å¯é€‰å‚æ•°ä¹‹å‰**

```python
# âœ… æ­£ç¡®çš„å‚æ•°é¡ºåº
async def tool_function(
    ctx: Context,                             # 1. MCP Contextï¼ˆå¿…éœ€ï¼‰
    required_param: str,                      # 2. ä¸šåŠ¡å¿…éœ€å‚æ•°
    target_account_id: Optional[str] = None,  # 3. â­ target_account_idï¼ˆç¬¬ä¸€ä¸ªå¯é€‰å‚æ•°ï¼‰
    optional_param: Optional[int] = None,     # 4. å…¶ä»–å¯é€‰å‚æ•°
):

# âŒ é”™è¯¯ç¤ºä¾‹ 1ï¼štarget_account_id åœ¨å¿…éœ€å‚æ•°ä¹‹å‰
async def tool_function(
    ctx: Context,
    target_account_id: Optional[str] = None,  # âŒ é”™è¯¯ï¼
    required_param: str,                      # Python ä¸å…è®¸å¿…éœ€å‚æ•°åœ¨å¯é€‰å‚æ•°åé¢
):

# âŒ é”™è¯¯ç¤ºä¾‹ 2ï¼štarget_account_id åœ¨å…¶ä»–å¯é€‰å‚æ•°ä¹‹å
async def tool_function(
    ctx: Context,
    required_param: str,
    optional_param: Optional[int] = None,
    target_account_id: Optional[str] = None,  # âŒ ä¸è§„èŒƒï¼Œåº”è¯¥æ”¾åœ¨ç¬¬ä¸€ä¸ª
):
```

---

#### 3.3 æ ‡å‡†æ”¹é€ æ¨¡æ¿

**æ”¹é€ å‰**ï¼š
```python
@server.tool(name="tool-name", description="...")
async def tool_function(
    ctx: Context,
    param1: str,                     # å¿…éœ€å‚æ•°
    param2: Optional[int] = None,    # å¯é€‰å‚æ•°
) -> Dict[str, Any]:
    try:
        # ä¸šåŠ¡é€»è¾‘
        client = create_aws_client("service", "region")
        response = client.some_api_call(param1=param1)
        return format_response("success", response)
    except Exception as e:
        return await handle_aws_error(ctx, e, "operation", "Service")
```

**æ”¹é€ å**ï¼š
```python
# 1. å¯¼å…¥å¼‚å¸¸ç±»ï¼ˆæ–‡ä»¶é¡¶éƒ¨ï¼‰
from awslabs.your_mcp_server.server import (
    _setup_account_context,
    AccountNotFoundError,
    CredentialDecryptionError,
    AssumeRoleError,
    DatabaseConnectionError,
)

@server.tool(name="tool-name", description="...")
async def tool_function(
    ctx: Context,
    param1: str,                              # å¿…éœ€å‚æ•°ï¼ˆä¿æŒåŸä½ç½®ï¼‰
    target_account_id: Optional[str] = None,  # âœ… æ–°å¢ï¼šç¬¬ä¸€ä¸ªå¯é€‰å‚æ•°
    param2: Optional[int] = None,             # å¯é€‰å‚æ•°ï¼ˆä¿æŒåŸä½ç½®ï¼‰
) -> Dict[str, Any]:
    try:
        # ===== è´¦å·ä¸Šä¸‹æ–‡åˆå§‹åŒ– =====
        if target_account_id:
            await _setup_account_context(target_account_id)

        # ===== åŸæœ‰é€»è¾‘ï¼ˆå®Œå…¨ä¸å˜ï¼‰=====
        client = create_aws_client("service", "region")
        response = client.some_api_call(param1=param1)
        return format_response("success", response)

    # ===== å¼‚å¸¸å¤„ç† =====
    except AccountNotFoundError:
        return format_response('error', {'error_type': 'account_not_found'},
                               'Account not found. Please check the account ID.')
    except CredentialDecryptionError:
        return format_response('error', {'error_type': 'credential_error'},
                               'Failed to decrypt credentials. Please contact administrator.')
    except AssumeRoleError:
        return format_response('error', {'error_type': 'assume_role_error'},
                               'Failed to assume role. Please check IAM role configuration.')
    except DatabaseConnectionError:
        return format_response('error', {'error_type': 'database_error'},
                               'Database connection failed. Please try again later.')
    except Exception as e:
        return await handle_aws_error(ctx, e, "operation", "Service")
```

---

#### 3.4 æ‰¹é‡ä¿®æ”¹è¾…åŠ©è„šæœ¬ï¼ˆä»…ä¾›å‚è€ƒï¼‰

**âš ï¸ è­¦å‘Š**ï¼šè‡ªåŠ¨åŒ–è„šæœ¬å¯èƒ½æ— æ³•å¤„ç†æ‰€æœ‰è¾¹ç•Œæƒ…å†µï¼Œ**å¿…é¡»äººå·¥å®¡æŸ¥æ¯ä¸ªä¿®æ”¹**

```python
# scripts/add_target_account_id.py
import re
import sys
from pathlib import Path

def add_target_account_id_param(file_path: Path, package_name: str):
    """ç»™ tool å‡½æ•°æ·»åŠ  target_account_id å‚æ•°"""
    content = file_path.read_text()

    # 1. æ·»åŠ å¯¼å…¥ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    import_block = f"""
from awslabs.{package_name}.server import (
    _setup_account_context,
    AccountNotFoundError,
    CredentialDecryptionError,
    AssumeRoleError,
    DatabaseConnectionError,
)
"""
    if "_setup_account_context" not in content:
        # åœ¨æœ€åä¸€ä¸ª import åæ·»åŠ 
        lines = content.split('\n')
        last_import_idx = 0
        for i, line in enumerate(lines):
            if line.startswith('import ') or line.startswith('from '):
                last_import_idx = i
        lines.insert(last_import_idx + 1, import_block)
        content = '\n'.join(lines)

    # 2. ä¿®æ”¹å‡½æ•°ç­¾åï¼ˆæ·»åŠ  target_account_idï¼‰
    # æ¨¡å¼ï¼šasync def function_name(ctx: Context, ...
    # æ³¨æ„ï¼šè¿™åªæ˜¯ç®€å•ç¤ºä¾‹ï¼Œå®é™…éœ€è¦æ›´å¤æ‚çš„é€»è¾‘
    pattern = r'(async def \w+\(\s*ctx:\s*Context,)'
    replacement = r'\1\n    target_account_id: Optional[str] = None,'
    content = re.sub(pattern, replacement, content)

    # 3. æ·»åŠ è´¦å·ä¸Šä¸‹æ–‡åˆå§‹åŒ–ä»£ç 
    context_init = """
        # ===== Account context initialization =====
        if target_account_id:
            await _setup_account_context(target_account_id)

        # ===== Original logic (unchanged) =====
"""
    content = content.replace("    try:\n", f"    try:\n{context_init}")

    # ä¿å­˜ä¿®æ”¹
    file_path.write_text(content)
    print(f"âœ… Modified: {file_path}")


if __name__ == "__main__":
    if len(sys.argv) < 3:
        print("Usage: python add_target_account_id.py <package_name> <tool_file.py>")
        sys.exit(1)

    package_name = sys.argv[1]
    for file_path in sys.argv[2:]:
        add_target_account_id_param(Path(file_path), package_name)
```

**ä½¿ç”¨è„šæœ¬**ï¼š
```bash
# ä¿®æ”¹å•ä¸ªæ–‡ä»¶
python scripts/add_target_account_id.py your_mcp_server awslabs/.../tools/example_tools.py

# æ‰¹é‡ä¿®æ”¹ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
find awslabs -name "*_tools.py" -exec python scripts/add_target_account_id.py your_mcp_server {} \;
```

**âš ï¸ å»ºè®®**ï¼š
- å…ˆåœ¨æµ‹è¯•æ–‡ä»¶ä¸ŠéªŒè¯
- **å¿…é¡»äººå·¥å®¡æŸ¥æ¯ä¸ªä¿®æ”¹**
- å»ºè®®æ‰‹åŠ¨ä¿®æ”¹ï¼ˆæ›´å®‰å…¨ï¼‰

---

### Step 4: æ›´æ–° Tool æè¿°æ–‡æ¡£

#### 4.1 æ·»åŠ å‚æ•°è¯´æ˜
åœ¨æ¯ä¸ª tool çš„ `description` ä¸­æ·»åŠ ï¼š
```python
@server.tool(
    name="tool-name",
    description="""Tool description...

    Args:
        ctx: The MCP context object
        target_account_id: Target AWS account ID. If not provided, use default credentials.
        # ... å…¶ä»–å‚æ•°

    Returns:
        Dict containing the response data
    """
)
```

#### 4.2 æ·»åŠ ä½¿ç”¨ç¤ºä¾‹
```markdown
## ä½¿ç”¨ç¤ºä¾‹

### 1. ä½¿ç”¨é»˜è®¤å‡­è¯
```json
{
  "tool": "tool-name",
  "params": {
    "param1": "value1"
  }
}
```

### 2. ä½¿ç”¨ç›®æ ‡è´¦å·å‡­è¯
```json
{
  "tool": "tool-name",
  "params": {
    "target_account_id": "123456789012",
    "param1": "value1"
  }
}
```
```

---

### Step 4.5: æ£€æŸ¥å¹¶ç»Ÿä¸€æ—¥å¿—åº“ï¼ˆé‡è¦ï¼‰âš ï¸

#### 4.5.1 ä¸ºä»€ä¹ˆéœ€è¦ç»Ÿä¸€æ—¥å¿—åº“ï¼Ÿ

**é—®é¢˜**ï¼šæ··ç”¨ `loguru` å’Œ `logging` ä¼šå¯¼è‡´ï¼š
- âŒ **OpenTelemetry æ— æ³•æ•è· loguru æ—¥å¿—**
- âŒ **ç¼ºå°‘ trace ID å’Œ span ID**ï¼ˆæ— æ³•è¿½è¸ªè¯·æ±‚é“¾è·¯ï¼‰
- âŒ **CloudWatch æ—¥å¿—ä¸å®Œæ•´**ï¼ˆloguru çš„æ—¥å¿—åªé€šè¿‡ stderr è¾“å‡ºï¼Œæ²¡æœ‰ç»“æ„åŒ–ä¿¡æ¯ï¼‰
- âŒ **æ—¥å¿—æ ¼å¼ä¸ä¸€è‡´**ï¼ˆéš¾ä»¥ç»Ÿä¸€åˆ†æï¼‰

**æ£€æŸ¥æ–¹æ³•**ï¼š
```bash
# æŸ¥æ‰¾é¡¹ç›®ä¸­æ˜¯å¦ä½¿ç”¨ loguru
cd src/<mcp-server-name>/
grep -r "from loguru" awslabs/ --include="*.py"

# å¦‚æœæ‰¾åˆ°ï¼Œéœ€è¦è¿ç§»åˆ° logging
```

---

#### 4.5.2 è¿ç§»æ­¥éª¤

**Step 1: ä¿®æ”¹å¯¼å…¥è¯­å¥**
```python
# ä¿®æ”¹å‰ï¼ˆtools.py æˆ–å…¶ä»–æ–‡ä»¶ï¼‰
from loguru import logger

# ä¿®æ”¹å
import logging
logger = logging.getLogger(__name__)
```

**Step 2: ç§»é™¤ loguru ä¾èµ–**
```toml
# pyproject.toml
[project]
dependencies = [
    "boto3>=1.38.22",
    # "loguru>=0.7.0",  # âŒ åˆ é™¤æ­¤è¡Œ
    "mcp[cli]>=1.23.0",
    "pydantic>=2.10.6",
]
```

**Step 3: æ›´æ–° FastMCP ä¾èµ–å£°æ˜**ï¼ˆå¦‚æœæœ‰ï¼‰
```python
# server.py
mcp = FastMCP(
    name='awslabs.xxx-mcp-server',
    dependencies=[
        'boto3',
        'botocore',
        'pydantic',
        # 'loguru',  # âŒ åˆ é™¤æ­¤è¡Œ
    ],
    ...
)
```

**Step 4: éªŒè¯ä¿®æ”¹**
```bash
# ç¡®è®¤æ²¡æœ‰ loguru å¼•ç”¨
grep -r "loguru" . --include="*.py" --include="*.toml" || echo "âœ… æ²¡æœ‰æ‰¾åˆ° loguru å¼•ç”¨"

# è¯­æ³•æ£€æŸ¥
python3 -m py_compile awslabs/**/*.py
```

---

#### 4.5.3 æ—¥å¿—æ–¹æ³•å…¼å®¹æ€§

**å¥½æ¶ˆæ¯**ï¼š`logging` å’Œ `loguru` çš„åŸºç¡€ API å®Œå…¨å…¼å®¹ï¼Œæ— éœ€ä¿®æ”¹æ—¥å¿—è°ƒç”¨ä»£ç ï¼

```python
# ä»¥ä¸‹ä»£ç åœ¨ä¸¤ä¸ªåº“ä¸­éƒ½å¯ä»¥æ­£å¸¸å·¥ä½œ
logger.info(f"æ¶ˆæ¯: {å˜é‡}")
logger.error(f"é”™è¯¯: {str(e)}")
logger.warning(f"è­¦å‘Š: {å†…å®¹}")
logger.debug(f"è°ƒè¯•: {æ•°æ®}")
```

**æ³¨æ„**ï¼šå¦‚æœä½¿ç”¨äº† loguru ç‰¹æœ‰åŠŸèƒ½ï¼Œéœ€è¦è°ƒæ•´ï¼š
```python
# âŒ loguru ç‰¹æœ‰è¯­æ³•ï¼ˆéœ€è¦æ”¹ï¼‰
logger.opt(exception=True).error("é”™è¯¯")
logger.bind(request_id=123).info("æ¶ˆæ¯")
logger.catch()(my_function)

# âœ… logging ç­‰æ•ˆå†™æ³•
logger.error("é”™è¯¯", exc_info=True)
logger.info("æ¶ˆæ¯", extra={"request_id": 123})
# ä½¿ç”¨æ ‡å‡†å¼‚å¸¸å¤„ç†æ›¿ä»£ @logger.catch()
```

---

#### 4.5.4 è¿ç§»åçš„ä¼˜åŠ¿

| æ”¹è¿›é¡¹ | loguru | logging | æå‡ |
|--------|--------|---------|------|
| **OpenTelemetry é›†æˆ** | âŒ | âœ… | â­â­â­â­â­ |
| **Trace ID** | âŒ | âœ… | â­â­â­â­â­ |
| **Span ID** | âŒ | âœ… | â­â­â­â­â­ |
| **CloudWatch å®Œæ•´æ€§** | âš ï¸ éƒ¨åˆ† | âœ… å®Œæ•´ | â­â­â­â­ |
| **è¯·æ±‚é“¾è·¯è¿½è¸ª** | âŒ | âœ… | â­â­â­â­â­ |
| **æ—¥å¿—ç³»ç»Ÿç»Ÿä¸€** | âŒ | âœ… | â­â­â­â­ |

**CloudWatch æ—¥å¿—å¯¹æ¯”**ï¼š
```json
// âŒ loguruï¼ˆç¼ºå°‘è¿½è¸ªä¿¡æ¯ï¼‰
"2026-01-19 12:00:00.123 | INFO | tools:lookup_events:180 - å¼€å§‹æŸ¥è¯¢"

// âœ… logging + OpenTelemetryï¼ˆå®Œæ•´è¿½è¸ªï¼‰
{
  "timestamp": "2026-01-19T12:00:00.123Z",
  "level": "INFO",
  "logger": "awslabs.xxx_mcp_server.tools",
  "message": "å¼€å§‹æŸ¥è¯¢",
  "trace_id": "1-abc123",  // âœ… å¯è¿½è¸ªè¯·æ±‚
  "span_id": "xyz789"      // âœ… å¯è¿½è¸ªå‡½æ•°è°ƒç”¨
}
```

---

#### 4.5.5 å¿«é€Ÿè¿ç§»æ£€æŸ¥æ¸…å•

- [ ] æŸ¥æ‰¾æ‰€æœ‰ `from loguru import` å¼•ç”¨
- [ ] æ›¿æ¢ä¸º `import logging` + `logger = logging.getLogger(__name__)`
- [ ] ä» `pyproject.toml` ç§»é™¤ `loguru` ä¾èµ–
- [ ] ä» `server.py` FastMCP ä¾èµ–ç§»é™¤ `loguru`
- [ ] æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº† loguru ç‰¹æœ‰è¯­æ³•ï¼ˆéœ€è¦è°ƒæ•´ï¼‰
- [ ] éªŒè¯è¯­æ³•å’Œå¯¼å…¥æ­£ç¡®æ€§
- [ ] é‡æ–°æ„å»ºé•œåƒ

**å‚è€ƒæ–‡æ¡£**ï¼š`costq/docs/20260118_CloudTrail_MCPé—®é¢˜/20250119_loguru_è¿ç§»åˆ°_logging.md`

---

## ğŸ“ ç¼–ç è§„èŒƒä¸æ—¥å¿—æ ‡å‡†

### 1. æ—¥å¿—çº§åˆ«ä½¿ç”¨æ ‡å‡† â­ é‡è¦

**åœ¨æ”¹é€ å’Œç»´æŠ¤ MCP Server æ—¶,å¿…é¡»éµå¾ªä»¥ä¸‹æ—¥å¿—çº§åˆ«ä½¿ç”¨æ ‡å‡†**

#### 1.1 æ—¥å¿—çº§åˆ«å¿«é€Ÿå‚è€ƒ

| çº§åˆ« | ä½¿ç”¨åœºæ™¯ | ç”Ÿäº§ç¯å¢ƒ | å…¸å‹å…³é”®è¯ |
|------|---------|---------|-----------|
| **DEBUG** | è¯¦ç»†è¯Šæ–­ä¿¡æ¯ | âŒ é»˜è®¤ç¦ç”¨ | ğŸ” å‚æ•°ã€ä¸­é—´å€¼ã€è¯¦ç»†æµç¨‹ |
| **INFO** | å…³é”®ä¸šåŠ¡èŠ‚ç‚¹ | âœ… é»˜è®¤å¯ç”¨ | âœ… å¼€å§‹ã€å®Œæˆã€æˆåŠŸ |
| **WARNING** | éé¢„æœŸä½†å¯å¤„ç† | âœ… é»˜è®¤å¯ç”¨ | âš ï¸ è‡ªåŠ¨è½¬æ¢ã€ä½¿ç”¨é»˜è®¤å€¼ã€å…¼å®¹æ€§å¤„ç† |
| **ERROR** | æ“ä½œå¤±è´¥ | âœ… é»˜è®¤å¯ç”¨ | âŒ å¤±è´¥ã€é”™è¯¯ã€å¼‚å¸¸ |
| **CRITICAL** | ç³»ç»Ÿçº§ä¸¥é‡é”™è¯¯ | âœ… é»˜è®¤å¯ç”¨ | ğŸ”¥ æœåŠ¡ä¸å¯ç”¨ã€è‡´å‘½é”™è¯¯ |

---

#### 1.2 å®æˆ˜æŒ‡å—ï¼šå¦‚ä½•é€‰æ‹©æ—¥å¿—çº§åˆ«

**é—®é—®è‡ªå·±è¿™äº›é—®é¢˜**ï¼š

1. **è¿™æ¡æ—¥å¿—åœ¨ç”Ÿäº§ç¯å¢ƒéœ€è¦çœ‹åˆ°å—ï¼Ÿ**
   - éœ€è¦ â†’ INFO/WARNING/ERROR/CRITICAL
   - ä¸éœ€è¦ï¼ˆä»…è°ƒè¯•ï¼‰ â†’ DEBUG

2. **è¿™æ˜¯æ­£å¸¸çš„ä¸šåŠ¡æµç¨‹å—ï¼Ÿ**
   - æ˜¯ â†’ INFO
   - ä¸æ˜¯,ä½†å¯ä»¥å¤„ç† â†’ WARNING
   - ä¸æ˜¯,æ“ä½œå¤±è´¥ â†’ ERROR

3. **å½±å“èŒƒå›´æœ‰å¤šå¤§ï¼Ÿ**
   - ä»…å½“å‰æ“ä½œ â†’ ERROR
   - æ•´ä¸ªæœåŠ¡ä¸å¯ç”¨ â†’ CRITICAL

---

#### 1.3 å¸¸è§åœºæ™¯æ—¥å¿—çº§åˆ«å¯¹ç…§è¡¨

**å‡­è¯ç®¡ç†**ï¼š
```python
# DEBUG - ä»…å¼€å‘è°ƒè¯•
logger.debug("ğŸ” æŸ¥è¯¢è´¦å·ä¿¡æ¯: account_id=%s", account_id)
logger.debug("æŸ¥è¯¢ç»“æœ: %s", account_data)

# INFO - å…³é”®èŠ‚ç‚¹
logger.info("å¼€å§‹è®¾ç½® AWS å‡­è¯ä¸Šä¸‹æ–‡")
logger.info("âœ… AWS å‡­è¯ä¸Šä¸‹æ–‡è®¾ç½®å®Œæˆ: %s", cred_info)

# ERROR - å¤±è´¥
logger.error("âŒ æ•°æ®åº“è¿æ¥å¤±è´¥: %s", str(e))
logger.error("âŒ å‡­è¯è§£å¯†å¤±è´¥", exc_info=True)
```

**å‚æ•°å¤„ç†**ï¼š
```python
# DEBUG - å‚æ•°å€¼
logger.debug("ğŸ” æ¥æ”¶å‚æ•°: filter_expression type=%s", type(filter_expression).__name__)

# INFO - æ­£å¸¸æµç¨‹
logger.info("æŸ¥è¯¢ CloudTrail äº‹ä»¶: %d æ¡", event_count)

# WARNING - éé¢„æœŸä½†å¯å¤„ç†
logger.warning("âš ï¸ æ¥æ”¶åˆ° dict ç±»å‹,åº”ä¸º string,è‡ªåŠ¨è½¬æ¢ä¸­...")
logger.warning("æœªæä¾› region å‚æ•°,ä½¿ç”¨é»˜è®¤å€¼: %s", default_region)

# ERROR - å‚æ•°æ— æ•ˆ
logger.error("âŒ å‚æ•°éªŒè¯å¤±è´¥: %s", validation_error)
```

**API è°ƒç”¨**ï¼š
```python
# INFO - å¼€å§‹/å®Œæˆ
logger.info("å¼€å§‹è°ƒç”¨ AWS API: %s", operation_name)
logger.info("âœ… API è°ƒç”¨æˆåŠŸ,è¿”å› %d æ¡è®°å½•", len(results))

# WARNING - éƒ¨åˆ†å¤±è´¥
logger.warning("API è°ƒç”¨éƒ¨åˆ†å¤±è´¥,é‡è¯•ä¸­...")

# ERROR - å®Œå…¨å¤±è´¥
logger.error("âŒ API è°ƒç”¨å¤±è´¥: %s", error_message)
```

---

#### 1.4 æ—¥å¿—çº§åˆ«ä¿®å¤ç¤ºä¾‹

**ä¿®å¤å‰ï¼ˆé”™è¯¯ï¼‰**ï¼š
```python
# âŒ é”™è¯¯ï¼šæ­£å¸¸æµç¨‹ç”¨ DEBUG
logger.debug("âœ… AWS å‡­è¯ä¸Šä¸‹æ–‡è®¾ç½®å®Œæˆ")
logger.debug("å¼€å§‹æŸ¥è¯¢ CloudTrail äº‹ä»¶")

# âŒ é”™è¯¯ï¼šéé¢„æœŸæƒ…å†µç”¨ INFO
logger.info("âš ï¸ æ¥æ”¶åˆ° dict ç±»å‹,åº”ä¸º string,è‡ªåŠ¨è½¬æ¢...")

# âŒ é”™è¯¯ï¼šå¤±è´¥ç”¨ WARNING
logger.warning("âŒ æ•°æ®åº“è¿æ¥å¤±è´¥")
```

**ä¿®å¤åï¼ˆæ­£ç¡®ï¼‰**ï¼š
```python
# âœ… æ­£ç¡®ï¼šå…³é”®ä¸šåŠ¡èŠ‚ç‚¹ç”¨ INFO
logger.info("âœ… AWS å‡­è¯ä¸Šä¸‹æ–‡è®¾ç½®å®Œæˆ")
logger.info("å¼€å§‹æŸ¥è¯¢ CloudTrail äº‹ä»¶")

# âœ… æ­£ç¡®ï¼šéé¢„æœŸä½†å¯å¤„ç†ç”¨ WARNING
logger.warning("âš ï¸ æ¥æ”¶åˆ° dict ç±»å‹,åº”ä¸º string,è‡ªåŠ¨è½¬æ¢...")

# âœ… æ­£ç¡®ï¼šå¤±è´¥ç”¨ ERROR
logger.error("âŒ æ•°æ®åº“è¿æ¥å¤±è´¥", exc_info=True)
```

---

### 2. ç”Ÿäº§ç¯å¢ƒæ—¥å¿—é…ç½®

#### 2.1 å¿…é¡»é…ç½® LOG_LEVEL ç¯å¢ƒå˜é‡

```bash
# å¼€å‘ç¯å¢ƒ
export LOG_LEVEL=DEBUG

# ç”Ÿäº§ç¯å¢ƒï¼ˆæ¨èï¼‰
export LOG_LEVEL=INFO

# ç”Ÿäº§ç¯å¢ƒï¼ˆé«˜æµé‡ï¼‰
export LOG_LEVEL=WARNING
```

**åœ¨ Dockerfile ä¸­è®¾ç½®é»˜è®¤å€¼**ï¼š
```dockerfile
# Dockerfile-AgentCore-Runtime
ENV LOG_LEVEL=INFO
```

#### 2.2 ä¸ºä»€ä¹ˆç”Ÿäº§ç¯å¢ƒä¸ç”¨ DEBUGï¼Ÿ

**æ€§èƒ½å½±å“**ï¼š
- â±ï¸ DEBUG æ—¥å¿—ä¼šå¯¼è‡´ 20-30% çš„æ€§èƒ½ä¸‹é™
- ğŸ’¾ CloudWatch æ—¥å¿—å­˜å‚¨æˆæœ¬å¢åŠ  5-10 å€
- ğŸ” å…³é”® INFO æ—¥å¿—è¢«æ·¹æ²¡åœ¨å¤§é‡ DEBUG ä¿¡æ¯ä¸­

**å®‰å…¨é£é™©**ï¼š
- ğŸ” DEBUG æ—¥å¿—å¯èƒ½åŒ…å«æ•æ„Ÿå‚æ•°å€¼
- ğŸ“Š è¯¦ç»†çš„å†…éƒ¨çŠ¶æ€å¯èƒ½æ³„éœ²ç³»ç»Ÿæ¶æ„ä¿¡æ¯

**æœ€ä½³å®è·µ**ï¼š
```python
# server.py æˆ– __init__.py
import logging
import os

# ä»ç¯å¢ƒå˜é‡è¯»å–,é»˜è®¤ INFO
log_level = os.getenv('LOG_LEVEL', 'INFO').upper()
logging.basicConfig(
    level=getattr(logging, log_level),
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)

logger = logging.getLogger(__name__)
logger.info(f"æ—¥å¿—çº§åˆ«è®¾ç½®ä¸º: {log_level}")
```

---

### 3. æ—¥å¿—å®‰å…¨è§„èŒƒ

#### 3.1 ä¸¥ç¦è®°å½•çš„ä¿¡æ¯ âš ï¸ ç»å¯¹ä¸èƒ½è¿å

**æ°¸è¿œä¸è¦è®°å½•**ï¼š
- âŒ AWS Access Key / Secret Key
- âŒ Session Token
- âŒ æ•°æ®åº“å¯†ç 
- âŒ åŠ å¯†å¯†é’¥ (ENCRYPTION_KEY)
- âŒ External IDï¼ˆIAM Roleï¼‰
- âŒ ç”¨æˆ·ä¸ªäººèº«ä»½ä¿¡æ¯ (PII)

**è„±æ•ç¤ºä¾‹**ï¼š
```python
# âŒ é”™è¯¯ - ä¸¥é‡å®‰å…¨é—®é¢˜ï¼
logger.info(f"ä½¿ç”¨å‡­è¯: AK={access_key_id}, SK={secret_access_key}")
logger.debug(f"Session Token: {session_token}")

# âœ… æ­£ç¡® - ä»…è®°å½•å…ƒæ•°æ®
logger.info("âœ… AWS å‡­è¯ä¸Šä¸‹æ–‡è®¾ç½®å®Œæˆ: %s", {
    "account_id": account_id,
    "account_alias": alias,
    "auth_type": auth_type,
    "region": region
})

# âœ… æ­£ç¡® - è„±æ•å¤„ç†ï¼ˆå¦‚æœå¿…é¡»è®°å½•ï¼‰
logger.debug("Access Key: %s****%s", access_key_id[:4], access_key_id[-4:])
```

#### 3.2 å¼‚å¸¸æ—¥å¿—è§„èŒƒ

```python
# âœ… æ­£ç¡® - ä½¿ç”¨ exc_info=True
try:
    credentials = decrypt_credentials(encrypted_data)
except Exception as e:
    logger.error("âŒ å‡­è¯è§£å¯†å¤±è´¥", exc_info=True)  # å †æ ˆä¸åŒ…å«å˜é‡å€¼
    raise CredentialDecryptionError("Failed to decrypt credentials")

# âŒ é”™è¯¯ - å¯èƒ½æ³„éœ²æ•æ„Ÿæ•°æ®
try:
    credentials = decrypt_credentials(encrypted_data)
except Exception as e:
    logger.error(f"è§£å¯†å¤±è´¥: {e}, åŸå§‹æ•°æ®: {encrypted_data}")  # æ³„éœ²åŠ å¯†æ•°æ®
```

---

### 4. æ—¥å¿—æœ€ä½³å®è·µ

#### 4.1 ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—

**æ¨è**ï¼š
```python
# âœ… ç»“æ„åŒ–æ—¥å¿— - ä¾¿äºæŸ¥è¯¢å’Œç»Ÿè®¡
logger.info(
    "API è°ƒç”¨æˆåŠŸ",
    extra={
        "account_id": account_id,
        "region": region,
        "operation": "DescribeInstances",
        "duration_ms": duration,
        "result_count": len(results)
    }
)

# CloudWatch Insights æŸ¥è¯¢ç¤ºä¾‹:
# fields @timestamp, account_id, region, operation, duration_ms
# | filter operation = "DescribeInstances"
# | stats avg(duration_ms) by region
```

**ä¸æ¨è**ï¼š
```python
# âŒ éç»“æ„åŒ–å­—ç¬¦ä¸² - éš¾ä»¥è§£æ
logger.info(f"API è°ƒç”¨æˆåŠŸ: account={account_id}, region={region}, op=DescribeInstances, duration={duration}ms")
```

#### 4.2 é¿å…æ—¥å¿—æ´ªæ°´

```python
# âŒ é”™è¯¯ - äº§ç”Ÿå¤§é‡æ—¥å¿—
for item in large_list:  # 1000+ æ¡
    logger.info(f"å¤„ç†é¡¹ç›®: {item}")  # äº§ç”Ÿ 1000+ æ¡ INFO æ—¥å¿—

# âœ… æ­£ç¡® - æ±‡æ€»æ—¥å¿—
logger.info("å¼€å§‹å¤„ç† %d ä¸ªé¡¹ç›®", len(large_list))
processed = 0
for item in large_list:
    logger.debug("å¤„ç†é¡¹ç›®: %s", item)  # DEBUG çº§åˆ«
    processed += 1
    if processed % 100 == 0:  # æ¯ 100 æ¡è®°å½•ä¸€æ¬¡
        logger.info("å·²å¤„ç† %d/%d ä¸ªé¡¹ç›®", processed, len(large_list))
logger.info("âœ… å¤„ç†å®Œæˆ,å…± %d ä¸ªé¡¹ç›®", len(large_list))
```

#### 4.3 åŒ…å«è¶³å¤Ÿçš„ä¸Šä¸‹æ–‡

```python
# âœ… å¥½çš„æ—¥å¿— - å®Œæ•´ä¸Šä¸‹æ–‡
logger.info(
    "æŸ¥è¯¢ CloudTrail äº‹ä»¶å®Œæˆ",
    extra={
        "account_id": account_id,
        "region": region,
        "start_time": start_time,
        "end_time": end_time,
        "event_count": len(events),
        "duration_ms": duration
    }
)

# âŒ ä¸å¥½çš„æ—¥å¿— - ç¼ºå°‘ä¸Šä¸‹æ–‡
logger.info(f"æŸ¥è¯¢å®Œæˆ,å…± {len(events)} æ¡")  # æ— æ³•è¿½æº¯æ˜¯å“ªä¸ªè´¦å·ã€å“ªä¸ªæ—¶é—´æ®µ
```

---

### 5. æ—¥å¿—æ£€æŸ¥æ¸…å•

**åœ¨æäº¤ä»£ç å‰,å¿…é¡»å®Œæˆä»¥ä¸‹æ£€æŸ¥**ï¼š

#### 5.1 æ—¥å¿—çº§åˆ«æ£€æŸ¥
- [ ] æ‰€æœ‰è°ƒè¯•ä¿¡æ¯ä½¿ç”¨ `logger.debug()`
- [ ] å…³é”®ä¸šåŠ¡èŠ‚ç‚¹ä½¿ç”¨ `logger.info()`
- [ ] éé¢„æœŸä½†å¯å¤„ç†çš„æƒ…å†µä½¿ç”¨ `logger.warning()`
- [ ] æ“ä½œå¤±è´¥ä½¿ç”¨ `logger.error()`
- [ ] ç³»ç»Ÿçº§ä¸¥é‡é”™è¯¯ä½¿ç”¨ `logger.critical()`
- [ ] æ²¡æœ‰åœ¨æ­£å¸¸æµç¨‹ä¸­ä½¿ç”¨ `logger.error()` æˆ– `logger.warning()`

#### 5.2 å®‰å…¨æ£€æŸ¥
- [ ] æ²¡æœ‰è®°å½• AWS å‡­è¯ï¼ˆAccess Keyã€Secret Keyã€Session Tokenï¼‰
- [ ] æ²¡æœ‰è®°å½•æ•°æ®åº“å¯†ç 
- [ ] æ²¡æœ‰è®°å½•åŠ å¯†å¯†é’¥
- [ ] æ²¡æœ‰è®°å½• External ID
- [ ] æ²¡æœ‰è®°å½• PIIï¼ˆä¸ªäººèº«ä»½ä¿¡æ¯ï¼‰
- [ ] æ•æ„Ÿä¿¡æ¯å·²è„±æ•ï¼ˆå¦‚ Access Key å‰ 4 ä½+å 4 ä½ï¼‰

#### 5.3 è´¨é‡æ£€æŸ¥
- [ ] ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—ï¼ˆ`extra` å‚æ•°ï¼‰
- [ ] æ¯ä¸ªæ—¥å¿—åŒ…å«è¶³å¤Ÿçš„ä¸Šä¸‹æ–‡ä¿¡æ¯
- [ ] é¿å…åœ¨å¾ªç¯ä¸­äº§ç”Ÿå¤§é‡æ—¥å¿—
- [ ] å¼‚å¸¸æ—¥å¿—ä½¿ç”¨ `exc_info=True`
- [ ] å…³é”®æ“ä½œçš„å¼€å§‹å’Œå®Œæˆéƒ½æœ‰æ—¥å¿—
- [ ] æ—¥å¿—æ¶ˆæ¯ç®€æ´æ˜äº†,æ˜“äºç†è§£

---

### 6. æ—¥å¿—å®¡æŸ¥å·¥å…·

**åœ¨æ”¹é€ å®Œæˆå,è¿è¡Œä»¥ä¸‹å‘½ä»¤æ£€æŸ¥æ—¥å¿—ä½¿ç”¨æƒ…å†µ**ï¼š

```bash
# è¿›å…¥ MCP Server ç›®å½•
cd src/<mcp-server-name>/

# 1. æ£€æŸ¥æ‰€æœ‰ logger.debug() - ç¡®è®¤æ˜¯å¦åº”è¯¥ç”¨ INFO
grep -r "logger\.debug(" awslabs/ --include="*.py" -B 2 -A 2 | less

# 2. æ£€æŸ¥æ‰€æœ‰ logger.warning() - ç¡®è®¤æ˜¯å¦çœŸçš„æ˜¯ WARNING
grep -r "logger\.warning(" awslabs/ --include="*.py" -B 2 -A 2 | less

# 3. æ£€æŸ¥å¯èƒ½çš„æ•æ„Ÿä¿¡æ¯æ³„éœ²
grep -r "secret\|password\|token\|access.*key" awslabs/ --include="*.py" | grep "logger\."

# 4. ç»Ÿè®¡å„çº§åˆ«æ—¥å¿—æ•°é‡
echo "DEBUG: $(grep -r 'logger\.debug(' awslabs/ --include='*.py' | wc -l)"
echo "INFO: $(grep -r 'logger\.info(' awslabs/ --include='*.py' | wc -l)"
echo "WARNING: $(grep -r 'logger\.warning(' awslabs/ --include='*.py' | wc -l)"
echo "ERROR: $(grep -r 'logger\.error(' awslabs/ --include='*.py' | wc -l)"
echo "CRITICAL: $(grep -r 'logger\.critical(' awslabs/ --include='*.py' | wc -l)"
```

---

### 7. æ—¥å¿—ä¿®å¤å¿«é€Ÿå‚è€ƒ

**ä½¿ç”¨ä»¥ä¸‹æ¨¡æ¿å¿«é€Ÿä¿®å¤æ—¥å¿—çº§åˆ«é—®é¢˜**ï¼š

```bash
# æ‰¹é‡æŸ¥æ‰¾éœ€è¦ä¿®å¤çš„æ—¥å¿—
grep -r "logger\.debug.*âœ…" awslabs/ --include="*.py"  # DEBUG ä¸­ä¸åº”è¯¥æœ‰ âœ…
grep -r "logger\.debug.*å¼€å§‹" awslabs/ --include="*.py"  # "å¼€å§‹" åº”è¯¥ç”¨ INFO
grep -r "logger\.debug.*å®Œæˆ" awslabs/ --include="*.py"  # "å®Œæˆ" åº”è¯¥ç”¨ INFO
grep -r "logger\.info.*âš ï¸" awslabs/ --include="*.py"    # âš ï¸ åº”è¯¥ç”¨ WARNING
grep -r "logger\.warning.*âŒ" awslabs/ --include="*.py" # âŒ åº”è¯¥ç”¨ ERROR
```

**ä¿®å¤ç¤ºä¾‹**ï¼š
```bash
# ä½¿ç”¨ sed æ‰¹é‡ä¿®å¤ï¼ˆè°¨æ…ä½¿ç”¨ï¼Œå»ºè®®å…ˆå¤‡ä»½ï¼‰
# ç¤ºä¾‹ï¼šå°† logger.debug("âœ… ä¿®æ”¹ä¸º logger.info("âœ…
sed -i '' 's/logger\.debug("âœ…/logger.info("âœ…/g' awslabs/**/*.py

# ç¤ºä¾‹ï¼šå°† logger.info("âš ï¸ ä¿®æ”¹ä¸º logger.warning("âš ï¸
sed -i '' 's/logger\.info("âš ï¸/logger.warning("âš ï¸/g' awslabs/**/*.py
```

---

### 8. æ—¥å¿—é…ç½®ç¤ºä¾‹

#### 8.1 server.py ä¸­çš„æ—¥å¿—é…ç½®

```python
# awslabs/your_mcp_server/server.py
import logging
import os

# é…ç½®æ—¥å¿—
log_level = os.getenv('LOG_LEVEL', 'INFO').upper()
logging.basicConfig(
    level=getattr(logging, log_level),
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)

logger = logging.getLogger(__name__)
logger.info(f"æ—¥å¿—çº§åˆ«: {log_level}")

# OpenTelemetry ä¼šè‡ªåŠ¨æ³¨å…¥ trace_id å’Œ span_id
```

#### 8.2 .env é…ç½®

```bash
# .env.development
LOG_LEVEL=DEBUG

# .env.production
LOG_LEVEL=INFO
```

#### 8.3 Dockerfile é…ç½®

```dockerfile
# Dockerfile-AgentCore-Runtime
ENV LOG_LEVEL=INFO
```

---

### 9. ç›¸å…³æ–‡æ¡£

**å‚è€ƒæ–‡æ¡£**ï¼š
- `costq/docs/01_å‚è€ƒä»£ç /æ—¥å¿—çº§åˆ«ä½¿ç”¨è§„èŒƒ.md`ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
- [Python Logging Best Practices](https://docs.python.org/3/howto/logging.html)

**ä¿®å¤è®°å½•**ï¼š
- è§æœ€è¿‘çš„æ—¥å¿—çº§åˆ«ä¿®å¤æäº¤
- å‚è€ƒ `billing-cost-management-mcp-server` çš„æ—¥å¿—ä¿®å¤

---

## âœ… æ”¹é€ éªŒè¯

### 1. å•å…ƒæµ‹è¯•
```python
# tests/test_account_context.py
import pytest
from awslabs.your_mcp_server.server import _setup_account_context
from awslabs.your_mcp_server.server import AccountNotFoundError

@pytest.mark.asyncio
async def test_setup_account_context_aksk():
    """æµ‹è¯• AKSK è´¦å·å‡­è¯è®¾ç½®"""
    result = await _setup_account_context("test-aksk-account-id")
    assert result["auth_type"] == "aksk"
    assert result["account_id"] is not None

@pytest.mark.asyncio
async def test_setup_account_context_iam_role():
    """æµ‹è¯• IAM Role è´¦å·å‡­è¯è®¾ç½®"""
    result = await _setup_account_context("test-role-account-id")
    assert result["auth_type"] == "iam_role"
    assert result["account_id"] is not None

@pytest.mark.asyncio
async def test_setup_account_context_not_found():
    """æµ‹è¯•è´¦å·ä¸å­˜åœ¨å¼‚å¸¸"""
    with pytest.raises(AccountNotFoundError):
        await _setup_account_context("non-existent-account")
```

### 2. æœ¬åœ°æµ‹è¯•
```bash
# å¯åŠ¨ MCP Server
python -m awslabs.your_mcp_server.server

# é¢„æœŸè¾“å‡º
INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
```

### 3. æ‰‹åŠ¨éªŒè¯æ¸…å•
- [ ] AKSK è´¦å·å‡­è¯æ­£å¸¸
- [ ] IAM Role è´¦å·å‡­è¯æ­£å¸¸
- [ ] External ID æ­£ç¡®ä¼ é€’
- [ ] Session Token å¤„ç†æ­£å¸¸
- [ ] å¤šè´¦å·åˆ‡æ¢æ­£å¸¸
- [ ] é»˜è®¤å‡­è¯ï¼ˆæ—  target_account_idï¼‰æ­£å¸¸
- [ ] æ‰€æœ‰å¼‚å¸¸å¤„ç†æ­£å¸¸
- [ ] æ—¥å¿—ä¸åŒ…å«æ•æ„Ÿä¿¡æ¯

---

## ğŸ³ Docker é•œåƒæ„å»ºå’Œéƒ¨ç½²

### Step 5: åˆ›å»º Dockerfile-AgentCore-Runtime

#### 5.1 ç›´æ¥å¤åˆ¶ Dockerfile

```bash
cd src/<mcp-server-name>/

# âœ… ç›´æ¥å¤åˆ¶
cp ../cloudtrail-mcp-server/Dockerfile-AgentCore-Runtime ./
```

#### 5.2 ä¿®æ”¹å¯åŠ¨å‘½ä»¤

**ä¿®æ”¹ Dockerfile æœ€åä¸€è¡Œçš„ CMD**ï¼š

```dockerfile
# åŸå§‹ï¼ˆcloudtrailï¼‰
CMD ["opentelemetry-instrument", "python", "-m", "awslabs.cloudtrail_mcp_server.server"]

# ä¿®æ”¹ä¸ºä½ çš„åŒ…å
CMD ["opentelemetry-instrument", "python", "-m", "awslabs.your_mcp_server.server"]
```

**å¿«é€Ÿä¿®æ”¹è„šæœ¬**ï¼š
```bash
# è‡ªåŠ¨ä¿®æ”¹ CMDï¼ˆmacOSï¼‰
sed -i '' 's/awslabs\.cloudtrail_mcp_server/awslabs.your_mcp_server/' Dockerfile-AgentCore-Runtime

# éªŒè¯ä¿®æ”¹
grep "CMD" Dockerfile-AgentCore-Runtime
```

---

#### 5.3 Dockerfile å…³é”®å†…å®¹

**å·²åŒ…å«çš„é‡è¦é…ç½®**ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰ï¼š

1. **å¤åˆ¶å‡­è¯æœåŠ¡**ï¼š
   ```dockerfile
   COPY --chown=app:app ./cred_extract_services /app/cred_extract_services
   ```

2. **å®‰è£…é¢å¤–ä¾èµ–**ï¼š
   ```dockerfile
   RUN pip install --no-cache-dir uv && \
       uv pip install --python /app/.venv/bin/python \
       aws-opentelemetry-distro==0.12.2 \
       sqlalchemy>=2.0.0 \
       psycopg2-binary>=2.9.0 \
       cryptography>=41.0.0
   ```

3. **æš´éœ²ç«¯å£**ï¼š
   ```dockerfile
   EXPOSE 9000
   EXPOSE 8000
   EXPOSE 8080
   ```

4. **ç¯å¢ƒå˜é‡**ï¼š
   ```dockerfile
   ENV UV_SYSTEM_PYTHON=1 \
       UV_NO_PROGRESS=1 \
       DOCKER_CONTAINER=1 \
       AWS_REGION=ap-northeast-1 \
       AWS_DEFAULT_REGION=ap-northeast-1
   ```

---

### Step 6: æ„å»ºå’Œæ¨é€é•œåƒ

#### 6.1 ä½¿ç”¨é€šç”¨éƒ¨ç½²è„šæœ¬ï¼ˆæ¨èâ­ï¼‰

```bash
# ä»é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
bash costq/scripts/build_and_push_template.sh <mcp-server-name>

# ç¤ºä¾‹
bash costq/scripts/build_and_push_template.sh your-mcp-server
```

**è„šæœ¬ä¼šè‡ªåŠ¨**ï¼š
1. âœ… ç™»å½• ECR
2. âœ… æ„å»º ARM64 é•œåƒ
3. âœ… æ‰“æ ‡ç­¾ï¼ˆ`latest` + æ—¶é—´æˆ³ï¼‰
4. âœ… æ¨é€åˆ° ECR

---

#### 6.2 æ‰‹åŠ¨æ„å»ºï¼ˆå¯é€‰ï¼‰

**å¦‚æœä¸ä½¿ç”¨è„šæœ¬ï¼Œå¯ä»¥æ‰‹åŠ¨æ‰§è¡Œ**ï¼š

```bash
cd src/<mcp-server-name>/

# 1. ç™»å½• ECR
aws ecr get-login-password --region ap-northeast-1 --profile 3532 | \
  docker login --username AWS --password-stdin <account-id>.dkr.ecr.ap-northeast-1.amazonaws.com

# 2. æ„å»ºé•œåƒ
docker buildx build \
  --platform linux/arm64 \
  -f Dockerfile-AgentCore-Runtime \
  -t <ecr-url>/<mcp-server-name>:latest \
  --load \
  .

# 3. æ¨é€é•œåƒ
docker push <ecr-url>/<mcp-server-name>:latest
```

---

### Step 7: æ›´æ–° Runtime å’ŒéªŒè¯

#### 7.1 æ›´æ–° Runtime
```bash
# ä½¿ç”¨ AWS CLI æ›´æ–°
aws bedrock-agentcore-control update-runtime \
  --profile 3532 \
  --region ap-northeast-1 \
  --runtime-identifier <runtime-id> \
  --container-image <ecr-url>/<mcp-server-name>:latest
```

#### 7.2 åˆ·æ–° Gateway
âš ï¸ **é‡è¦**ï¼šæŒ‰ç…§ DEEPV.md è¯´æ˜ï¼Œéœ€è¦æ‰‹åŠ¨åˆ·æ–° Gateway

#### 7.3 éªŒè¯éƒ¨ç½²

```bash
# æŸ¥çœ‹æ—¥å¿—
kubectl logs -f -n costq-fastapi deployment/costq-fastapi

# éªŒè¯å¥åº·æ£€æŸ¥
curl http://<gateway-url>/health

# æµ‹è¯• API
curl -X POST http://<gateway-url>/mcp \
  -H "Content-Type: application/json" \
  -d '{"method": "tools/list"}'
```

---

## âš ï¸ Step 8: æ£€æŸ¥å¤æ‚å‚æ•°ç±»å‹å…¼å®¹æ€§

### 8.1 èƒŒæ™¯ï¼šfilter_expression å‚æ•°ç±»å‹é—®é¢˜

**åœ¨æ”¹é€ è¿‡ç¨‹ä¸­,å¿…é¡»æ£€æŸ¥æ˜¯å¦æœ‰å¤æ‚å‚æ•°ç±»å‹ï¼ˆå¦‚ `dict`ã€åµŒå¥—å¯¹è±¡ç­‰ï¼‰,å®ƒä»¬å¯èƒ½è§¦å‘ FastMCP/Gateway/Runtime çš„åºåˆ—åŒ–å…¼å®¹æ€§é—®é¢˜ã€‚**

#### 8.1.1 é—®é¢˜ç—‡çŠ¶

**å…¸å‹é”™è¯¯**ï¼š
```
Error executing tool xxx: 1 validation error for function_name
Arguments\nparameter_name\n
Input should be a valid string [type=string_type, input_value={'key': 'value'}, input_type=dict]
```

**è°ƒç”¨é“¾**ï¼š
```
æ¨¡å‹
  â†“
AgentCore Gateway (å¯èƒ½åºåˆ—åŒ– dict â†’ JSON string)
  â†“
AgentCore Runtime
  â†“
MCP Server FastMCP (Pydantic éªŒè¯)
  â†“
Tool Function
```

---

#### 8.1.2 é—®é¢˜æ ¹æº

**ä¸‰å±‚é—®é¢˜å åŠ **ï¼š

1. **FastMCP Schema ç”Ÿæˆç¼ºé™·**
   - `dict` ç±»å‹æ— æ³•ç”Ÿæˆæ­£ç¡®çš„ `type: object` Schema
   - å¯¼è‡´ OpenAPI Schema ä¸å®Œæ•´æˆ–é”™è¯¯

2. **Gateway åºåˆ—åŒ–è¡Œä¸ºä¸ç¡®å®š**
   - Schema è¯´ `type: object` â†’ Gateway åºåˆ—åŒ–ä¸º JSON string âœ…
   - Schema è¯´ `type: string` â†’ Gateway ä¸åºåˆ—åŒ–,ä¼ é€’åŸå§‹ç±»å‹ âŒ
   - Schema ç¼ºå°‘ `type` â†’ Gateway è¡Œä¸ºæœªå®šä¹‰ âŒ

3. **Pydantic éªŒè¯æ‹¦æˆª**
   - å‡½æ•°ç­¾åå®šä¹‰ä¸º `str`,ä½†æ¥æ”¶åˆ° `dict` â†’ ValidationError âŒ
   - Pydantic åœ¨å‡½æ•°è°ƒç”¨å‰éªŒè¯,å‡½æ•°ä½“å†…çš„è½¬æ¢é€»è¾‘æ— æ³•æ‰§è¡Œ

---

#### 8.1.3 æ£€æŸ¥æ–¹æ³•

```bash
# æŸ¥æ‰¾æ‰€æœ‰ä½¿ç”¨ dict ç±»å‹å‚æ•°çš„å‡½æ•°
cd src/<mcp-server-name>/
grep -r "Optional\[dict\]" awslabs/ --include="*.py"
grep -r ": dict" awslabs/ --include="*.py"
grep -r "Dict\[" awslabs/ --include="*.py"
```

**éœ€è¦å…³æ³¨çš„å‚æ•°ç±»å‹**ï¼š
- âœ… `Optional[dict]` - **é«˜é£é™©**
- âœ… `dict[str, Any]` - **é«˜é£é™©**
- âœ… `List[dict]` - **é«˜é£é™©**
- âš ï¸ `Optional[str]` - å¦‚æœå®é™…ä¼ é€’ JSON å¯¹è±¡ - **ä¸­é£é™©**
- âš ï¸ åµŒå¥— Pydantic Model - **ä¸­é£é™©**

---

#### 8.1.4 è§£å†³æ–¹æ¡ˆï¼šUnion ç±»å‹ + æ™ºèƒ½è½¬æ¢

**æ¨èæ¨¡å¼**ï¼šåŒæ—¶æ”¯æŒ `str` å’Œ `dict` è¾“å…¥

```python
from typing import Union
import json

# 1. å®šä¹‰æ™ºèƒ½è½¬æ¢å‡½æ•°ï¼ˆå¯å¤ç”¨ï¼‰
def parse_complex_param(
    param: Optional[Union[str, dict]],
    function_name: str,
    param_name: str = "complex_param"
) -> Optional[dict]:
    """è§£æå¤æ‚å‚æ•°,æ”¯æŒ JSON å­—ç¬¦ä¸²å’Œ dict å¯¹è±¡.

    Args:
        param: JSON å­—ç¬¦ä¸²æˆ– dict å¯¹è±¡
        function_name: è°ƒç”¨æ­¤å‡½æ•°çš„å‡½æ•°åï¼ˆç”¨äºæ—¥å¿—ï¼‰
        param_name: å‚æ•°åï¼ˆç”¨äºæ—¥å¿—ï¼‰

    Returns:
        è§£æåçš„ dict æˆ– None

    Raises:
        ValueError: JSON æ ¼å¼æ— æ•ˆ
    """
    if not param:
        return None

    # ğŸ” è°ƒè¯•æ—¥å¿—: è®°å½•æ¥æ”¶åˆ°çš„ç±»å‹
    logger.info(
        "ğŸ” [%s] %s type: %s, value: %s",
        function_name,
        param_name,
        type(param).__name__,
        str(param)[:200]
    )

    # âš¡ æ™ºèƒ½å¤„ç†: å¦‚æœæ˜¯ dict,ç›´æ¥ä½¿ç”¨
    if isinstance(param, dict):
        logger.warning(
            "âš ï¸ [%s] Received dict for %s instead of string! Auto-converting...",
            function_name,
            param_name
        )
        return param

    # âœ… æ ‡å‡†å¤„ç†: JSON å­—ç¬¦ä¸²è§£æ
    try:
        parsed = json.loads(param)
        logger.info("âœ… [%s] Successfully parsed %s", function_name, param_name)
        return parsed
    except json.JSONDecodeError as e:
        logger.error(
            "âŒ [%s] Invalid JSON format for %s: %s",
            function_name,
            param_name,
            str(e)
        )
        raise ValueError(f"Invalid JSON format for {param_name}: {e}")


# 2. åœ¨ tool å‡½æ•°ä¸­ä½¿ç”¨
@server.tool(name="example-tool", description="...")
async def example_tool(
    ctx: Context,
    filter_expression: Annotated[
        Optional[Union[str, dict]],  # âœ… åŒæ—¶æ”¯æŒ str å’Œ dict
        Field(
            description=(
                "Filter expression as a JSON string or dict object. "
                "Example: '{\"Dimensions\": {\"Key\": \"SERVICE\", \"Values\": [\"EC2\"]}}'"
            )
        ),
    ] = None,
    tags: Annotated[
        Optional[Union[str, List[dict]]],  # âœ… å¤æ‚åµŒå¥—ç±»å‹ä¹Ÿé€‚ç”¨
        Field(description="Tags as JSON string or list of dicts")
    ] = None,
    target_account_id: Optional[str] = None,
) -> dict[str, Any]:
    try:
        # è´¦å·ä¸Šä¸‹æ–‡åˆå§‹åŒ–
        if target_account_id:
            await _setup_account_context(target_account_id)

        # âœ… æ™ºèƒ½è§£æå¤æ‚å‚æ•°
        filter_dict = parse_complex_param(
            filter_expression,
            "example_tool",
            "filter_expression"
        )

        # è§£æ tags (å¦‚æœæœ‰)
        tags_list = None
        if tags:
            if isinstance(tags, list):
                tags_list = tags
            else:
                tags_list = json.loads(tags)

        # ä¸šåŠ¡é€»è¾‘
        client = create_aws_client("service", "region")
        response = client.some_api_call(
            Filter=filter_dict,
            Tags=tags_list
        )
        return format_response("success", response)

    except Exception as e:
        return await handle_aws_error(ctx, e, "operation", "Service")
```

---

#### 8.1.5 æ”¹é€ æ£€æŸ¥æ¸…å•

**åœ¨æ”¹é€ ä»»ä½• MCP Server æ—¶,å¿…é¡»å®Œæˆä»¥ä¸‹æ£€æŸ¥**ï¼š

- [ ] æŸ¥æ‰¾æ‰€æœ‰ `dict` ç±»å‹å‚æ•°
- [ ] æŸ¥æ‰¾æ‰€æœ‰åµŒå¥—å¯¹è±¡å‚æ•°ï¼ˆ`List[dict]` ç­‰ï¼‰
- [ ] æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½æ¥æ”¶ JSON çš„ `str` å‚æ•°
- [ ] å¯¹äºæ¯ä¸ªå¤æ‚å‚æ•°:
  - [ ] å‚æ•°ç±»å‹æ”¹ä¸º `Union[str, dict]` (æˆ–ç›¸åº”çš„ Union ç±»å‹)
  - [ ] æ·»åŠ å‚æ•°æè¿°: "JSON string or dict object"
  - [ ] æ·»åŠ æ™ºèƒ½è§£æé€»è¾‘
  - [ ] æ·»åŠ è°ƒè¯•æ—¥å¿—ï¼ˆè®°å½•æ¥æ”¶åˆ°çš„ç±»å‹ï¼‰
  - [ ] æ·»åŠ å•å…ƒæµ‹è¯•ï¼ˆæµ‹è¯•ä¸¤ç§è¾“å…¥æ ¼å¼ï¼‰

---

#### 8.1.6 ç¤ºä¾‹ï¼šå®Œæ•´çš„æ”¹é€ å¯¹æ¯”

**æ”¹é€ å‰ï¼ˆå¯èƒ½å‡ºé”™ï¼‰**ï¼š
```python
@server.tool(name="get-resources", description="...")
async def get_resources(
    ctx: Context,
    filter_expression: Annotated[
        Optional[dict],  # âŒ å¯èƒ½è§¦å‘ Schema ç”Ÿæˆé—®é¢˜
        Field(description="Filter expression")
    ] = None,
) -> dict[str, Any]:
    client = create_aws_client("service", "region")

    # âŒ å¦‚æœ Gateway ä¼ é€’çš„æ˜¯ JSON string,è¿™é‡Œä¼šå¤±è´¥
    response = client.list_resources(Filter=filter_expression)
    return format_response("success", response)
```

**æ”¹é€ åï¼ˆå…¼å®¹ä¸¤ç§ç±»å‹ï¼‰**ï¼š
```python
@server.tool(name="get-resources", description="...")
async def get_resources(
    ctx: Context,
    filter_expression: Annotated[
        Optional[Union[str, dict]],  # âœ… åŒæ—¶æ”¯æŒ
        Field(
            description=(
                "Filter expression as a JSON string or dict object. "
                "Example: '{\"Key\": \"Value\"}'"
            )
        ),
    ] = None,
    target_account_id: Optional[str] = None,
) -> dict[str, Any]:
    try:
        # è´¦å·ä¸Šä¸‹æ–‡åˆå§‹åŒ–
        if target_account_id:
            await _setup_account_context(target_account_id)

        # âœ… æ™ºèƒ½è§£æ
        filter_dict = parse_complex_param(
            filter_expression,
            "get_resources",
            "filter_expression"
        )

        client = create_aws_client("service", "region")
        response = client.list_resources(Filter=filter_dict)
        return format_response("success", response)

    except ValueError as e:
        return format_response('error', {'error_type': 'invalid_json'}, str(e))
    except Exception as e:
        return await handle_aws_error(ctx, e, "list_resources", "Service")
```

---

#### 8.1.7 æµ‹è¯•éªŒè¯

**å•å…ƒæµ‹è¯•ï¼ˆå¿…é¡»åŒ…å«ä¸¤ç§è¾“å…¥æ ¼å¼ï¼‰**ï¼š
```python
import pytest
from awslabs.your_mcp_server.tools import parse_complex_param

def test_parse_complex_param_dict():
    """æµ‹è¯• dict è¾“å…¥"""
    result = parse_complex_param(
        {"Key": "Value"},
        "test_func",
        "filter"
    )
    assert result == {"Key": "Value"}

def test_parse_complex_param_json_string():
    """æµ‹è¯• JSON å­—ç¬¦ä¸²è¾“å…¥"""
    result = parse_complex_param(
        '{"Key": "Value"}',
        "test_func",
        "filter"
    )
    assert result == {"Key": "Value"}

def test_parse_complex_param_none():
    """æµ‹è¯• None è¾“å…¥"""
    result = parse_complex_param(None, "test_func", "filter")
    assert result is None

def test_parse_complex_param_invalid_json():
    """æµ‹è¯•æ— æ•ˆ JSON"""
    with pytest.raises(ValueError, match="Invalid JSON format"):
        parse_complex_param(
            "invalid json",
            "test_func",
            "filter"
        )
```

---

#### 8.1.8 ç›¸å…³æ–‡æ¡£

**è¯¦ç»†åˆ†æ**ï¼š
- `costq/docs/20260120_filter_expressionåˆ†æ/é—®é¢˜æ€»ç»“ä¸ä¿®å¤æ–¹æ¡ˆ.md`
- `costq/docs/20260120_filter_expressionåˆ†æ/step6_æ ¹æœ¬åŸå› åˆ†æ.md`

**å‚è€ƒä»£ç **ï¼š
- `src/costq-risp-mcp-server/handlers/sp_handler.py` (å·²ä¿®å¤)
- `src/costq-risp-mcp-server/handlers/ri_handler.py` (å·²ä¿®å¤)

---

## ğŸ› å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜ 1: ModuleNotFoundError: No module named 'cred_extract_services'
**åŸå› **ï¼šæœªæ­£ç¡®å¤åˆ¶ cred_extract_services ç›®å½•

**è§£å†³**ï¼š
```bash
# ç¡®è®¤ç›®å½•å­˜åœ¨
ls -la cred_extract_services/

# é‡æ–°å¤åˆ¶
cp -r ../cloudtrail-mcp-server/cred_extract_services ./
```

### é—®é¢˜ 2: DatabaseConnectionError
**åŸå› **ï¼šæ•°æ®åº“é…ç½®é”™è¯¯

**è§£å†³**ï¼š
```bash
# æ£€æŸ¥ç¯å¢ƒå˜é‡
echo $DATABASE_URL
echo $RDS_SECRET_NAME

# æµ‹è¯•æ•°æ®åº“è¿æ¥
python -c "
from cred_extract_services.database import query_account
import asyncio
result = asyncio.run(query_account('test-account-id'))
print(result)
"
```

### é—®é¢˜ 3: CredentialDecryptionError
**åŸå› **ï¼šåŠ å¯†å¯†é’¥é”™è¯¯

**è§£å†³**ï¼š
```bash
# æ£€æŸ¥åŠ å¯†å¯†é’¥
echo $ENCRYPTION_KEY | base64 -d | xxd  # åº”è¯¥æ˜¯ 32 å­—èŠ‚

# é‡æ–°ç”Ÿæˆå¯†é’¥ï¼ˆä»…æµ‹è¯•ç¯å¢ƒï¼‰
python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"
```

### é—®é¢˜ 4: AssumeRoleError
**åŸå› **ï¼šIAM Role é…ç½®é”™è¯¯

**è§£å†³**ï¼š
```bash
# æ£€æŸ¥ Role ARN å’Œ External ID
python -c "
from cred_extract_services.database import query_account
import asyncio
account = asyncio.run(query_account('test-role-account-id'))
print(f'Role ARN: {account[\"role_arn\"]}')
print(f'External ID: {account[\"external_id\"]}')
"

# æµ‹è¯• AssumeRole
aws sts assume-role \
  --role-arn <role-arn> \
  --role-session-name test \
  --external-id <external-id>
```

### é—®é¢˜ 5: å¯åŠ¨åæ— æ³•è¿æ¥ï¼ˆ127.0.0.1:8000ï¼‰
**åŸå› **ï¼šFastMCP æœªé…ç½® `host="0.0.0.0"`

**è§£å†³**ï¼š
```python
# æ£€æŸ¥ server.py
mcp = FastMCP(
    name='awslabs.your-mcp-server',
    host="0.0.0.0",  # âœ… å¿…é¡»ï¼
    stateless_http=True
)
```

---

## ğŸ“ æ”¹é€ æ£€æŸ¥æ¸…å•

### ä»£ç ä¿®æ”¹
- [ ] å¤åˆ¶ `cred_extract_services/` ç›®å½•
- [ ] ä¿®æ”¹ `server.py` FastMCP é…ç½®ï¼ˆæ·»åŠ  `host` å’Œ `stateless_http`ï¼‰
- [ ] æ·»åŠ  `_setup_account_context()` å‡½æ•°åˆ° `server.py`
- [ ] ä¿®æ”¹æ‰€æœ‰ tool å‡½æ•°ï¼ˆæ·»åŠ  `target_account_id` å‚æ•°ï¼‰
- [ ] æ·»åŠ è´¦å·ä¸Šä¸‹æ–‡åˆå§‹åŒ–ä»£ç 
- [ ] æ·»åŠ å¼‚å¸¸å¤„ç†
- [ ] æ›´æ–° tool æè¿°æ–‡æ¡£

### æµ‹è¯•éªŒè¯
- [ ] å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] æœ¬åœ°å¯åŠ¨æµ‹è¯•é€šè¿‡
- [ ] æ‰‹åŠ¨éªŒè¯é€šè¿‡
- [ ] å¼‚å¸¸å¤„ç†éªŒè¯é€šè¿‡

### Docker éƒ¨ç½²
- [ ] å¤åˆ¶ `Dockerfile-AgentCore-Runtime`
- [ ] ä¿®æ”¹ CMD å¯åŠ¨å‘½ä»¤
- [ ] æ„å»ºé•œåƒæˆåŠŸ
- [ ] æ¨é€åˆ° ECR æˆåŠŸ
- [ ] æ›´æ–° Runtime æˆåŠŸ
- [ ] åˆ·æ–° Gateway

### æ–‡æ¡£æ›´æ–°
- [ ] README æ›´æ–°
- [ ] API æ–‡æ¡£æ›´æ–°
- [ ] ä½¿ç”¨ç¤ºä¾‹æ›´æ–°

---

## ğŸ‰ æ”¹é€ å®Œæˆ

æ­å–œï¼ä½ å·²ç»å®Œæˆäº† MCP Server çš„å¤šè´¦å·æ”¹é€ ã€‚

**ä¸‹ä¸€æ­¥**ï¼š
1. æäº¤ä»£ç åˆ° Git
2. æ›´æ–°é¡¹ç›®æ–‡æ¡£
3. é€šçŸ¥å›¢é˜Ÿæˆå‘˜æ–°åŠŸèƒ½

**å‚è€ƒèµ„æ–™**ï¼š
- [æ”¹é€ éœ€æ±‚åˆ†æ](./01_æ”¹é€ éœ€æ±‚åˆ†æ.md)
- [CloudTrail MCP Server æºç ](../../src/cloudtrail-mcp-server/)
- [æ—¥å¿—è¿ç§»æŒ‡å—](../20260118_CloudTrail_MCPé—®é¢˜/20250119_loguru_è¿ç§»åˆ°_logging.md)