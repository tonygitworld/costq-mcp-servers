# MCP Server å¤šè´¦å·æ”¹é€ æ­¥éª¤æŒ‡å—

> æœ¬æ–‡æ¡£æä¾›**è¯¦ç»†çš„ã€å¯æ‰§è¡Œçš„**æ”¹é€ æ­¥éª¤ï¼Œé€‚ç”¨äºæ‰€æœ‰éœ€è¦å¤šè´¦å·è®¿é—®èƒ½åŠ›çš„ MCP Serverã€‚

---

## ğŸ¯ å¿«é€Ÿå‚è€ƒï¼šå“ªäº›æ–‡ä»¶å¯ä»¥ç›´æ¥å¤åˆ¶ï¼Ÿ

| æ–‡ä»¶/ç›®å½• | æ˜¯å¦å¯å¤åˆ¶ | éœ€è¦ä¿®æ”¹ | è¯´æ˜ |
|-----------|-----------|---------|------|
| `cred_extract_services/` | âœ… **å¯ç›´æ¥å¤åˆ¶** | âŒ æ— éœ€ä¿®æ”¹ | å®Œå…¨é€šç”¨ï¼Œè‡ªåŒ…å«ï¼Œä¸ä¾èµ–é¡¹ç›®ä»£ç  |
| `Dockerfile-AgentCore-Runtime` | âœ… **å¯ç›´æ¥å¤åˆ¶** | âŒ æ— éœ€ä¿®æ”¹ | é€šç”¨æ¨¡æ¿ï¼Œä½¿ç”¨ç›¸å¯¹è·¯å¾„å’Œç¯å¢ƒå˜é‡ |
| `entrypoint.py` | âš ï¸ **éœ€è¦ä¿®æ”¹** | âœ… ä¿®æ”¹ 1 å¤„ | éœ€è¦ä¿®æ”¹å¯¼å…¥è·¯å¾„ï¼ˆ`from awslabs.<package>_mcp_server.server import mcp, setup`ï¼‰ |
| `costq/scripts/build_and_push_*.sh` | âš ï¸ **éœ€è¦ä¿®æ”¹** | âœ… ä¿®æ”¹ 1 å¤„ | éœ€è¦ä¿®æ”¹ `MCP_SERVER_NAME` å˜é‡ |

**æ€»ç»“**ï¼š
- âœ… **80% çš„æ–‡ä»¶å¯ä»¥ç›´æ¥å¤åˆ¶**ï¼ˆcred_extract_services/ + Dockerfileï¼‰
- âš ï¸ **20% éœ€è¦ç®€å•ä¿®æ”¹**ï¼ˆentrypoint.py æ”¹ 1 è¡Œï¼Œéƒ¨ç½²è„šæœ¬æ”¹ 1 ä¸ªå˜é‡ï¼‰
- ğŸš€ **æ”¹é€ é€Ÿåº¦æå¿«**ï¼šé¢„è®¡ 10-15 åˆ†é’Ÿå®ŒæˆåŸºç¡€æ”¹é€ 

---

## ğŸ“‹ æ”¹é€ å‰å‡†å¤‡

### 1. ç¡®è®¤æ”¹é€ èŒƒå›´
- [ ] ç¡®è®¤ MCP Server åç§°å’Œè·¯å¾„
- [ ] ç¡®è®¤æ˜¯å¦éœ€è¦å¤šè´¦å·è®¿é—®èƒ½åŠ›
- [ ] å¤‡ä»½åŸå§‹ä»£ç ï¼ˆgit commitï¼‰

### 2. ç¯å¢ƒå‡†å¤‡
```bash
# 1. å®‰è£…ä¾èµ–
cd src/<mcp-server-name>
pip install sqlalchemy cryptography psycopg2-binary

# 2. é…ç½®ç¯å¢ƒå˜é‡ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
cat > .env << EOF
DATABASE_URL=postgresql://user:pass@localhost:5432/costq
ENCRYPTION_KEY=<base64-encoded-fernet-key>
AWS_REGION=us-east-1
FASTMCP_TRANSPORT=stdio
EOF
```

---

## ğŸ”§ æ”¹é€ æ­¥éª¤

### Step 1: å¤åˆ¶å‡­è¯æå–æœåŠ¡å±‚ï¼ˆâœ… å¯ç›´æ¥å¤åˆ¶ï¼‰

#### 1.1 åˆ›å»ºç›®å½•å¹¶å¤åˆ¶
```bash
cd src/<mcp-server-name>/

# âœ… ç›´æ¥å¤åˆ¶æ•´ä¸ªç›®å½•ï¼ˆå®Œå…¨é€šç”¨ï¼Œæ— éœ€ä¿®æ”¹ï¼‰
cp -r ../billing-cost-management-mcp-server/cred_extract_services ./
```

**ä¸ºä»€ä¹ˆå¯ä»¥ç›´æ¥å¤åˆ¶ï¼Ÿ**
- âœ… å®Œå…¨è‡ªåŒ…å«ï¼Œä¸ä¾èµ–é¡¹ç›®ç‰¹å®šä»£ç 
- âœ… æ²¡æœ‰ç¡¬ç¼–ç çš„é¡¹ç›®åç§°
- âœ… æ‰€æœ‰é…ç½®ä»ç¯å¢ƒå˜é‡è¯»å–
- âœ… å¯ä»¥åœ¨ä»»ä½• MCP Server ä¸­ç›´æ¥ä½¿ç”¨

**åŒ…å«çš„æ–‡ä»¶**ï¼š
```
cred_extract_services/
â”œâ”€â”€ __init__.py           # å…¬å…±æ¥å£å¯¼å‡º
â”œâ”€â”€ aws_client.py         # STS AssumeRoleï¼ˆé€šç”¨ï¼‰
â”œâ”€â”€ context_manager.py    # ç¯å¢ƒå˜é‡ç®¡ç†ï¼ˆé€šç”¨ï¼‰
â”œâ”€â”€ credential_extractor.py  # å‡­è¯æå–æ ¸å¿ƒï¼ˆé€šç”¨ï¼‰
â”œâ”€â”€ crypto.py             # AKSK è§£å¯†ï¼ˆé€šç”¨ï¼‰
â”œâ”€â”€ database.py           # æ•°æ®åº“æŸ¥è¯¢ï¼ˆé€šç”¨ï¼‰
â””â”€â”€ exceptions.py         # è‡ªå®šä¹‰å¼‚å¸¸ï¼ˆé€šç”¨ï¼‰
```

**éªŒè¯**ï¼š
```bash
# æµ‹è¯•å¯¼å…¥
python -c "from cred_extract_services import extract_aws_credentials; print('âœ… å¯¼å…¥æˆåŠŸ')"
```

---

### Step 2: åˆ›å»ºç»Ÿä¸€å…¥å£ (entrypoint.py)ï¼ˆâš ï¸ éœ€è¦ä¿®æ”¹ï¼‰

#### 2.1 å¤åˆ¶å¹¶ä¿®æ”¹
```bash
# âš ï¸ å¤åˆ¶æ¨¡æ¿åéœ€è¦ä¿®æ”¹
cp ../billing-cost-management-mcp-server/entrypoint.py ./
```

**âš ï¸ å¿…é¡»ä¿®æ”¹çš„åœ°æ–¹**ï¼šåªæœ‰ 1 å¤„ï¼

```python
# åœ¨ main() å‡½æ•°ä¸­ï¼Œä¿®æ”¹å¯¼å…¥è·¯å¾„
# åŸå§‹ï¼ˆbilling-cost-management ä¸“ç”¨ï¼‰ï¼š
from awslabs.billing_cost_management_mcp_server.server import mcp, setup

# ä¿®æ”¹ä¸ºï¼ˆä½ çš„é¡¹ç›®ï¼‰ï¼š
from awslabs.<your_package_name>_mcp_server.server import mcp, setup
```

**ç¤ºä¾‹**ï¼š
```python
# CloudWatch MCP Server
from awslabs.cloudwatch_mcp_server.server import mcp, setup

# S3 MCP Server
from awslabs.s3_mcp_server.server import mcp, setup

# DynamoDB MCP Server
from awslabs.dynamodb_mcp_server.server import mcp, setup
```

---

#### 2.2 å®Œæ•´ä»£ç æ¨¡æ¿ï¼ˆå¯é€‰ï¼Œæ‰‹åŠ¨åˆ›å»ºï¼‰

**å¦‚æœä½ æƒ³æ‰‹åŠ¨åˆ›å»º entrypoint.pyï¼Œä½¿ç”¨ä»¥ä¸‹æ¨¡æ¿**ï¼š
```python
"""å‡­è¯æå–æœåŠ¡ä¸»å…¥å£

æä¾›ç»Ÿä¸€çš„å‡­è¯æå–å’Œä¸Šä¸‹æ–‡è®¾ç½®æ¥å£ã€‚
"""

import asyncio
import logging
import os
import sys

from cred_extract_services.context_manager import set_aws_credentials
from cred_extract_services.credential_extractor import extract_aws_credentials
from cred_extract_services.exceptions import (
    AccountNotFoundError,
    AssumeRoleError,
    CredentialDecryptionError,
    CredentialExtractionError,
    DatabaseConnectionError,
)

logger = logging.getLogger(__name__)

# å¯¼å‡ºå¼‚å¸¸ç±»
__all__ = [
    "_setup_account_context",
    "CredentialExtractionError",
    "AccountNotFoundError",
    "CredentialDecryptionError",
    "AssumeRoleError",
    "DatabaseConnectionError",
]


async def _setup_account_context(target_account_id: str) -> dict[str, str]:
    """è®¾ç½® AWS å‡­è¯ä¸Šä¸‹æ–‡

    Args:
        target_account_id: AWS è´¦å· ID

    Returns:
        å‡­è¯ä¿¡æ¯å­—å…¸ï¼ˆå·²è„±æ•ï¼‰

    Raises:
        AccountNotFoundError: è´¦å·ä¸å­˜åœ¨
        CredentialDecryptionError: å‡­è¯è§£å¯†å¤±è´¥
        AssumeRoleError: AssumeRole å¤±è´¥
        DatabaseConnectionError: æ•°æ®åº“è¿æ¥å¤±è´¥
    """
    logger.info("å¼€å§‹è®¾ç½® AWS å‡­è¯ä¸Šä¸‹æ–‡")

    # 1. æå–å‡­è¯
    credentials = await extract_aws_credentials(target_account_id)

    # 2. è®¾ç½®ç¯å¢ƒå˜é‡
    set_aws_credentials(
        access_key_id=credentials["access_key_id"],
        secret_access_key=credentials["secret_access_key"],
        session_token=credentials.get("session_token"),
        region=credentials["region"],
    )

    # 3. è¿”å›è„±æ•ä¿¡æ¯
    cred_info = {
        "account_id": credentials["account_id"],
        "account_alias": credentials.get("alias", "Unknown"),
        "auth_type": credentials["auth_type"],
        "region": credentials["region"],
    }

    logger.info(f"âœ… AWS å‡­è¯ä¸Šä¸‹æ–‡è®¾ç½®å®Œæˆ: {cred_info}")
    return cred_info


def main():
    """å¯åŠ¨ MCP Server"""
    # å»¶è¿Ÿå¯¼å…¥ï¼Œé¿å…å¾ªç¯ä¾èµ–
    from awslabs.<mcp_server_package>.server import mcp, setup

    transport = os.environ.get("FASTMCP_TRANSPORT", "streamable-http")
    host = os.environ.get("FASTMCP_HOST", "0.0.0.0")
    port = int(os.environ.get("FASTMCP_PORT", "8000"))
    stateless = os.environ.get("FASTMCP_STATELESS_HTTP", "true").lower() == "true"

    logger.info(f"ğŸš€ å¯åŠ¨ MCP Server: transport={transport}")

    asyncio.run(setup())

    if transport == "stdio":
        mcp.run(transport=transport)
    else:
        mcp.run(transport=transport, host=host, port=port, stateless_http=stateless)


if __name__ == "__main__":
    logging.basicConfig(
        level=logging.INFO,
        format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    )
    main()
```

**æ³¨æ„**ï¼š
- å°† `<mcp_server_package>` æ›¿æ¢ä¸ºå®é™…çš„åŒ…åï¼ˆå¦‚ `billing_cost_management_mcp_server`ï¼‰

---

### Step 3: ä¿®æ”¹æ‰€æœ‰ Tool å‡½æ•°

#### 3.1 å®šä½æ‰€æœ‰ Tool æ–‡ä»¶
```bash
# æŸ¥æ‰¾æ‰€æœ‰ tool æ–‡ä»¶
find awslabs -name "*_tools.py" -type f
```

#### 3.2 æ ‡å‡†æ”¹é€ æ¨¡æ¿

**æ”¹é€ å‰**ï¼š
```python
@server.tool(name="tool-name", description="...")
async def tool_function(
    ctx: Context,
    param1: str,
    param2: Optional[int] = None,
) -> Dict[str, Any]:
    try:
        # ä¸šåŠ¡é€»è¾‘
        client = create_aws_client("service", "region")
        response = client.some_api_call(param1=param1)
        return format_response("success", response)
    except Exception as e:
        return await handle_aws_error(ctx, e, "operation", "Service")
```

**æ”¹é€ å**ï¼š
```python
# 1. å¯¼å…¥å¼‚å¸¸ç±»ï¼ˆæ–‡ä»¶é¡¶éƒ¨ï¼‰
from entrypoint import (
    AccountNotFoundError,
    CredentialDecryptionError,
    AssumeRoleError,
    DatabaseConnectionError,
)

@server.tool(name="tool-name", description="...")
async def tool_function(
    ctx: Context,
    target_account_id: Optional[str] = None,  # âœ… æ–°å¢å‚æ•°ï¼ˆç¬¬2ä¸ªä½ç½®ï¼‰
    param1: str,
    param2: Optional[int] = None,
) -> Dict[str, Any]:
    try:
        # ===== è´¦å·ä¸Šä¸‹æ–‡åˆå§‹åŒ– =====
        if target_account_id:
            from entrypoint import _setup_account_context
            await _setup_account_context(target_account_id)

        # ===== åŸæœ‰é€»è¾‘ï¼ˆå®Œå…¨ä¸å˜ï¼‰=====
        client = create_aws_client("service", "region")
        response = client.some_api_call(param1=param1)
        return format_response("success", response)

    # ===== å¼‚å¸¸å¤„ç† =====
    except AccountNotFoundError:
        return format_response('error', {'error_type': 'account_not_found'},
                               'Account not found. Please check the account ID.')
    except CredentialDecryptionError:
        return format_response('error', {'error_type': 'credential_error'},
                               'Failed to decrypt credentials. Please contact administrator.')
    except AssumeRoleError:
        return format_response('error', {'error_type': 'assume_role_error'},
                               'Failed to assume role. Please check IAM role configuration.')
    except DatabaseConnectionError:
        return format_response('error', {'error_type': 'database_error'},
                               'Database connection failed. Please try again later.')
    except Exception as e:
        return await handle_aws_error(ctx, e, "operation", "Service")
```

#### 3.3 æ‰¹é‡ä¿®æ”¹è„šæœ¬ï¼ˆå¯é€‰ï¼‰
**åˆ›å»º Python è„šæœ¬**ï¼š
```python
# scripts/add_account_context.py
import re
import sys
from pathlib import Path

def add_account_context_to_tool(file_path: Path):
    """ç»™ tool å‡½æ•°æ·»åŠ è´¦å·ä¸Šä¸‹æ–‡æ”¯æŒ"""
    content = file_path.read_text()

    # 1. æ·»åŠ å¯¼å…¥ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    import_block = """
# Import account context exceptions
from entrypoint import (
    AccountNotFoundError,
    CredentialDecryptionError,
    AssumeRoleError,
    DatabaseConnectionError,
)
"""
    if "from entrypoint import" not in content:
        # åœ¨æœ€åä¸€ä¸ª import åæ·»åŠ 
        lines = content.split('\n')
        last_import_idx = 0
        for i, line in enumerate(lines):
            if line.startswith('import ') or line.startswith('from '):
                last_import_idx = i
        lines.insert(last_import_idx + 1, import_block)
        content = '\n'.join(lines)

    # 2. ä¿®æ”¹å‡½æ•°ç­¾åï¼ˆæ·»åŠ  target_account_idï¼‰
    # æ¨¡å¼ï¼šasync def function_name(ctx: Context, ...
    pattern = r'(async def \w+\(\s*ctx:\s*Context,)'
    replacement = r'\1\n    target_account_id: Optional[str] = None,'
    content = re.sub(pattern, replacement, content)

    # 3. æ·»åŠ è´¦å·ä¸Šä¸‹æ–‡åˆå§‹åŒ–ä»£ç 
    # åœ¨ try: åæ·»åŠ 
    context_init = """
        # ===== Account context initialization =====
        if target_account_id:
            from entrypoint import _setup_account_context
            await _setup_account_context(target_account_id)

        # ===== Original logic (unchanged) =====
"""
    content = content.replace("    try:\n", f"    try:\n{context_init}")

    # 4. æ·»åŠ å¼‚å¸¸å¤„ç†
    exception_block = """
    # ===== Exception handling =====
    except AccountNotFoundError:
        return format_response('error', {'error_type': 'account_not_found'},
                               'Account not found. Please check the account ID.')
    except CredentialDecryptionError:
        return format_response('error', {'error_type': 'credential_error'},
                               'Failed to decrypt credentials. Please contact administrator.')
    except AssumeRoleError:
        return format_response('error', {'error_type': 'assume_role_error'},
                               'Failed to assume role. Please check IAM role configuration.')
    except DatabaseConnectionError:
        return format_response('error', {'error_type': 'database_error'},
                               'Database connection failed. Please try again later.')
"""
    # åœ¨æœ€åçš„ except Exception å‰æ·»åŠ 
    content = re.sub(
        r'(\s+except Exception as e:)',
        exception_block + r'\1',
        content
    )

    # ä¿å­˜ä¿®æ”¹
    file_path.write_text(content)
    print(f"âœ… Modified: {file_path}")


if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("Usage: python add_account_context.py <tool_file.py>")
        sys.exit(1)

    for file_path in sys.argv[1:]:
        add_account_context_to_tool(Path(file_path))
```

**ä½¿ç”¨è„šæœ¬**ï¼š
```bash
# ä¿®æ”¹å•ä¸ªæ–‡ä»¶
python scripts/add_account_context.py awslabs/.../tools/example_tools.py

# æ‰¹é‡ä¿®æ”¹
find awslabs -name "*_tools.py" -exec python scripts/add_account_context.py {} \;
```

**âš ï¸ è­¦å‘Š**ï¼š
- è„šæœ¬å¯èƒ½æ— æ³•å¤„ç†æ‰€æœ‰è¾¹ç•Œæƒ…å†µ
- **å¿…é¡»äººå·¥å®¡æŸ¥æ¯ä¸ªä¿®æ”¹**
- å»ºè®®å…ˆåœ¨æµ‹è¯•æ–‡ä»¶ä¸ŠéªŒè¯

---

### Step 4: æ›´æ–° Tool æè¿°æ–‡æ¡£

#### 4.1 æ·»åŠ å‚æ•°è¯´æ˜
åœ¨æ¯ä¸ª tool çš„ `description` ä¸­æ·»åŠ ï¼š
```python
@server.tool(
    name="tool-name",
    description="""Tool description...

    Args:
        ctx: The MCP context object
        target_account_id: Target AWS account ID. If not provided, use default credentials.
        # ... å…¶ä»–å‚æ•°

    Returns:
        Dict containing the response data
    """
)
```

#### 4.2 æ·»åŠ ä½¿ç”¨ç¤ºä¾‹
```markdown
## ä½¿ç”¨ç¤ºä¾‹

### 1. ä½¿ç”¨é»˜è®¤å‡­è¯
```json
{
  "tool": "tool-name",
  "params": {
    "param1": "value1"
  }
}
```

### 2. ä½¿ç”¨ç›®æ ‡è´¦å·å‡­è¯
```json
{
  "tool": "tool-name",
  "params": {
    "target_account_id": "123456789012",
    "param1": "value1"
  }
}
```
```

---

### Step 5: ä¿®æ”¹ server.py (å¯é€‰)

**å¦‚æœéœ€è¦è‡ªå®šä¹‰å¯åŠ¨é€»è¾‘**ï¼Œä¿®æ”¹ `server.py`ï¼š
```python
# awslabs/<mcp_server_package>/server.py

#!/usr/bin/env python3
import asyncio
import os
import sys

if __name__ == '__main__':
    current_dir = os.path.dirname(os.path.abspath(__file__))
    parent_dir = os.path.dirname(os.path.dirname(current_dir))
    if parent_dir not in sys.path:
        sys.path.insert(0, parent_dir)

from fastmcp import FastMCP

mcp = FastMCP(
    name='<mcp-server-name>',
    instructions="""Server instructions..."""
)

async def setup():
    """Initialize the MCP server"""
    # å¯¼å…¥å¹¶æ³¨å†Œ tools
    from .tools import tool1_server, tool2_server
    await mcp.import_server(tool1_server)
    await mcp.import_server(tool2_server)

    logger.info('MCP Server initialized successfully')

def main():
    """Main entry point"""
    asyncio.run(setup())
    mcp.run()

if __name__ == '__main__':
    main()
```

**æ³¨æ„**ï¼š
- é€šå¸¸ä¸éœ€è¦ä¿®æ”¹ `server.py`
- å¯åŠ¨é€»è¾‘å·²ç»åœ¨ `entrypoint.py` ä¸­å®ç°

---

## âœ… æ”¹é€ éªŒè¯

### 1. å•å…ƒæµ‹è¯•
```python
# tests/test_account_context.py
import pytest
from entrypoint import _setup_account_context
from cred_extract_services.exceptions import AccountNotFoundError

@pytest.mark.asyncio
async def test_setup_account_context_aksk():
    """æµ‹è¯• AKSK è´¦å·å‡­è¯è®¾ç½®"""
    result = await _setup_account_context("test-aksk-account-id")
    assert result["auth_type"] == "aksk"
    assert result["account_id"] is not None

@pytest.mark.asyncio
async def test_setup_account_context_iam_role():
    """æµ‹è¯• IAM Role è´¦å·å‡­è¯è®¾ç½®"""
    result = await _setup_account_context("test-role-account-id")
    assert result["auth_type"] == "iam_role"
    assert result["account_id"] is not None

@pytest.mark.asyncio
async def test_setup_account_context_not_found():
    """æµ‹è¯•è´¦å·ä¸å­˜åœ¨å¼‚å¸¸"""
    with pytest.raises(AccountNotFoundError):
        await _setup_account_context("non-existent-account")
```

### 2. é›†æˆæµ‹è¯•
```bash
# å¯åŠ¨ MCP Server (stdio æ¨¡å¼)
FASTMCP_TRANSPORT=stdio python entrypoint.py

# æµ‹è¯•è°ƒç”¨ï¼ˆä½¿ç”¨ MCP Clientï¼‰
echo '{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "tools/call",
  "params": {
    "name": "tool-name",
    "arguments": {
      "target_account_id": "123456789012",
      "param1": "value1"
    }
  }
}' | python entrypoint.py
```

### 3. æ‰‹åŠ¨éªŒè¯æ¸…å•
- [ ] AKSK è´¦å·å‡­è¯æ­£å¸¸
- [ ] IAM Role è´¦å·å‡­è¯æ­£å¸¸
- [ ] External ID æ­£ç¡®ä¼ é€’
- [ ] Session Token å¤„ç†æ­£å¸¸
- [ ] å¤šè´¦å·åˆ‡æ¢æ­£å¸¸
- [ ] é»˜è®¤å‡­è¯ï¼ˆæ—  target_account_idï¼‰æ­£å¸¸
- [ ] æ‰€æœ‰å¼‚å¸¸å¤„ç†æ­£å¸¸
- [ ] æ—¥å¿—ä¸åŒ…å«æ•æ„Ÿä¿¡æ¯

---

## ğŸ› å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜ 1: ModuleNotFoundError: No module named 'cred_extract_services'
**åŸå› **ï¼šPython è·¯å¾„é…ç½®é—®é¢˜

**è§£å†³**ï¼š
```python
# åœ¨ entrypoint.py ä¸­æ·»åŠ 
import sys
import os

current_dir = os.path.dirname(os.path.abspath(__file__))
if current_dir not in sys.path:
    sys.path.insert(0, current_dir)
```

### é—®é¢˜ 2: DatabaseConnectionError
**åŸå› **ï¼šæ•°æ®åº“é…ç½®é”™è¯¯

**è§£å†³**ï¼š
```bash
# æ£€æŸ¥ç¯å¢ƒå˜é‡
echo $DATABASE_URL
echo $RDS_SECRET_NAME

# æµ‹è¯•æ•°æ®åº“è¿æ¥
python -c "
from cred_extract_services.database import query_account
import asyncio
result = asyncio.run(query_account('test-account-id'))
print(result)
"
```

### é—®é¢˜ 3: CredentialDecryptionError
**åŸå› **ï¼šåŠ å¯†å¯†é’¥é”™è¯¯

**è§£å†³**ï¼š
```bash
# æ£€æŸ¥åŠ å¯†å¯†é’¥
echo $ENCRYPTION_KEY | base64 -d | xxd  # åº”è¯¥æ˜¯ 32 å­—èŠ‚

# é‡æ–°ç”Ÿæˆå¯†é’¥ï¼ˆä»…æµ‹è¯•ç¯å¢ƒï¼‰
python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"
```

### é—®é¢˜ 4: AssumeRoleError
**åŸå› **ï¼šIAM Role é…ç½®é”™è¯¯

**è§£å†³**ï¼š
```bash
# æ£€æŸ¥ Role ARN å’Œ External ID
python -c "
from cred_extract_services.database import query_account
import asyncio
account = asyncio.run(query_account('test-role-account-id'))
print(f'Role ARN: {account[\"role_arn\"]}')
print(f'External ID: {account[\"external_id\"]}')
"

# æµ‹è¯• AssumeRole
aws sts assume-role \
  --role-arn <role-arn> \
  --role-session-name test \
  --external-id <external-id>
```

### é—®é¢˜ 5: Session Token æ®‹ç•™
**åŸå› **ï¼šç¯å¢ƒå˜é‡æœªæ­£ç¡®æ¸…ç†

**è§£å†³**ï¼š
```python
# åœ¨ context_manager.py ä¸­ç¡®ä¿åˆ é™¤é€»è¾‘
if session_token:
    os.environ["AWS_SESSION_TOKEN"] = session_token
elif "AWS_SESSION_TOKEN" in os.environ:
    del os.environ["AWS_SESSION_TOKEN"]  # âœ… å…³é”®ï¼
```

---

## ğŸ“ æ”¹é€ æ£€æŸ¥æ¸…å•

### ä»£ç ä¿®æ”¹
- [ ] å¤åˆ¶ `cred_extract_services/` ç›®å½•
- [ ] åˆ›å»º `entrypoint.py`
- [ ] ä¿®æ”¹æ‰€æœ‰ tool å‡½æ•°ï¼ˆæ·»åŠ  `target_account_id` å‚æ•°ï¼‰
- [ ] æ·»åŠ è´¦å·ä¸Šä¸‹æ–‡åˆå§‹åŒ–ä»£ç 
- [ ] æ·»åŠ å¼‚å¸¸å¤„ç†
- [ ] æ›´æ–° tool æè¿°æ–‡æ¡£

### æµ‹è¯•éªŒè¯
- [ ] å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] é›†æˆæµ‹è¯•é€šè¿‡
- [ ] æ‰‹åŠ¨éªŒè¯é€šè¿‡
- [ ] å¼‚å¸¸å¤„ç†éªŒè¯é€šè¿‡

### æ–‡æ¡£æ›´æ–°
- [ ] README æ›´æ–°
- [ ] API æ–‡æ¡£æ›´æ–°
- [ ] ä½¿ç”¨ç¤ºä¾‹æ›´æ–°

### éƒ¨ç½²å‡†å¤‡
- [ ] ç¯å¢ƒå˜é‡é…ç½®
- [ ] æ•°æ®åº“è¿ç§»ï¼ˆå¦‚æœéœ€è¦ï¼‰
- [ ] ä¾èµ–é¡¹æ›´æ–° (requirements.txt / pyproject.toml)

---

## ğŸš€ éƒ¨ç½²ä¸Šçº¿

### 1. æ›´æ–°ä¾èµ–
```toml
# pyproject.toml
[project]
dependencies = [
    "fastmcp>=0.4.0",
    "boto3>=1.35.0",
    "sqlalchemy>=2.0.0",
    "psycopg2-binary>=2.9.0",
    "cryptography>=41.0.0",
    # ... å…¶ä»–ä¾èµ–
]
```

### 2. é…ç½®ç”Ÿäº§ç¯å¢ƒå˜é‡
```bash
# ç”Ÿäº§ç¯å¢ƒ (EKS)
kubectl create secret generic mcp-server-secrets \
  --from-literal=RDS_SECRET_NAME=costq/rds/postgresql \
  --from-literal=ENCRYPTION_KEY=<base64-key> \
  --from-literal=AWS_REGION=ap-northeast-1
```

### 3. åˆ›å»º Dockerfile-AgentCore-Runtimeï¼ˆâœ… å¯ç›´æ¥å¤åˆ¶ï¼‰

#### 3.1 ç›´æ¥å¤åˆ¶
```bash
cd src/<mcp-server-name>/

# âœ… ç›´æ¥å¤åˆ¶ï¼ˆå®Œå…¨é€šç”¨ï¼Œæ— éœ€ä¿®æ”¹ï¼‰
cp ../billing-cost-management-mcp-server/Dockerfile-AgentCore-Runtime ./
```

**ä¸ºä»€ä¹ˆå¯ä»¥ç›´æ¥å¤åˆ¶ï¼Ÿ**
- âœ… æ²¡æœ‰ç¡¬ç¼–ç çš„é¡¹ç›®åç§°
- âœ… ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼ˆ`COPY . /app`ï¼‰
- âœ… æ‰€æœ‰é…ç½®é€šè¿‡ç¯å¢ƒå˜é‡
- âœ… é€‚ç”¨äºæ‰€æœ‰ä½¿ç”¨ `pyproject.toml` + `uv` çš„ MCP Server

**å…³é”®å†…å®¹ï¼ˆå·²åŒ…å«ï¼Œæ— éœ€ä¿®æ”¹ï¼‰**ï¼š
- å¤åˆ¶ `entrypoint.py` å’Œ `cred_extract_services/`
- å®‰è£…é¢å¤–ä¾èµ–ï¼ˆOpenTelemetryã€SQLAlchemyã€psycopg2ã€cryptographyï¼‰
- ä½¿ç”¨ `opentelemetry-instrument` å¯åŠ¨
- é…ç½®æ­£ç¡®çš„ç¯å¢ƒå˜é‡

---

#### 3.2 å®Œæ•´ Dockerfile æ¨¡æ¿ï¼ˆä»…ä¾›å‚è€ƒï¼‰

**å¦‚æœå‚è€ƒé¡¹ç›®ä¸å¯ç”¨ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å®Œæ•´æ¨¡æ¿**ï¼š

```dockerfile
# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
# ... (license header)

FROM public.ecr.aws/docker/library/python:3.13-alpine AS uv

WORKDIR /app

# UV é…ç½®
ENV UV_COMPILE_BYTECODE=1 \
    UV_LINK_MODE=copy \
    UV_PYTHON_PREFERENCE=only-system \
    UV_FROZEN=true

COPY pyproject.toml uv.lock uv-requirements.txt ./

# å®‰è£…æ„å»ºä¾èµ–ï¼ˆåŒ…å« postgresql-devï¼‰
RUN apk update && \
    apk add --no-cache --virtual .build-deps \
    build-base gcc musl-dev libffi-dev openssl-dev cargo postgresql-dev

# å®‰è£… Python ä¾èµ–
RUN --mount=type=cache,target=/root/.cache/uv \
    pip install --require-hashes --requirement uv-requirements.txt --no-cache-dir && \
    uv sync --python 3.13 --frozen --no-install-project --no-dev --no-editable

# å¤åˆ¶é¡¹ç›®ä»£ç å¹¶å®‰è£…
COPY . /app
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --python 3.13 --frozen --no-dev --no-editable

RUN mkdir -p /root/.local

# ====== Runtime é˜¶æ®µ ======
FROM public.ecr.aws/docker/library/python:3.13-alpine

ENV PATH="/app/.venv/bin:$PATH" \
    PYTHONPATH="/app" \
    PYTHONUNBUFFERED=1

WORKDIR /app

# å®‰è£…è¿è¡Œæ—¶ä¾èµ–ï¼ˆåŒ…å« postgresql-libsï¼‰
RUN apk update && \
    apk add --no-cache ca-certificates postgresql-libs && \
    update-ca-certificates && \
    addgroup -S app && \
    adduser -S app -G app -h /app

# å¤åˆ¶è™šæ‹Ÿç¯å¢ƒ
COPY --from=uv --chown=app:app /app/.venv /app/.venv

# âœ… å…³é”®ï¼šå¤åˆ¶ entrypoint.py å’Œ cred_extract_services
COPY --chown=app:app ./entrypoint.py /app/entrypoint.py
COPY --chown=app:app ./cred_extract_services /app/cred_extract_services

# å¤åˆ¶å¥åº·æ£€æŸ¥è„šæœ¬
COPY ./docker-healthcheck.sh /usr/local/bin/docker-healthcheck.sh

# ====== Runtime ä¸“ç”¨é…ç½® ======
EXPOSE 9000 8000 8080

ENV UV_SYSTEM_PYTHON=1 \
    UV_NO_PROGRESS=1 \
    DOCKER_CONTAINER=1 \
    AWS_REGION=ap-northeast-1 \
    AWS_DEFAULT_REGION=ap-northeast-1 \
    MCP_HOST=0.0.0.0 \
    MCP_PORT=8000 \
    MCP_STATELESS_HTTP=true \
    MCP_TRANSPORT=streamable-http

# âœ… å…³é”®ï¼šå®‰è£…é¢å¤–ä¾èµ–
RUN pip install --no-cache-dir uv && \
    uv pip install --python /app/.venv/bin/python \
    aws-opentelemetry-distro==0.12.2 \
    sqlalchemy>=2.0.0 \
    psycopg2-binary>=2.9.0 \
    cryptography>=41.0.0

USER app

HEALTHCHECK --interval=60s --timeout=10s --start-period=10s --retries=3 \
    CMD ["docker-healthcheck.sh"]

# âœ… å…³é”®ï¼šä½¿ç”¨ opentelemetry-instrument å¯åŠ¨
CMD ["opentelemetry-instrument", "python", "-m", "entrypoint"]
```

#### 3.3 å…³é”®ä¿®æ”¹ç‚¹æ£€æŸ¥æ¸…å•

- [ ] å¤åˆ¶ `entrypoint.py` å’Œ `cred_extract_services/`
- [ ] å®‰è£… 4 ä¸ªé¢å¤–ä¾èµ–ï¼ˆOpenTelemetryã€SQLAlchemyã€psycopg2ã€cryptographyï¼‰
- [ ] ä½¿ç”¨ `opentelemetry-instrument python -m entrypoint` å¯åŠ¨
- [ ] æš´éœ²ç«¯å£ 8000ã€8080ã€9000
- [ ] è®¾ç½®æ­£ç¡®çš„ç¯å¢ƒå˜é‡ï¼ˆMCP_* å’Œ AWS_*ï¼‰
- [ ] åŒ…å« `postgresql-dev`ï¼ˆæ„å»ºé˜¶æ®µï¼‰å’Œ `postgresql-libs`ï¼ˆè¿è¡Œé˜¶æ®µï¼‰

---

### 4. åˆ›å»ºéƒ¨ç½²è„šæœ¬ï¼ˆæ¨èï¼‰

#### 4.1 å¤åˆ¶è„šæœ¬æ¨¡æ¿
```bash
cd costq/scripts/

# å¤åˆ¶é€šç”¨æ¨¡æ¿
cp build_and_push_template.sh 01-build_and_push_<mcp-server-name>.sh

# æ·»åŠ æ‰§è¡Œæƒé™
chmod +x 01-build_and_push_<mcp-server-name>.sh
```

#### 4.2 ä¿®æ”¹é…ç½®
ç¼–è¾‘è„šæœ¬ï¼Œä¿®æ”¹ä»¥ä¸‹å˜é‡ï¼š
```bash
# åœ¨è„šæœ¬é¡¶éƒ¨ä¿®æ”¹
MCP_SERVER_NAME="<mcp-server-name>"  # âœ… æ”¹æˆå®é™…çš„ MCP Server åç§°
AWS_PROFILE="3532"                   # AWS CLI Profileï¼ˆå¯é€‰ï¼‰
AWS_REGION="ap-northeast-1"          # AWS åŒºåŸŸï¼ˆå¯é€‰ï¼‰
AWS_ACCOUNT="000451883532"           # AWS è´¦å· IDï¼ˆå¯é€‰ï¼‰
```

**ç¤ºä¾‹**ï¼š
```bash
MCP_SERVER_NAME="cloudwatch-mcp-server"
```

#### 4.3 æ‰§è¡Œä¸€é”®éƒ¨ç½²
```bash
# ä»é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
bash costq/scripts/01-build_and_push_<mcp-server-name>.sh
```

**è„šæœ¬ä¼šè‡ªåŠ¨æ‰§è¡Œ**ï¼š
1. âœ… ç™»å½• ECR
2. âœ… æ„å»º ARM64 é•œåƒ
3. âœ… æ‰“æ ‡ç­¾ï¼ˆ`latest` + æ—¶é—´æˆ³ï¼‰
4. âœ… æ¨é€åˆ° ECR

**é¢„æœŸè¾“å‡º**ï¼š
```
============================================================
ğŸš€ æ„å»ºå¹¶æ¨é€ MCP Server é•œåƒ
============================================================
MCP Server: cloudwatch-mcp-server
ECR ä»“åº“: 000451883532.dkr.ecr.ap-northeast-1.amazonaws.com/awslabs-mcp/cloudwatch-mcp-server
é•œåƒæ ‡ç­¾: latest, v20260117-123456
å¹³å°: linux/arm64
============================================================

ğŸ” Step 1: ç™»å½• ECR...
âœ… ECR ç™»å½•æˆåŠŸ

ğŸ”¨ Step 2: æ„å»º ARM64 Docker é•œåƒ...
âœ… é•œåƒæ„å»ºæˆåŠŸ

ğŸ·ï¸  Step 3: æ‰“æ ‡ç­¾...
âœ… æ ‡ç­¾å·²åˆ›å»º: latest, v20260117-123456

ğŸ“¤ Step 4: æ¨é€é•œåƒåˆ° ECR...
âœ… é•œåƒæ¨é€æˆåŠŸ

============================================================
âœ… é•œåƒéƒ¨ç½²å®Œæˆ!
============================================================
```

---

### 5. æ‰‹åŠ¨éƒ¨ç½²ï¼ˆä¸æ¨èï¼‰

**å¦‚æœä¸ä½¿ç”¨è„šæœ¬ï¼Œå¯ä»¥æ‰‹åŠ¨æ‰§è¡Œä»¥ä¸‹æ­¥éª¤**ï¼š

#### 5.1 æ„å»º ARM64 é•œåƒ
```bash
cd src/<mcp-server-name>/

# æ„å»ºé•œåƒï¼ˆä½¿ç”¨ buildx æ”¯æŒå¤šå¹³å°ï¼‰
docker buildx build \
  --platform linux/arm64 \
  -f Dockerfile-AgentCore-Runtime \
  -t <ecr-url>/<mcp-server-name>:latest \
  --load \
  .
```

#### 5.2 æ¨é€åˆ° ECR
```bash
# ç™»å½• ECR
aws ecr get-login-password --region ap-northeast-1 --profile 3532 | \
  docker login --username AWS --password-stdin <account-id>.dkr.ecr.ap-northeast-1.amazonaws.com

# æ‰“æ ‡ç­¾
docker tag <mcp-server-name>:latest <ecr-url>/<mcp-server-name>:latest

# æ¨é€é•œåƒ
docker push <ecr-url>/<mcp-server-name>:latest
```

---

### 6. æ›´æ–° Runtime å’ŒéªŒè¯

#### 6.1 æ›´æ–° Runtime
```bash
# ä½¿ç”¨ AWS CLI æ›´æ–°
aws bedrock-agentcore-control update-runtime \
  --profile 3532 \
  --region ap-northeast-1 \
  --runtime-identifier <runtime-id> \
  --container-image <ecr-url>/<mcp-server-name>:latest
```

#### 6.2 åˆ·æ–° Gateway
âš ï¸ **é‡è¦**ï¼šæŒ‰ç…§ DEEPV.md è¯´æ˜ï¼Œéœ€è¦æ‰‹åŠ¨åˆ·æ–° Gateway

#### 6.3 éªŒè¯éƒ¨ç½²

### 4. ç›‘æ§éªŒè¯
```bash
# æŸ¥çœ‹æ—¥å¿—
kubectl logs -f deployment/mcp-server -n costq-mcp

# éªŒè¯å¥åº·æ£€æŸ¥
curl http://mcp-server:8000/health

# æµ‹è¯• API
curl -X POST http://mcp-server:8000/mcp \
  -H "Content-Type: application/json" \
  -d '{"method": "tools/list"}'
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [æ”¹é€ éœ€æ±‚åˆ†æ](./01_æ”¹é€ éœ€æ±‚åˆ†æ.md)
- [Skill vs Memory æ–¹æ¡ˆå¯¹æ¯”](./03_Skill_vs_Memoryæ–¹æ¡ˆå¯¹æ¯”.md)
- [æ”¹é€ è‡ªåŠ¨åŒ–æ–¹æ¡ˆ](./04_æ”¹é€ è‡ªåŠ¨åŒ–æ–¹æ¡ˆ.md)
