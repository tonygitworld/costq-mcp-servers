# MCP Server å¤šè´¦å·æƒé™ä¼ é€’æ”¹é€ éœ€æ±‚åˆ†æ

## 1. èƒŒæ™¯è¯´æ˜

### 1.1 æ¶æ„æ¦‚è¿°
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Strands Agent   â”‚  (AgentCore Runtime)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AgentCore       â”‚  (æƒé™ç½‘å…³)
â”‚ Gateway         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MCP Servers     â”‚  (AgentCore Runtime)
â”‚ (å¤šä¸ªåç«¯æœåŠ¡)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ ¸å¿ƒé—®é¢˜
**é—®é¢˜**ï¼šStrands Agent éœ€è¦è®¿é—®**ç›®æ ‡è´¦å·**çš„ AWS èµ„æºï¼Œä½† MCP Server é»˜è®¤ä½¿ç”¨**è¿è¡Œæ—¶è´¦å·**çš„å‡­è¯ã€‚

**åœºæ™¯ç¤ºä¾‹**ï¼š
- Agent è¿è¡Œåœ¨ Account A (è¿è¡Œæ—¶è´¦å·)
- ç”¨æˆ·æƒ³æŸ¥è¯¢ Account B (ç›®æ ‡è´¦å·) çš„æˆæœ¬æ•°æ®
- MCP Server éœ€è¦è·å– Account B çš„ä¸´æ—¶å‡­è¯

### 1.3 è§£å†³æ–¹æ¡ˆ
é€šè¿‡ **è´¦å·ä¸Šä¸‹æ–‡ä¼ é€’æœºåˆ¶** å®ç°ï¼š
1. Agent é€šè¿‡ Gateway ä¼ é€’ `target_account_id` å‚æ•°
2. MCP Server ä»æ•°æ®åº“æŸ¥è¯¢è´¦å·å‡­è¯ä¿¡æ¯
3. æ ¹æ®è´¦å·ç±»å‹ï¼ˆAKSK/IAM Roleï¼‰è·å–ä¸´æ—¶å‡­è¯
4. è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œboto3 è‡ªåŠ¨ä½¿ç”¨ç›®æ ‡è´¦å·å‡­è¯

---

## 2. æ”¹é€ èŒƒå›´

### 2.1 æ”¹é€ çš„ MCP Server
å·²æ”¹é€ å®Œæˆï¼š
- `billing-cost-management-mcp-server`

å¾…æ”¹é€ ï¼š
- å…¶ä»–éœ€è¦å¤šè´¦å·è®¿é—®èƒ½åŠ›çš„ MCP Serversï¼ˆå¦‚ CloudWatchã€S3 ç­‰ï¼‰

### 2.1.5 æ–‡ä»¶å¯å¤ç”¨æ€§æ€»ç»“

| æ–‡ä»¶/ç›®å½• | å¯å¤ç”¨æ€§ | éœ€è¦ä¿®æ”¹ | è¯´æ˜ |
|-----------|---------|---------|------|
| `cred_extract_services/` | âœ… **100% å¯å¤ç”¨** | âŒ æ— éœ€ä¿®æ”¹ | å®Œå…¨è‡ªåŒ…å«ï¼Œä¸ä¾èµ–é¡¹ç›®ä»£ç  |
| `Dockerfile-AgentCore-Runtime` | âœ… **100% å¯å¤ç”¨** | âŒ æ— éœ€ä¿®æ”¹ | é€šç”¨æ¨¡æ¿ï¼Œæ— ç¡¬ç¼–ç é¡¹ç›®å |
| `entrypoint.py` | âš ï¸ **95% å¯å¤ç”¨** | âœ… ä¿®æ”¹ 1 è¡Œ | ä»…éœ€ä¿®æ”¹å¯¼å…¥è·¯å¾„ |
| `costq/scripts/build_*.sh` | âš ï¸ **95% å¯å¤ç”¨** | âœ… ä¿®æ”¹ 1 å˜é‡ | ä»…éœ€ä¿®æ”¹ `MCP_SERVER_NAME` |
| `awslabs/.../tools/*.py` | âŒ **éœ€è¦ä¿®æ”¹** | âœ… æ‰¹é‡ä¿®æ”¹ | æ‰€æœ‰ tool å‡½æ•°æ·»åŠ  `target_account_id` å‚æ•° |

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- âœ… **80% çš„åŸºç¡€è®¾æ–½ä»£ç å¯ç›´æ¥å¤åˆ¶**
- âœ… **æ”¹é€ æ—¶é—´ä» 2-3 å°æ—¶ç¼©çŸ­åˆ° 10-15 åˆ†é’Ÿ**
- âœ… **é™ä½å‡ºé”™é£é™©**ï¼ˆä½¿ç”¨ç»è¿‡éªŒè¯çš„ä»£ç ï¼‰

---

### 2.2 æ”¹é€ å±‚çº§
```
src/billing-cost-management-mcp-server/
â”œâ”€â”€ Dockerfile-AgentCore-Runtime       # âœ… æ–°å¢ï¼šRuntime éƒ¨ç½²ä¸“ç”¨ Dockerfile
â”œâ”€â”€ entrypoint.py                      # âœ… æ–°å¢ï¼šç»Ÿä¸€å…¥å£
â”œâ”€â”€ cred_extract_services/             # âœ… æ–°å¢ï¼šå‡­è¯æå–æœåŠ¡
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ aws_client.py                  # STS AssumeRole
â”‚   â”œâ”€â”€ context_manager.py             # ç¯å¢ƒå˜é‡ç®¡ç†
â”‚   â”œâ”€â”€ credential_extractor.py        # å‡­è¯æå–æ ¸å¿ƒ
â”‚   â”œâ”€â”€ crypto.py                      # AKSK è§£å¯†
â”‚   â”œâ”€â”€ database.py                    # æ•°æ®åº“æŸ¥è¯¢
â”‚   â””â”€â”€ exceptions.py                  # è‡ªå®šä¹‰å¼‚å¸¸
â”œâ”€â”€ awslabs/.../tools/                 # âœ… ä¿®æ”¹ï¼šæ‰€æœ‰ tool å‡½æ•°
â”‚   â”œâ”€â”€ aws_pricing_tools.py
â”‚   â”œâ”€â”€ budget_tools.py
â”‚   â”œâ”€â”€ compute_optimizer_tools.py
â”‚   â”œâ”€â”€ cost_anomaly_tools.py
â”‚   â””â”€â”€ ... (å…¶ä»– tools)
â””â”€â”€ awslabs/.../utilities/             # âœ… ä¿®æ”¹ï¼šå·¥å…·å‡½æ•°
    â””â”€â”€ aws_service_base.py            # create_aws_client ä¸å˜
```

---

## 3. æ ¸å¿ƒæ”¹é€ ç‚¹

### 3.1 æ–°å¢å‡­è¯æå–æœåŠ¡å±‚ (cred_extract_services/)
**ç›®çš„**ï¼šè‡ªåŒ…å«çš„å‡­è¯ç®¡ç†æ¨¡å—ï¼Œä¸ä¾èµ–é¡¹ç›®ä»£ç 

#### 3.1.1 æ¨¡å—èŒè´£
| æ¨¡å— | èŒè´£ | ä¾èµ– |
|------|------|------|
| `database.py` | æŸ¥è¯¢ `aws_accounts` è¡¨å’Œ `organizations` è¡¨ | SQLAlchemy, boto3 (Secrets Manager) |
| `crypto.py` | è§£å¯† AKSK å‡­è¯ (Fernet) | cryptography |
| `aws_client.py` | STS AssumeRole è·å–ä¸´æ—¶å‡­è¯ | boto3 |
| `credential_extractor.py` | å‡­è¯æå–æ ¸å¿ƒé€»è¾‘ | ä¸Šè¿°æ¨¡å— |
| `context_manager.py` | è®¾ç½®ç¯å¢ƒå˜é‡ (boto3 æ ‡å‡†å˜é‡) | æ—  |
| `exceptions.py` | è‡ªå®šä¹‰å¼‚å¸¸ç±» | æ—  |

#### 3.1.2 æ•°æ®åº“æŸ¥è¯¢é€»è¾‘
```sql
SELECT
    a.id, a.account_id, a.alias, a.auth_type,
    a.access_key_id, a.secret_access_key_encrypted,
    a.role_arn, a.region, a.org_id,
    o.external_id  -- ä» organizations è¡¨è·å–
FROM aws_accounts a
LEFT JOIN organizations o ON a.org_id = o.id
WHERE a.account_id = :account_id
```

**å…³é”®å­—æ®µè¯´æ˜**ï¼š
- `auth_type`: "aksk" æˆ– "iam_role"
- `access_key_id`: AKSK ç±»å‹ï¼Œæ˜æ–‡å­˜å‚¨
- `secret_access_key_encrypted`: AKSK ç±»å‹ï¼ŒFernet åŠ å¯†
- `role_arn`: IAM Role ç±»å‹
- `external_id`: IAM Role ç±»å‹ï¼Œä» organizations è¡¨è·å–

#### 3.1.3 å‡­è¯æå–æµç¨‹
```python
async def extract_aws_credentials(account_id: str) -> dict:
    # 1. æŸ¥è¯¢æ•°æ®åº“
    account = await query_account(account_id)

    # 2. æ ¹æ® auth_type é€‰æ‹©åˆ†æ”¯
    if account["auth_type"] == "aksk":
        # è§£å¯† Secret Access Key
        secret_key = decrypt_aksk(account["encrypted_secret_key"])
        return {
            "access_key_id": account["access_key_id"],  # æ˜æ–‡
            "secret_access_key": secret_key,
            "session_token": None,
            "region": account["region"],
            "account_id": account["account_id"]
        }

    elif account["auth_type"] == "iam_role":
        # AssumeRole è·å–ä¸´æ—¶å‡­è¯
        credentials = await assume_role(
            role_arn=account["role_arn"],
            session_name=f"costq-{uuid.uuid4()}",
            external_id=account["external_id"],  # å¿…é¡»ï¼
            region=account["region"]
        )
        return {
            "access_key_id": credentials["AccessKeyId"],
            "secret_access_key": credentials["SecretAccessKey"],
            "session_token": credentials["SessionToken"],
            "region": account["region"],
            "account_id": account["account_id"]
        }
```

#### 3.1.4 ç¯å¢ƒå˜é‡è®¾ç½®
```python
def set_aws_credentials(
    access_key_id: str,
    secret_access_key: str,
    session_token: Optional[str] = None,
    region: str = "us-east-1",
) -> None:
    os.environ["AWS_ACCESS_KEY_ID"] = access_key_id
    os.environ["AWS_SECRET_ACCESS_KEY"] = secret_access_key

    # Session Token å¤„ç†ï¼šæœ‰å€¼åˆ™è®¾ç½®ï¼Œæ— å€¼åˆ™åˆ é™¤
    if session_token:
        os.environ["AWS_SESSION_TOKEN"] = session_token
    elif "AWS_SESSION_TOKEN" in os.environ:
        del os.environ["AWS_SESSION_TOKEN"]

    os.environ["AWS_DEFAULT_REGION"] = region
```

**å…³é”®ç‚¹**ï¼š
- boto3 è‡ªåŠ¨è¯†åˆ«æ ‡å‡†ç¯å¢ƒå˜é‡ï¼ˆAWS_ACCESS_KEY_IDã€AWS_SECRET_ACCESS_KEYã€AWS_SESSION_TOKENã€AWS_DEFAULT_REGIONï¼‰ï¼Œæ— éœ€é¢å¤–é…ç½®
- Session Token çš„åˆ é™¤é€»è¾‘é¿å…æ®‹ç•™ï¼ˆAKSK æ¨¡å¼æ²¡æœ‰ session tokenï¼‰
- ä¸è®¾ç½® AWS_ACCOUNT_IDï¼Œä¸šåŠ¡ä»£ç é€šè¿‡ STS GetCallerIdentity API åŠ¨æ€è·å–

---

### 3.2 æ–°å¢ç»Ÿä¸€å…¥å£ (entrypoint.py)

#### 3.2.1 æ ¸å¿ƒå‡½æ•°
```python
async def _setup_account_context(target_account_id: str) -> dict:
    """è®¾ç½® AWS å‡­è¯ä¸Šä¸‹æ–‡

    Args:
        target_account_id: AWS è´¦å· ID (æ•°æ®åº“ä¸»é”®)

    Returns:
        å‡­è¯ä¿¡æ¯å­—å…¸ï¼ˆå·²è„±æ•ï¼‰

    Raises:
        AccountNotFoundError: è´¦å·ä¸å­˜åœ¨
        CredentialDecryptionError: AKSK è§£å¯†å¤±è´¥
        AssumeRoleError: IAM Role AssumeRole å¤±è´¥
        DatabaseConnectionError: æ•°æ®åº“è¿æ¥å¤±è´¥
    """
    # 1. æå–å‡­è¯
    credentials = await extract_aws_credentials(target_account_id)

    # 2. è®¾ç½®ç¯å¢ƒå˜é‡
    set_aws_credentials(
        access_key_id=credentials["access_key_id"],
        secret_access_key=credentials["secret_access_key"],
        session_token=credentials.get("session_token"),
        region=credentials["region"],
    )

    # 3. è¿”å›è„±æ•ä¿¡æ¯
    return {
        "account_id": credentials["account_id"],
        "account_alias": credentials.get("alias", "Unknown"),
        "auth_type": credentials["auth_type"],
        "region": credentials["region"]
    }
```

#### 3.2.2 ä¸»å‡½æ•°ä¿®æ”¹
```python
def main():
    """å¯åŠ¨ MCP Server

    ç¯å¢ƒå˜é‡é…ç½®ï¼š
        FASTMCP_TRANSPORT: 'stdio' | 'streamable-http' (é»˜è®¤)
        FASTMCP_HOST: é»˜è®¤ '0.0.0.0'
        FASTMCP_PORT: é»˜è®¤ 8000
        FASTMCP_STATELESS_HTTP: é»˜è®¤ 'true'
    """
    from awslabs.billing_cost_management_mcp_server.server import mcp, setup

    transport = os.environ.get("FASTMCP_TRANSPORT", "streamable-http")
    host = os.environ.get("FASTMCP_HOST", "0.0.0.0")
    port = int(os.environ.get("FASTMCP_PORT", "8000"))
    stateless = os.environ.get("FASTMCP_STATELESS_HTTP", "true").lower() == "true"

    asyncio.run(setup())  # åˆå§‹åŒ– server

    if transport == "stdio":
        mcp.run(transport=transport)
    else:
        mcp.run(transport=transport, host=host, port=port, stateless_http=stateless)
```

---

### 3.3 ä¿®æ”¹æ‰€æœ‰ Tool å‡½æ•°

#### 3.3.1 å‚æ•°ä¿®æ”¹æ¨¡å¼
**æ‰€æœ‰ tool å‡½æ•°éƒ½æ–°å¢å‚æ•°**ï¼š
```python
@server.tool(name="tool-name", description="...")
async def tool_function(
    ctx: Context,
    target_account_id: Optional[str] = None,  # âœ… æ–°å¢å‚æ•°
    # ... å…¶ä»–ä¸šåŠ¡å‚æ•°
) -> Dict[str, Any]:
```

#### 3.3.2 æ ‡å‡†æ”¹é€ æ¨¡æ¿
```python
async def tool_function(
    ctx: Context,
    target_account_id: Optional[str] = None,
    # ... ä¸šåŠ¡å‚æ•°
) -> Dict[str, Any]:
    try:
        # ===== è´¦å·ä¸Šä¸‹æ–‡åˆå§‹åŒ– =====
        if target_account_id:
            from entrypoint import _setup_account_context
            await _setup_account_context(target_account_id)

        # ===== åŸæœ‰é€»è¾‘ï¼ˆå®Œå…¨ä¸å˜ï¼‰=====
        # ... ä¸šåŠ¡ä»£ç 

    # ===== å¼‚å¸¸å¤„ç† =====
    except AccountNotFoundError:
        return format_response('error', {'error_type': 'account_not_found'},
                               'Account not found. Please check the account ID.')
    except CredentialDecryptionError:
        return format_response('error', {'error_type': 'credential_error'},
                               'Failed to decrypt credentials. Please contact administrator.')
    except AssumeRoleError:
        return format_response('error', {'error_type': 'assume_role_error'},
                               'Failed to assume role. Please check IAM role configuration.')
    except DatabaseConnectionError:
        return format_response('error', {'error_type': 'database_error'},
                               'Database connection failed. Please try again later.')
    except Exception as e:
        return await handle_aws_error(ctx, e, 'operation', 'Service Name')
```

#### 3.3.3 å¼‚å¸¸å¤„ç†
**å¯¼å…¥è‡ªå®šä¹‰å¼‚å¸¸**ï¼š
```python
from entrypoint import (
    AccountNotFoundError,
    CredentialDecryptionError,
    AssumeRoleError,
    DatabaseConnectionError,
)
```

**ç»Ÿä¸€é”™è¯¯è¿”å›æ ¼å¼**ï¼š
```python
{
    "status": "error",
    "data": {
        "error_type": "account_not_found" | "credential_error" | "assume_role_error" | "database_error"
    },
    "message": "User-friendly error message"
}
```

---

### 3.4 å·¥å…·å‡½æ•°ä¿æŒä¸å˜

#### 3.4.1 aws_service_base.py
```python
def create_aws_client(service_name: str, region_name: Optional[str] = None) -> Any:
    """åˆ›å»º AWS å®¢æˆ·ç«¯ï¼ˆé€»è¾‘å®Œå…¨ä¸å˜ï¼‰

    boto3 ä¼šè‡ªåŠ¨ä»ç¯å¢ƒå˜é‡è¯»å–å‡­è¯ï¼š
    - AWS_ACCESS_KEY_ID
    - AWS_SECRET_ACCESS_KEY
    - AWS_SESSION_TOKEN (å¯é€‰)
    - AWS_DEFAULT_REGION
    """
    # ... åŸæœ‰é€»è¾‘ä¸å˜
    session = boto3.Session(region_name=region)
    return session.client(service_name, config=config)
```

**å…³é”®ç‚¹**ï¼š
- ä¸éœ€è¦ä¿®æ”¹ä»»ä½• `create_aws_client` è°ƒç”¨
- boto3 è‡ªåŠ¨ä»ç¯å¢ƒå˜é‡è¯»å–å‡­è¯
- **é›¶ä¾µå…¥æ€§åŸåˆ™**ï¼šä¸šåŠ¡ä»£ç æ— æ„ŸçŸ¥

---

## 4. æ”¹é€ åŸåˆ™æ€»ç»“

### 4.1 é›¶ä¾µå…¥æ€§åŸåˆ™
âœ… **ä»…ä¿®æ”¹ç›®æ ‡ä»£ç ï¼Œä¸æ”¹å˜ä¸šåŠ¡é€»è¾‘å’Œå‡½æ•°ç­¾å**

- Tool å‡½æ•°æ–°å¢å¯é€‰å‚æ•° `target_account_id`
  - **å‚æ•°ä½ç½®è§„åˆ™**ï¼šå¿…é¡»æ”¾åœ¨æ‰€æœ‰å¿…éœ€å‚æ•°ä¹‹åã€å…¶ä»–å¯é€‰å‚æ•°ä¹‹å‰
  - **ç¤ºä¾‹**ï¼š`async def tool(ctx, required_param, target_account_id=None, optional_param=None)`
- ä¸šåŠ¡é€»è¾‘å®Œå…¨ä¸å˜
- å·¥å…·å‡½æ•°ï¼ˆ`create_aws_client`ï¼‰ä¸å˜

### 4.2 è‡ªåŒ…å«åŸåˆ™
âœ… **å‡­è¯æå–æœåŠ¡å®Œå…¨ç‹¬ç«‹**

- `cred_extract_services/` ä¸ä¾èµ–é¡¹ç›®ä»£ç 
- å¯ä»¥å•ç‹¬æµ‹è¯•ã€å¤ç”¨

### 4.3 å®‰å…¨åŸåˆ™
âœ… **æ—¥å¿—å®‰å…¨**

- ä¸è®°å½•ä»»ä½•æ•æ„Ÿä¿¡æ¯ï¼ˆå¯†ç ã€å¯†é’¥ã€å‡­è¯ã€è¿æ¥ä¸²ï¼‰
- ä»…è®°å½•æ“ä½œç»“æœå’Œå…ƒæ•°æ®

âœ… **å¼‚å¸¸å®‰å…¨**

- ç»Ÿä¸€çš„è‡ªå®šä¹‰å¼‚å¸¸ç±»å‹
- æ¸…æ™°çš„é”™è¯¯æç¤º

### 4.4 ç¯å¢ƒå˜é‡åŸåˆ™
âœ… **æ ‡å‡†åŒ–**

- ä½¿ç”¨ boto3 æ ‡å‡†ç¯å¢ƒå˜é‡
- ä¸è‡ªå®šä¹‰ boto3 é…ç½®

âœ… **ç”Ÿå‘½å‘¨æœŸç®¡ç†**

- Session Token æœ‰å€¼åˆ™è®¾ç½®ï¼Œæ— å€¼åˆ™åˆ é™¤
- é¿å…ç¯å¢ƒå˜é‡æ®‹ç•™

---

## 5. Dockerfile æ”¹é€ è¯¦è§£

### 5.1 æ–°å¢æ–‡ä»¶ï¼šDockerfile-AgentCore-Runtime

**ç›®çš„**ï¼šæ„å»ºä¸“é—¨ç”¨äº AgentCore Runtime éƒ¨ç½²çš„ ARM64 é•œåƒ

**å…³é”®æ”¹é€ ç‚¹**ï¼š

#### 5.1.1 æ–‡ä»¶å¤åˆ¶ï¼ˆå¿…éœ€ï¼‰
```dockerfile
# å¤åˆ¶ entrypoint.py å’Œ cred_extract_servicesï¼ˆæ”¹é€ æ ¸å¿ƒï¼‰
COPY --chown=app:app ./entrypoint.py /app/entrypoint.py
COPY --chown=app:app ./cred_extract_services /app/cred_extract_services
```

**è¯´æ˜**ï¼š
- `entrypoint.py`ï¼šç»Ÿä¸€å…¥å£ï¼ŒåŒ…å«è´¦å·ä¸Šä¸‹æ–‡åˆå§‹åŒ–é€»è¾‘
- `cred_extract_services/`ï¼šå‡­è¯æå–æœåŠ¡å±‚ï¼ˆæ•°æ®åº“æŸ¥è¯¢ã€è§£å¯†ã€AssumeRoleï¼‰

#### 5.1.2 é¢å¤–ä¾èµ–å®‰è£…ï¼ˆå¿…éœ€ï¼‰
```dockerfile
RUN pip install --no-cache-dir uv && \
    uv pip install --python /app/.venv/bin/python \
    aws-opentelemetry-distro==0.12.2 \
    sqlalchemy>=2.0.0 \
    psycopg2-binary>=2.9.0 \
    cryptography>=41.0.0
```

**ä¾èµ–è¯´æ˜**ï¼š
| ä¾èµ– | ç”¨é€” | å¿…éœ€æ€§ |
|------|------|--------|
| `aws-opentelemetry-distro` | OpenTelemetry è‡ªåŠ¨ç›‘æ§ï¼ˆRuntime è¦æ±‚ï¼‰ | âœ… å¿…éœ€ |
| `sqlalchemy` | æ•°æ®åº“ ORMï¼ŒæŸ¥è¯¢ `aws_accounts` è¡¨ | âœ… å¿…éœ€ |
| `psycopg2-binary` | PostgreSQL æ•°æ®åº“é©±åŠ¨ | âœ… å¿…éœ€ |
| `cryptography` | Fernet åŠ å¯†è§£å¯†ï¼ˆAKSK è§£å¯†ï¼‰ | âœ… å¿…éœ€ |

#### 5.1.3 è¿è¡Œæ—¶ç¯å¢ƒå˜é‡ï¼ˆå¯é€‰é…ç½®ï¼‰
```dockerfile
ENV UV_SYSTEM_PYTHON=1 \
    UV_NO_PROGRESS=1 \
    DOCKER_CONTAINER=1 \
    AWS_REGION=ap-northeast-1 \
    AWS_DEFAULT_REGION=ap-northeast-1 \
    FASTMCP_HOST=0.0.0.0 \
    FASTMCP_PORT=8000 \
    FASTMCP_STATELESS_HTTP=true \
    FASTMCP_TRANSPORT=streamable-http
```

**ç¯å¢ƒå˜é‡è¯´æ˜**ï¼š
| å˜é‡ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `AWS_REGION` / `AWS_DEFAULT_REGION` | `ap-northeast-1` | AWS é»˜è®¤åŒºåŸŸï¼ˆå¯è¦†ç›–ï¼‰ |
| `FASTMCP_HOST` | `0.0.0.0` | MCP Server ç›‘å¬åœ°å€ |
| `FASTMCP_PORT` | `8000` | MCP Server ç›‘å¬ç«¯å£ |
| `FASTMCP_STATELESS_HTTP` | `true` | æ— çŠ¶æ€ HTTP æ¨¡å¼ |
| `FASTMCP_TRANSPORT` | `streamable-http` | ä¼ è¾“åè®® |

#### 5.1.4 ç«¯å£æš´éœ²
```dockerfile
EXPOSE 9000
EXPOSE 8000
EXPOSE 8080
```

#### 5.1.5 å¯åŠ¨å‘½ä»¤ï¼ˆå…³é”®ï¼‰
```dockerfile
CMD ["opentelemetry-instrument", "python", "-m", "entrypoint"]
```

**è¯´æ˜**ï¼š
- ä½¿ç”¨ `opentelemetry-instrument` è‡ªåŠ¨æ³¨å…¥ç›‘æ§
- å¯åŠ¨ `entrypoint` æ¨¡å—ï¼ˆè‡ªå®šä¹‰å…¥å£ç‚¹ï¼Œé FastMCP é»˜è®¤å…¥å£ï¼‰

---

### 5.2 Dockerfile ä¸åŸå§‹ç‰ˆæœ¬å¯¹æ¯”

| æ”¹é€ ç‚¹ | åŸå§‹ Dockerfile | Dockerfile-AgentCore-Runtime |
|--------|----------------|------------------------------|
| æ–‡ä»¶å¤åˆ¶ | åªå¤åˆ¶ `awslabs/` åŒ… | é¢å¤–å¤åˆ¶ `entrypoint.py` + `cred_extract_services/` |
| é¢å¤–ä¾èµ– | æ—  | SQLAlchemyã€psycopg2ã€cryptographyã€OpenTelemetry |
| å¯åŠ¨å‘½ä»¤ | `python -m awslabs.<package>` | `opentelemetry-instrument python -m entrypoint` |
| ç«¯å£æš´éœ² | ä»… 8000 | 8000ã€8080ã€9000 |
| ç¯å¢ƒå˜é‡ | æœ€å°åŒ– | å®Œæ•´çš„ MCP + AWS é…ç½® |

---

### 5.3 ä¸ºä»€ä¹ˆéœ€è¦å•ç‹¬çš„ Dockerfileï¼Ÿ

**åŸå› **ï¼š

1. **éƒ¨ç½²ç¯å¢ƒä¸åŒ**
   - åŸå§‹ï¼šæœ¬åœ°å¼€å‘ã€æµ‹è¯•
   - Runtimeï¼šAWS AgentCore ç”Ÿäº§ç¯å¢ƒ

2. **ä¾èµ–ä¸åŒ**
   - åŸå§‹ï¼šåªéœ€è¦ä¸šåŠ¡ä¾èµ–
   - Runtimeï¼šéœ€è¦æ•°æ®åº“ã€åŠ å¯†ã€ç›‘æ§ä¾èµ–

3. **å…¥å£ä¸åŒ**
   - åŸå§‹ï¼šç›´æ¥å¯åŠ¨ FastMCP Server
   - Runtimeï¼šéœ€è¦å…ˆåˆå§‹åŒ–è´¦å·ä¸Šä¸‹æ–‡ï¼ˆ`entrypoint.py`ï¼‰

4. **ç›‘æ§è¦æ±‚ä¸åŒ**
   - åŸå§‹ï¼šæ— ç›‘æ§
   - Runtimeï¼šå¿…é¡»é›†æˆ OpenTelemetry

---

## 6. éƒ¨ç½²è„šæœ¬

### 6.1 æ–°å¢æ–‡ä»¶ï¼šcostq/scripts/01-build_and_push_<mcp-server-name>.sh

**ç›®çš„**ï¼šè‡ªåŠ¨åŒ–æ„å»ºã€æ¨é€é•œåƒåˆ° ECR çš„æµç¨‹

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
1. ç™»å½• AWS ECR
2. æ„å»º ARM64 Docker é•œåƒ
3. æ‰“æ ‡ç­¾ï¼ˆ`latest` + æ—¶é—´æˆ³ç‰ˆæœ¬ï¼‰
4. æ¨é€åˆ° ECR

---

### 6.2 è„šæœ¬ç»“æ„

```bash
#!/bin/bash
#
# æ„å»º Docker é•œåƒå¹¶æ¨é€åˆ° ECR
#
# ç”¨é€”ï¼šå°† MCP Server æ‰“åŒ…æˆ ARM64 é•œåƒå¹¶ä¸Šä¼ åˆ° AWS ECR
#

set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

# =============================================================================
# é…ç½®ï¼ˆéœ€è¦æ ¹æ®å…·ä½“ MCP Server ä¿®æ”¹ï¼‰
# =============================================================================
AWS_PROFILE="3532"
AWS_REGION="ap-northeast-1"
AWS_ACCOUNT="000451883532"
ECR_REPO="awslabs-mcp/<mcp-server-name>"  # âœ… ä¿®æ”¹æ­¤å¤„
IMAGE_TAG="v$(date +%Y%m%d-%H%M%S)"

# è®¡ç®—å®Œæ•´çš„ ECR URI
ECR_URI="${AWS_ACCOUNT}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO}"
FULL_IMAGE="${ECR_URI}:${IMAGE_TAG}"

# =============================================================================
# Step 1: ç™»å½• ECR
# =============================================================================
echo "ğŸ” Step 1: ç™»å½• ECR..."
AWS_PROFILE=${AWS_PROFILE} aws ecr get-login-password --region ${AWS_REGION} | \
  docker login --username AWS --password-stdin ${AWS_ACCOUNT}.dkr.ecr.${AWS_REGION}.amazonaws.com

# =============================================================================
# Step 2: æ„å»º ARM64 é•œåƒ
# =============================================================================
echo "ğŸ”¨ Step 2: æ„å»º ARM64 Docker é•œåƒ..."

# è·å–è„šæœ¬æ‰€åœ¨ç›®å½•ï¼Œç„¶ååˆ‡æ¢åˆ°é¡¹ç›®æ ¹ç›®å½•
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/../.." && pwd)"
MCP_SERVER_DIR="${PROJECT_ROOT}/src/<mcp-server-name>"  # âœ… ä¿®æ”¹æ­¤å¤„

cd "${MCP_SERVER_DIR}"

docker buildx build \
  --platform linux/arm64 \
  -f Dockerfile-AgentCore-Runtime \
  -t ${FULL_IMAGE} \
  --load \
  .

# =============================================================================
# Step 3: æ‰“æ ‡ç­¾å¹¶æ¨é€
# =============================================================================
echo "ğŸ·ï¸  Step 3: æ‰“æ ‡ç­¾..."
docker tag ${FULL_IMAGE} ${ECR_URI}:latest

echo "ğŸ“¤ Step 4: æ¨é€é•œåƒåˆ° ECR..."
docker push ${FULL_IMAGE}
docker push ${ECR_URI}:latest

# =============================================================================
# å®Œæˆ
# =============================================================================
echo "âœ… é•œåƒéƒ¨ç½²å®Œæˆ!"
echo "é•œåƒ URI: ${FULL_IMAGE}"
```

---

### 6.3 è„šæœ¬ä½¿ç”¨æ–¹æ³•

#### 6.3.1 åˆ›å»ºè„šæœ¬
```bash
# åœ¨ costq/scripts/ ç›®å½•ä¸‹åˆ›å»º
cd costq/scripts/
touch 01-build_and_push_<mcp-server-name>.sh
chmod +x 01-build_and_push_<mcp-server-name>.sh
```

#### 6.3.2 ä¿®æ”¹é…ç½®
**éœ€è¦ä¿®æ”¹çš„å˜é‡**ï¼š
| å˜é‡ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `ECR_REPO` | ECR ä»“åº“è·¯å¾„ | `awslabs-mcp/billing-cost-management-mcp-server` |
| `MCP_SERVER_DIR` | MCP Server æºç è·¯å¾„ | `${PROJECT_ROOT}/src/billing-cost-management-mcp-server` |
| `AWS_PROFILE` | AWS CLI Profileï¼ˆå¯é€‰ï¼‰ | `3532` |
| `AWS_REGION` | AWS åŒºåŸŸï¼ˆå¯é€‰ï¼‰ | `ap-northeast-1` |

#### 6.3.3 æ‰§è¡Œè„šæœ¬
```bash
# ä»é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
bash costq/scripts/01-build_and_push_<mcp-server-name>.sh
```

**é¢„æœŸè¾“å‡º**ï¼š
```
============================================================
ğŸš€ æ„å»ºå¹¶æ¨é€ CostQ Agent é•œåƒ
============================================================
ECR ä»“åº“: 000451883532.dkr.ecr.ap-northeast-1.amazonaws.com/awslabs-mcp/...
é•œåƒæ ‡ç­¾: latest, v20260117-101036
å¹³å°: linux/arm64
============================================================

ğŸ” Step 1: ç™»å½• ECR...
âœ… ECR ç™»å½•æˆåŠŸ

ğŸ”¨ Step 2: æ„å»º ARM64 Docker é•œåƒ...
...
âœ… é•œåƒæ„å»ºæˆåŠŸ

ğŸ·ï¸  Step 3: æ‰“æ ‡ç­¾...
âœ… æ ‡ç­¾å·²åˆ›å»º: latest, v20260117-101036

ğŸ“¤ Step 4: æ¨é€é•œåƒåˆ° ECR...
âœ… é•œåƒæ¨é€æˆåŠŸ

============================================================
âœ… é•œåƒéƒ¨ç½²å®Œæˆ!
============================================================
```

---

### 6.4 è„šæœ¬ç‰¹æ€§

**ä¼˜ç‚¹**ï¼š
- âœ… è‡ªåŠ¨åŒ–ï¼šä¸€é”®å®Œæˆæ„å»ºå’Œæ¨é€
- âœ… é”™è¯¯å¤„ç†ï¼šé‡åˆ°é”™è¯¯ç«‹å³é€€å‡ºï¼ˆ`set -e`ï¼‰
- âœ… å‹å¥½è¾“å‡ºï¼šæ¸…æ™°çš„æ­¥éª¤æç¤ºå’Œ emoji æ ‡è¯†
- âœ… ç‰ˆæœ¬ç®¡ç†ï¼šè‡ªåŠ¨ç”Ÿæˆæ—¶é—´æˆ³ç‰ˆæœ¬å·
- âœ… åŒæ ‡ç­¾ï¼šåŒæ—¶æ¨é€ `latest` å’Œæ—¶é—´æˆ³ç‰ˆæœ¬

**æ³¨æ„äº‹é¡¹**ï¼š
- âš ï¸ åªæ„å»ºå’Œæ¨é€é•œåƒï¼Œ**ä¸æ›´æ–° Runtime**
- âš ï¸ éœ€è¦æ‰‹åŠ¨æ‰§è¡Œ `aws bedrock-agentcore-control update-runtime`
- âš ï¸ æ¨é€åéœ€è¦**åˆ·æ–° Gateway**ï¼ˆå‚è€ƒ DEEPV.mdï¼‰

---

### 6.5 åç»­æ‰‹åŠ¨æ­¥éª¤

**è„šæœ¬å®Œæˆåï¼Œè¿˜éœ€è¦**ï¼š

1. **æ›´æ–° Runtime**
   ```bash
   aws bedrock-agentcore-control update-runtime \
     --profile 3532 \
     --region ap-northeast-1 \
     --runtime-identifier <runtime-id> \
     --container-image <ecr-url>/<mcp-server-name>:latest
   ```

2. **åˆ·æ–° Gateway**
   - æŒ‰ç…§ DEEPV.md ä¸­çš„è¯´æ˜æ“ä½œ
   - ç¡®ä¿æ–°é•œåƒç”Ÿæ•ˆ

3. **éªŒè¯éƒ¨ç½²**
   ```bash
   # æŸ¥çœ‹æ—¥å¿—
   kubectl logs -f -n costq-fastapi deployment/costq-fastapi

   # æµ‹è¯•å¥åº·æ£€æŸ¥
   curl http://<gateway-url>/health
   ```

---

## 7. æ•°æ®åº“è®¾è®¡

### 7.1 è¡¨ç»“æ„
```sql
-- AWS è´¦å·è¡¨
CREATE TABLE aws_accounts (
    id UUID PRIMARY KEY,
    account_id VARCHAR(12) UNIQUE NOT NULL,  -- AWS è´¦å· ID
    alias VARCHAR(255),                      -- è´¦å·åˆ«å
    auth_type VARCHAR(20) NOT NULL,          -- 'aksk' | 'iam_role'

    -- AKSK ç±»å‹å­—æ®µ
    access_key_id VARCHAR(255),              -- æ˜æ–‡
    secret_access_key_encrypted TEXT,        -- Fernet åŠ å¯†

    -- IAM Role ç±»å‹å­—æ®µ
    role_arn TEXT,                           -- IAM Role ARN

    -- å…¬å…±å­—æ®µ
    region VARCHAR(50) DEFAULT 'us-east-1',
    org_id UUID,                             -- ç»„ç»‡ IDï¼ˆå¤–é”®ï¼‰

    FOREIGN KEY (org_id) REFERENCES organizations(id)
);

-- ç»„ç»‡è¡¨
CREATE TABLE organizations (
    id UUID PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    external_id VARCHAR(255) UNIQUE NOT NULL  -- AssumeRole ä½¿ç”¨
);
```

### 5.2 æ•°æ®åº“è¿æ¥é…ç½®
**ç¯å¢ƒå˜é‡ä¼˜å…ˆçº§**ï¼š
1. `DATABASE_URL`ï¼šç›´æ¥è¿æ¥ä¸²ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
2. `RDS_SECRET_NAME`ï¼šSecrets Manager å¯†é’¥åï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

**Secrets Manager æ ¼å¼**ï¼š
```json
{
    "username": "postgres",
    "password": "xxx",
    "host": "xxx.rds.amazonaws.com",
    "port": 5432,
    "database": "costq"  // æˆ– "dbname": "costq" (å…¼å®¹)
}
```

---

## 6. ç¯å¢ƒå˜é‡é…ç½®

### 6.1 å¿…éœ€ç¯å¢ƒå˜é‡
```bash
# æ•°æ®åº“è¿æ¥
RDS_SECRET_NAME=xxxx

# AKSK åŠ å¯†å¯†é’¥ï¼ˆFernetï¼ŒBase64 ç¼–ç ï¼‰
ENCRYPTION_KEY=xxxx

# AWS åŒºåŸŸ
AWS_REGION=xxxx

# MCP Server ä¼ è¾“é…ç½®
FASTMCP_TRANSPORT=streamable-http    # æˆ– stdio
FASTMCP_HOST=0.0.0.0
FASTMCP_PORT=8000
FASTMCP_STATELESS_HTTP=true
```

### 6.2 è¿è¡Œæ—¶ç¯å¢ƒå˜é‡ï¼ˆè‡ªåŠ¨è®¾ç½®ï¼‰
```bash
# boto3 è‡ªåŠ¨è¯†åˆ«çš„æ ‡å‡†ç¯å¢ƒå˜é‡
AWS_ACCESS_KEY_ID=xxxx
AWS_SECRET_ACCESS_KEY=xxxx
AWS_SESSION_TOKEN=xxxx  # ä¸´æ—¶å‡­è¯
AWS_DEFAULT_REGION=xxxx
```

---

## 7. æ”¹é€ éªŒè¯æ¸…å•

### 7.1 åŠŸèƒ½éªŒè¯
- [ ] AKSK è´¦å·å‡­è¯æå–æ­£å¸¸
- [ ] IAM Role è´¦å·å‡­è¯æå–æ­£å¸¸
- [ ] External ID æ­£ç¡®ä¼ é€’
- [ ] Session Token æ­£ç¡®å¤„ç†ï¼ˆæœ‰/æ— ï¼‰
- [ ] å¤šè´¦å·åˆ‡æ¢æ­£å¸¸
- [ ] é»˜è®¤å‡­è¯ï¼ˆæ—  target_account_idï¼‰æ­£å¸¸

### 7.2 å¼‚å¸¸å¤„ç†éªŒè¯
- [ ] è´¦å·ä¸å­˜åœ¨ â†’ AccountNotFoundError
- [ ] AKSK è§£å¯†å¤±è´¥ â†’ CredentialDecryptionError
- [ ] AssumeRole å¤±è´¥ â†’ AssumeRoleError
- [ ] æ•°æ®åº“è¿æ¥å¤±è´¥ â†’ DatabaseConnectionError

### 7.3 å®‰å…¨éªŒè¯
- [ ] æ—¥å¿—ä¸åŒ…å«ä»»ä½•å‡­è¯ä¿¡æ¯
- [ ] é”™è¯¯æ¶ˆæ¯ä¸æ³„éœ²æ•æ„Ÿä¿¡æ¯
- [ ] External ID æ­£ç¡®éªŒè¯

---

## 8. åç»­ä¼˜åŒ–æ–¹å‘

### 8.1 ç¼“å­˜æœºåˆ¶
- ä¸´æ—¶å‡­è¯ç¼“å­˜ï¼ˆé¿å…é¢‘ç¹ AssumeRoleï¼‰
- è´¦å·ä¿¡æ¯ç¼“å­˜ï¼ˆå‡å°‘æ•°æ®åº“æŸ¥è¯¢ï¼‰

### 8.2 å¹¶å‘ä¼˜åŒ–
- å¼‚æ­¥æ•°æ®åº“æŸ¥è¯¢æ± 
- è¿æ¥æ± ç®¡ç†

### 8.3 ç›‘æ§å‘Šè­¦
- å‡­è¯è¿‡æœŸç›‘æ§
- AssumeRole å¤±è´¥ç‡ç›‘æ§
- æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½ç›‘æ§
