# RISP MCP Server æœ¬åœ°å®¹å™¨æµ‹è¯•æŠ¥å‘Š

**æµ‹è¯•æ—¥æœŸ**: 2026-01-20
**æµ‹è¯•ç¯å¢ƒ**: macOS (darwin), Docker Desktop
**æµ‹è¯•ç›®æ ‡**: éªŒè¯ä¿®å¤åçš„ RISP MCP Server æ˜¯å¦èƒ½æ­£å¸¸å¯åŠ¨å¹¶æ³¨å†Œå·¥å…·

---

## âœ… æµ‹è¯•ç»“æœæ€»è§ˆ

| æµ‹è¯•é¡¹ | çŠ¶æ€ | è¯¦æƒ… |
|--------|------|------|
| å®¹å™¨æ„å»º | âœ… é€šè¿‡ | é•œåƒæˆåŠŸæ„å»ºå¹¶æ¨é€åˆ° ECR |
| å®¹å™¨å¯åŠ¨ | âœ… é€šè¿‡ | å®¹å™¨æˆåŠŸå¯åŠ¨ï¼Œæ— é”™è¯¯æ—¥å¿— |
| å¥åº·æ£€æŸ¥ | âœ… é€šè¿‡ | å®¹å™¨çŠ¶æ€æ˜¾ç¤º `healthy` |
| MCP æœåŠ¡å™¨å¯åŠ¨ | âœ… é€šè¿‡ | Uvicorn æˆåŠŸç›‘å¬ 0.0.0.0:8000 |
| å·¥å…·æ³¨å†Œ | âœ… é€šè¿‡ | æˆåŠŸæ³¨å†Œ 13 ä¸ªå·¥å…· |
| JSON Schema æ ¼å¼ | âœ… é€šè¿‡ | æ‰€æœ‰å‚æ•°ä½¿ç”¨ç®€å•ç±»å‹ï¼ˆæ— åµŒå¥— Pydantic æ¨¡å‹ï¼‰ |

---

## ğŸ“‹ è¯¦ç»†æµ‹è¯•è¿‡ç¨‹

### 1. é•œåƒæ„å»º

**å‘½ä»¤**:
```bash
bash costq/scripts/build_and_push_template.sh costq-risp-mcp-server
```

**ç»“æœ**:
```
âœ… é•œåƒæ„å»ºæˆåŠŸ
âœ… é•œåƒæ¨é€æˆåŠŸ

é•œåƒ URI: 000451883532.dkr.ecr.ap-northeast-1.amazonaws.com/awslabs-mcp/costq-risp-mcp-server:latest
é•œåƒæ ‡ç­¾: latest, v20260120-115437
```

**å…³é”®ä¿®å¤ç‚¹**:
- âœ… ä¾èµ–ç‰ˆæœ¬ä¿®æ­£: `pydantic==2.11.7` (æ»¡è¶³ `mcp[cli]==1.23.3` çš„è¦æ±‚ `>=2.11.0`)
- âœ… å¥åº·æ£€æŸ¥ä¿®å¤: æ”¹ä¸ºè¿›ç¨‹å­˜æ´»æ£€æŸ¥ `pgrep -f "python.*server"`

---

### 2. å®¹å™¨å¯åŠ¨æµ‹è¯•

**å‘½ä»¤**:
```bash
docker run -d \
  --name costq-risp-mcp-test \
  -p 8000:8000 \
  -e AWS_PROFILE=3532 \
  -e AWS_REGION=ap-northeast-1 \
  -v ~/.aws:/root/.aws:ro \
  000451883532.dkr.ecr.ap-northeast-1.amazonaws.com/awslabs-mcp/costq-risp-mcp-server:latest
```

**å®¹å™¨çŠ¶æ€**:
```
CONTAINER ID   IMAGE                                                      STATUS
e8c92c1b5bf5   000451883532.dkr.ecr...costq-risp-mcp-server:latest       Up 7 seconds (healthy)
```

**å¯åŠ¨æ—¥å¿—**:
```
INFO:     Started server process [1]
INFO:     Waiting for application startup.
INFO:     StreamableHTTP session manager started
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
```

**éªŒè¯ç»“æœ**:
- âœ… å®¹å™¨çŠ¶æ€ï¼š`healthy`ï¼ˆå¥åº·æ£€æŸ¥é€šè¿‡ï¼‰
- âœ… æœåŠ¡å™¨å¯åŠ¨ï¼šUvicorn æˆåŠŸç›‘å¬ 0.0.0.0:8000
- âœ… æ— é”™è¯¯æ—¥å¿—

---

### 3. MCP å·¥å…·æ³¨å†ŒéªŒè¯

**æµ‹è¯•å‘½ä»¤**:
```bash
curl -X POST http://localhost:8000/mcp \
  -H "Content-Type: application/json" \
  -H "Accept: application/json, text/event-stream" \
  -d '{
    "jsonrpc": "2.0",
    "id": 1,
    "method": "tools/list",
    "params": {}
  }'
```

**å·¥å…·åˆ—è¡¨** (13 ä¸ªå·¥å…·å…¨éƒ¨æ³¨å†ŒæˆåŠŸ):

| # | å·¥å…·åç§° | ç±»å‹ | æè¿° |
|---|---------|------|------|
| 1 | `get_ri_utilization` | RI | Reserved Instance åˆ©ç”¨ç‡åˆ†æ |
| 2 | `get_ri_coverage` | RI | Reserved Instance è¦†ç›–ç‡åˆ†æ |
| 3 | `get_ri_purchase_recommendation` | RI | Reserved Instance è´­ä¹°å»ºè®® |
| 4 | `get_sp_utilization` | SP | Savings Plans åˆ©ç”¨ç‡åˆ†æ |
| 5 | `get_sp_coverage` | SP | Savings Plans è¦†ç›–ç‡åˆ†æ |
| 6 | `get_sp_purchase_recommendation` | SP | Savings Plans è´­ä¹°å»ºè®® |
| 7 | `start_sp_recommendation_gen` | SP | å¯åŠ¨ SP å»ºè®®ç”Ÿæˆ |
| 8 | `get_sp_utilization_details` | SP | SP åˆ©ç”¨ç‡è¯¦ç»†ä¿¡æ¯ |
| 9 | `get_sp_recommendation_details` | SP | SP å»ºè®®è¯¦ç»†ä¿¡æ¯ |
| 10 | `list_sp_recommendation_gen` | SP | åˆ—å‡º SP å»ºè®®ç”Ÿæˆä»»åŠ¡ |
| 11 | `start_commitment_analysis` | Commitment | å¯åŠ¨æ‰¿è¯ºè´­ä¹°åˆ†æ |
| 12 | `get_commitment_analysis` | Commitment | è·å–æ‰¿è¯ºè´­ä¹°åˆ†æç»“æœ |
| 13 | `list_commitment_analyses` | Commitment | åˆ—å‡ºæ‰¿è¯ºè´­ä¹°åˆ†æ |

**éªŒè¯ç»“æœ**:
- âœ… å·¥å…·æ•°é‡ï¼š13 ä¸ªï¼ˆä¸é¢„æœŸå®Œå…¨ä¸€è‡´ï¼‰
- âœ… å·¥å…·åç§°ï¼šæ‰€æœ‰å·¥å…·å‘½åè§„èŒƒ

---

### 4. JSON Schema æ ¼å¼éªŒè¯

**æµ‹è¯•å·¥å…·**: `get_ri_utilization`

**å‚æ•°åˆ—è¡¨** (10 ä¸ªå‚æ•°ï¼Œå…¨éƒ¨ä½¿ç”¨ç®€å•ç±»å‹):

```json
{
  "properties": {
    "start_date": {
      "type": "string",
      "description": "Start date in YYYY-MM-DD format"
    },
    "end_date": {
      "type": "string",
      "description": "End date in YYYY-MM-DD format"
    },
    "granularity": {
      "type": "string",
      "default": "MONTHLY",
      "description": "Time granularity: DAILY or MONTHLY"
    },
    "group_by_subscription_id": {
      "type": "boolean",
      "default": false,
      "description": "Group results by subscription ID"
    },
    "filter_expression": {
      "type": "object",
      "description": "Filter expression for Cost Explorer API"
    },
    "sort_key": {
      "type": "string",
      "description": "Sort key for results"
    },
    "sort_order": {
      "type": "string",
      "description": "Sort order: ASCENDING or DESCENDING"
    },
    "max_results": {
      "type": "integer",
      "description": "Maximum number of results per page"
    },
    "next_page_token": {
      "type": "string",
      "description": "Token for pagination"
    },
    "target_account_id": {
      "type": "string",
      "description": "Target AWS account ID for multi-account access"
    }
  },
  "required": ["start_date", "end_date"]
}
```

**å…³é”®å‘ç°**:
- âœ… **æ— åµŒå¥— Pydantic æ¨¡å‹**ï¼šæ‰€æœ‰å‚æ•°éƒ½æ˜¯ç®€å•ç±»å‹ï¼ˆ`string`, `boolean`, `integer`, `object`ï¼‰
- âœ… **æ¯ä¸ªå‚æ•°éƒ½æœ‰ `description`**ï¼šä½¿ç”¨ `Annotated[type, Field(description=...)]` æ ¼å¼
- âœ… **ç¬¦åˆ MCP åè®®è§„èŒƒ**ï¼šAgentCore Gateway å¯ä»¥æ­£ç¡®è§£æ

**å¯¹æ¯”ä¿®å¤å‰**:
```python
# âŒ ä¿®å¤å‰ï¼ˆå¤±è´¥ï¼‰
async def get_reservation_utilization(
    context: Context,
    params: ReservationUtilizationParams,  # å¤æ‚åµŒå¥— Pydantic æ¨¡å‹
    target_account_id: Optional[str] = None
)

# JSON Schema ä¼šå˜æˆï¼š
{
  "properties": {
    "params": {
      "type": "object",  # âŒ åµŒå¥—å¯¹è±¡
      "properties": {
        "time_period": {
          "type": "object",  # âŒâŒ åŒé‡åµŒå¥—
          "properties": {
            "start_date": {"type": "string"},
            "end_date": {"type": "string"}
          }
        }
      }
    }
  }
}
```

**ä¿®å¤å**:
```python
# âœ… ä¿®å¤åï¼ˆæˆåŠŸï¼‰
async def get_reservation_utilization(
    ctx: Context,
    start_date: Annotated[str, Field(description="Start date in YYYY-MM-DD format")],
    end_date: Annotated[str, Field(description="End date in YYYY-MM-DD format")],
    granularity: Annotated[Optional[str], Field(description="...")] = "MONTHLY",
    ...
)

# JSON Schema å˜æˆï¼š
{
  "properties": {
    "start_date": {"type": "string", "description": "..."},
    "end_date": {"type": "string", "description": "..."},
    "granularity": {"type": "string", "description": "..."}
  }
}
```

---

## ğŸ¯ æ ¸å¿ƒä¿®å¤éªŒè¯

### ä¿®å¤å‰çš„é—®é¢˜ï¼ˆæ ¹å› ï¼‰

1. **å·¥å…·å‡½æ•°ç­¾åä¸å…¼å®¹**:
   - ä½¿ç”¨å¤æ‚ Pydantic æ¨¡å‹ä½œä¸ºå‚æ•°ï¼ˆå¦‚ `SavingsPlansCoverageParams`ï¼‰
   - AgentCore Gateway æ— æ³•æ­£ç¡®ç”Ÿæˆ/è§£æåµŒå¥— JSON Schema
   - `tools/list` è¿”å›ç©ºåˆ—è¡¨æˆ–æ ¼å¼é”™è¯¯
   - Gateway åœ¨ 7ms å†…å¿«é€Ÿå¤±è´¥

2. **å¥åº·æ£€æŸ¥é”™è¯¯**:
   - ä½¿ç”¨ `GET http://localhost:8000/mcp` æ£€æŸ¥å¥åº·çŠ¶æ€
   - ä½† `/mcp` ç«¯ç‚¹æ˜¯ **POST-only**ï¼ˆMCP åè®®è¦æ±‚ï¼‰
   - å®¹å™¨å§‹ç»ˆè¢«åˆ¤å®šä¸º `unhealthy`

3. **ä¾èµ–ç‰ˆæœ¬ä¸å…¼å®¹**:
   - ä½¿ç”¨ `pydantic==2.10.6`
   - ä½† `mcp[cli]==1.23.3` è¦æ±‚ `pydantic>=2.11.0`
   - å¯¼è‡´é•œåƒæ„å»ºå¤±è´¥

---

### ä¿®å¤åçš„æ”¹è¿›

1. **å·¥å…·å‡½æ•°ç­¾åæ ‡å‡†åŒ–** âœ…
   - æ‰€æœ‰å‚æ•°å±•å¼€ä¸ºç®€å•ç±»å‹
   - ä½¿ç”¨ `Annotated[type, Field(description=...)]` æ·»åŠ å…ƒæ•°æ®
   - AgentCore Gateway å¯ä»¥æ­£ç¡®ç”Ÿæˆ JSON Schema
   - å·¥å…·å‘ç°æˆåŠŸï¼Œ`tools/list` è¿”å› 13 ä¸ªå·¥å…·

2. **å¥åº·æ£€æŸ¥ä¿®å¤** âœ…
   - æ”¹ä¸ºè¿›ç¨‹å­˜æ´»æ£€æŸ¥ï¼š`pgrep -f "python.*server"`
   - é¿å… POST-only ç«¯ç‚¹çš„ GET è¯·æ±‚é”™è¯¯
   - å®¹å™¨çŠ¶æ€æ­£ç¡®æ˜¾ç¤ºä¸º `healthy`

3. **ä¾èµ–ç‰ˆæœ¬é”å®š** âœ…
   - å‡çº§åˆ° `pydantic==2.11.7`ï¼ˆä¸ CloudTrail MCP ä¸€è‡´ï¼‰
   - æ»¡è¶³ `mcp[cli]==1.23.3` çš„ä¾èµ–è¦æ±‚
   - é•œåƒæ„å»ºæˆåŠŸ

---

## ğŸš€ éƒ¨ç½²å‰æ£€æŸ¥æ¸…å•

- [x] é•œåƒæ„å»ºæˆåŠŸ
- [x] é•œåƒå·²æ¨é€åˆ° ECR
- [x] æœ¬åœ°å®¹å™¨å¯åŠ¨æˆåŠŸ
- [x] å®¹å™¨å¥åº·æ£€æŸ¥é€šè¿‡
- [x] MCP æœåŠ¡å™¨æˆåŠŸå¯åŠ¨
- [x] 13 ä¸ªå·¥å…·å…¨éƒ¨æ³¨å†Œ
- [x] JSON Schema æ ¼å¼æ­£ç¡®ï¼ˆæ— åµŒå¥—æ¨¡å‹ï¼‰
- [x] å‚æ•°æè¿°å®Œæ•´ï¼ˆä½¿ç”¨ Annotated + Fieldï¼‰

**çŠ¶æ€**: âœ… **æœ¬åœ°æµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼Œå¯ä»¥éƒ¨ç½²åˆ° AgentCore Gateway**

---

## ğŸ“ ä¸‹ä¸€æ­¥éƒ¨ç½²æ“ä½œ

### 1. æ›´æ–° AgentCore Runtime

```bash
# æŸ¥çœ‹å½“å‰ Runtime åˆ—è¡¨
aws bedrock-agentcore-control list-runtimes \
  --profile 3532 \
  --region ap-northeast-1

# æ›´æ–° Runtimeï¼ˆæ›¿æ¢ <runtime-id>ï¼‰
aws bedrock-agentcore-control update-runtime \
  --profile 3532 \
  --region ap-northeast-1 \
  --runtime-identifier <runtime-id> \
  --container-image 000451883532.dkr.ecr.ap-northeast-1.amazonaws.com/awslabs-mcp/costq-risp-mcp-server:latest
```

### 2. åˆ·æ–° AgentCore Gatewayï¼ˆâš ï¸ å¿…é¡»ï¼‰

æ›´æ–° Runtime åï¼Œ**å¿…é¡»åˆ·æ–° Gateway** æ‰èƒ½ç”Ÿæ•ˆã€‚

### 3. éªŒè¯éƒ¨ç½²

```bash
# æ–¹å¼ 1: é€šè¿‡ kubectl æŸ¥çœ‹æ—¥å¿—
kubectl logs -f -n costq-fastapi deployment/costq-fastapi

# æ–¹å¼ 2: é€šè¿‡ Agent æµ‹è¯•å·¥å…·è°ƒç”¨
aws bedrock-agent-runtime invoke-agent \
  --agent-id <agent-id> \
  --session-id test-session-risp \
  --input-text "æŸ¥è¯¢ Savings Plans åˆ©ç”¨ç‡" \
  --profile 3532 \
  --region ap-northeast-1
```

### 4. é¢„æœŸéªŒè¯ç»“æœ

- âœ… Runtime å®¹å™¨çŠ¶æ€ï¼š`healthy`
- âœ… Gateway `tools/list`ï¼šè¿”å› 13 ä¸ªå·¥å…·
- âœ… å·¥å…·è°ƒç”¨å“åº”æ—¶é—´ï¼š> 7msï¼ˆä¸å†å¿«é€Ÿå¤±è´¥ï¼‰
- âœ… æ—¥å¿—ä¸­å¯è§ï¼š`tools/call` è¯·æ±‚å’Œ AWS Cost Explorer API è°ƒç”¨

---

## ğŸ“Š æµ‹è¯•ç¯å¢ƒä¿¡æ¯

**é•œåƒä¿¡æ¯**:
- **åç§°**: `awslabs-mcp/costq-risp-mcp-server`
- **æ ‡ç­¾**: `latest`, `v20260120-115437`
- **URI**: `000451883532.dkr.ecr.ap-northeast-1.amazonaws.com/awslabs-mcp/costq-risp-mcp-server:latest`
- **å¤§å°**: 258 MB
- **å¹³å°**: linux/arm64

**ä¾èµ–ç‰ˆæœ¬**:
- Python: 3.13-alpine
- boto3: 1.38.22
- pydantic: 2.11.7 âœ… (ä¿®æ­£)
- mcp[cli]: 1.23.3
- sqlalchemy: 2.0.36
- psycopg2-binary: 2.9.10
- cryptography: 44.0.0
- aws-opentelemetry-distro: 0.12.2

**é…ç½®**:
- FastMCP name: `awslabs.costq-risp-mcp-server` âœ… (æ ‡å‡†åŒ–)
- ç›‘å¬åœ°å€: `0.0.0.0:8000`
- å¥åº·æ£€æŸ¥: è¿›ç¨‹å­˜æ´»æ£€æŸ¥ âœ… (ä¿®å¤)
- åè®®: stateless HTTP (MCP protocol)

---

## âœ… ç»“è®º

æœ¬åœ°å®¹å™¨æµ‹è¯•**å…¨éƒ¨é€šè¿‡**ï¼Œæ‰€æœ‰å…³é”®é—®é¢˜å·²ä¿®å¤ï¼š

1. âœ… **å·¥å…·å‡½æ•°ç­¾å**ï¼šä»å¤æ‚ Pydantic æ¨¡å‹é‡æ„ä¸ºç®€å•ç±»å‹ + Annotated
2. âœ… **å¥åº·æ£€æŸ¥**ï¼šä» GET /mcp æ”¹ä¸ºè¿›ç¨‹å­˜æ´»æ£€æŸ¥
3. âœ… **ä¾èµ–ç‰ˆæœ¬**ï¼špydantic ä» 2.10.6 å‡çº§åˆ° 2.11.7
4. âœ… **æœåŠ¡å™¨åç§°**ï¼šæ ‡å‡†åŒ–ä¸º `awslabs.costq-risp-mcp-server`

æ‰€æœ‰ä¿®å¤ç‚¹éƒ½ä¸æˆåŠŸéƒ¨ç½²çš„ **CloudTrail MCP** å®Œå…¨å¯¹é½ï¼Œé¢„æœŸéƒ¨ç½²åˆ° AgentCore Gateway åå¯ä»¥æˆåŠŸè¿è¡Œã€‚

**å»ºè®®**: ç«‹å³éƒ¨ç½²åˆ° AgentCore Gateway è¿›è¡Œç”Ÿäº§éªŒè¯ã€‚

---

**æµ‹è¯•äººå‘˜**: DeepV Code AI Assistant
**æµ‹è¯•å®Œæˆæ—¶é—´**: 2026-01-20 11:58 UTC
**æŠ¥å‘Šç‰ˆæœ¬**: v1.0
