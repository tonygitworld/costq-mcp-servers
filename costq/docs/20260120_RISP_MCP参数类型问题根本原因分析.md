# RISP MCP å‚æ•°ç±»å‹é—®é¢˜æ ¹æœ¬åŸå› åˆ†æ

**æ—¥æœŸ**: 2026-01-20  
**é—®é¢˜**: RISP MCP Server é€šè¿‡ AgentCore Gateway è°ƒç”¨æ—¶æŠ¥é”™ï¼š`Field 'filter_expression' has invalid type: $.filter_expression: string found, object expected`

## ğŸ” æ ¹æœ¬åŸå› 

### é—®é¢˜ç°è±¡

å½“é€šè¿‡ AgentCore Gateway è°ƒç”¨ RISP MCP å·¥å…·æ—¶ï¼Œä¼ é€’çš„å‚æ•°éªŒè¯å¤±è´¥ï¼š

```json
{
  "filter_expression": {
    "Dimensions": {
      "Key": "SERVICE",
      "Values": ["Amazon Elastic Compute Cloud - Compute"]
    }
  }
}
```

é”™è¯¯ä¿¡æ¯ï¼š
```
JsonSchemaException - Parameter validation failed: Invalid request parameters:
- Field 'filter_expression' has invalid type: $.filter_expression: string found, object expected
- Field 'filter_expression' has invalid type: $.filter_expression: string found, null expected
```

### æ ¹æœ¬åŸå› åˆ†æ

#### 1. å½“å‰å®ç°æ–¹å¼ï¼ˆé”™è¯¯ï¼‰

**å‚æ•°å®šä¹‰**ï¼š
```python
filter_expression: Optional[str] = None
```

**å¤„ç†é€»è¾‘**ï¼š
```python
parsed_filter = parse_json(filter_expression, 'filter_expression') if filter_expression else None
```

**parse_json å‡½æ•°**ï¼š
```python
def parse_json(json_str: Optional[str], parameter_name: str) -> Any:
    if not json_str:
        return None
    return json.loads(json_str)  # âŒ æœŸæœ›æ¥æ”¶å­—ç¬¦ä¸²ï¼Œä½†å®é™…æ¥æ”¶åˆ° dict
```

#### 2. ä¸ºä»€ä¹ˆ Billing MCP æ²¡æœ‰é—®é¢˜ï¼Ÿ

**Billing MCP çš„è°ƒç”¨æ–¹å¼**ï¼š
- é€šè¿‡ **STDio MCP**ï¼ˆæœ¬åœ°å­è¿›ç¨‹ï¼‰è°ƒç”¨
- å‚æ•°ä»¥ **JSON å­—ç¬¦ä¸²** å½¢å¼ä¼ é€’
- `parse_json()` å‡½æ•°æ­£å¸¸å·¥ä½œ

**RISP MCP çš„è°ƒç”¨æ–¹å¼**ï¼š
- é€šè¿‡ **AgentCore Gateway**ï¼ˆHTTPS è¿œç¨‹è°ƒç”¨ï¼‰è°ƒç”¨
- å‚æ•°ä»¥ **åŸç”Ÿ Python å¯¹è±¡**ï¼ˆdict/listï¼‰å½¢å¼ä¼ é€’
- `parse_json()` å‡½æ•°å¤±è´¥ï¼ˆå°è¯•å¯¹ dict è°ƒç”¨ `json.loads()`ï¼‰

#### 3. å‚è€ƒä»£ç çš„æ­£ç¡®å®ç°æ–¹å¼

æŸ¥çœ‹ `costq/docs/01_å‚è€ƒä»£ç /backend/mcp/risp_mcp_server/` ä¸­çš„å®ç°ï¼š

**å‚æ•°æ¨¡å‹å®šä¹‰**ï¼ˆä½¿ç”¨ Pydanticï¼‰ï¼š
```python
class ReservationUtilizationParams(BaseModel):
    time_period: DateRange
    granularity: str | None = "MONTHLY"
    filter_expression: dict[str, Any] | None = None  # âœ… åŸç”Ÿ dict ç±»å‹
    sort_key: str | None = None
    # ...
```

**Handler å‡½æ•°ç­¾å**ï¼š
```python
async def get_reservation_utilization(
    context: Context, 
    params: ReservationUtilizationParams  # âœ… ä½¿ç”¨ Pydantic æ¨¡å‹
) -> dict[str, Any]:
```

**å‚æ•°ä½¿ç”¨**ï¼ˆæ— éœ€è§£æï¼‰ï¼š
```python
if params.filter_expression:
    request_params["Filter"] = params.filter_expression  # âœ… ç›´æ¥ä½¿ç”¨ï¼Œæ— éœ€ parse_json
```

## ğŸ¯ æ­£ç¡®çš„è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | å‚æ•°ç±»å‹ | è§£ææ–¹å¼ | é€‚ç”¨åœºæ™¯ |
|------|---------|---------|---------|
| **å½“å‰å®ç°** | `Optional[str]` | `parse_json()` | âŒ STDio MCP only |
| **Spec æ–¹æ¡ˆ** | `Optional[str]` | `parse_json()` | âŒ STDio MCP only |
| **å‚è€ƒä»£ç ** | `dict[str, Any] \| None` | æ— éœ€è§£æ | âœ… Gateway + STDio |

### æ¨èæ–¹æ¡ˆï¼šä½¿ç”¨åŸç”Ÿ Python ç±»å‹

#### æ–¹æ¡ˆ Aï¼šä½¿ç”¨ Pydantic æ¨¡å‹ï¼ˆå‚è€ƒä»£ç æ–¹å¼ï¼‰

**ä¼˜ç‚¹**ï¼š
- âœ… ç±»å‹å®‰å…¨ï¼Œè‡ªåŠ¨éªŒè¯
- âœ… åŒæ—¶æ”¯æŒ Gateway å’Œ STDio è°ƒç”¨
- âœ… ä»£ç æ¸…æ™°ï¼Œæ— éœ€æ‰‹åŠ¨è§£æ

**ç¼ºç‚¹**ï¼š
- âš ï¸ éœ€è¦å®šä¹‰é¢å¤–çš„ Pydantic æ¨¡å‹
- âš ï¸ æ”¹åŠ¨è¾ƒå¤§

**å®ç°ç¤ºä¾‹**ï¼š
```python
# models/ri_models.py
class ReservationUtilizationParams(BaseModel):
    time_period: DateRange
    granularity: str | None = "MONTHLY"
    filter_expression: dict[str, Any] | None = None
    group_by_subscription_id: bool | None = False
    sort_key: str | None = None
    sort_order: str | None = None
    max_results: int | None = None
    next_page_token: str | None = None
    target_account_id: str | None = None

# handlers/ri_handler.py
async def get_reservation_utilization(
    ctx: Context,
    params: ReservationUtilizationParams
) -> dict[str, Any]:
    # ç›´æ¥ä½¿ç”¨ params.filter_expressionï¼Œæ— éœ€è§£æ
    if params.filter_expression:
        request_params["Filter"] = params.filter_expression
```

#### æ–¹æ¡ˆ Bï¼šä½¿ç”¨åŸç”Ÿç±»å‹ + ç±»å‹æ£€æŸ¥ï¼ˆæ··åˆæ–¹å¼ï¼‰

**ä¼˜ç‚¹**ï¼š
- âœ… æ”¹åŠ¨æœ€å°
- âœ… åŒæ—¶æ”¯æŒ Gatewayï¼ˆdictï¼‰å’Œ STDioï¼ˆstrï¼‰è°ƒç”¨
- âœ… å‘åå…¼å®¹

**ç¼ºç‚¹**ï¼š
- âš ï¸ éœ€è¦æ‰‹åŠ¨ç±»å‹æ£€æŸ¥
- âš ï¸ ä»£ç ç•¥æ˜¾å†—ä½™

**å®ç°ç¤ºä¾‹**ï¼š
```python
async def get_reservation_utilization(
    ctx: Context,
    start_date: str,
    end_date: str,
    granularity: Optional[str] = "MONTHLY",
    filter_expression: Optional[dict | str] = None,  # âœ… æ”¯æŒ dict æˆ– str
    # ... å…¶ä»–å‚æ•°
) -> dict[str, Any]:
    # å¤„ç† filter_expressionï¼šæ”¯æŒ dictï¼ˆGatewayï¼‰æˆ– strï¼ˆSTDioï¼‰
    parsed_filter = None
    if filter_expression:
        if isinstance(filter_expression, dict):
            # Gateway ä¼ é€’çš„åŸç”Ÿ dictï¼Œç›´æ¥ä½¿ç”¨
            parsed_filter = filter_expression
        elif isinstance(filter_expression, str):
            # STDio ä¼ é€’çš„ JSON å­—ç¬¦ä¸²ï¼Œéœ€è¦è§£æ
            try:
                parsed_filter = json.loads(filter_expression)
            except json.JSONDecodeError:
                return format_error_response(
                    error=ValueError(f'Invalid JSON format for filter_expression: {filter_expression}'),
                    operation="get_reservation_utilization"
                )
    
    if parsed_filter:
        request_params["Filter"] = parsed_filter
```

## ğŸ“‹ ä¿®å¤æ­¥éª¤

### æ¨èï¼šæ–¹æ¡ˆ Bï¼ˆæœ€å°æ”¹åŠ¨ï¼‰

1. **ä¿®æ”¹å‚æ•°ç±»å‹å®šä¹‰**ï¼š
   ```python
   # å°†æ‰€æœ‰ JSON å‚æ•°ä» Optional[str] æ”¹ä¸º Optional[dict | str] æˆ– Optional[list | str]
   filter_expression: Optional[dict | str] = None
   group_by: Optional[list | str] = None
   service_specification: Optional[dict | str] = None
   ```

2. **ä¿®æ”¹ parse_json å‡½æ•°**ï¼š
   ```python
   def parse_json(json_input: Optional[str | dict | list], parameter_name: str) -> Any:
       """Parse JSON input that can be either a string or already-parsed object."""
       if not json_input:
           return None
       
       # å¦‚æœå·²ç»æ˜¯ dict/listï¼ˆæ¥è‡ª Gatewayï¼‰ï¼Œç›´æ¥è¿”å›
       if isinstance(json_input, (dict, list)):
           return json_input
       
       # å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼ˆæ¥è‡ª STDioï¼‰ï¼Œè§£æ JSON
       if isinstance(json_input, str):
           try:
               return json.loads(json_input)
           except json.JSONDecodeError:
               raise ValueError(f'Invalid JSON format for {parameter_name} parameter: {json_input}')
       
       # å…¶ä»–ç±»å‹ï¼Œè¿”å› None
       return None
   ```

3. **æ›´æ–°æ‰€æœ‰ handler å‡½æ•°**ï¼š
   - å°† `Optional[str]` æ”¹ä¸º `Optional[dict | str]` æˆ– `Optional[list | str]`
   - ä¿æŒ `parse_json()` è°ƒç”¨ä¸å˜ï¼ˆå‡½æ•°å†…éƒ¨å·²å¤„ç†ç±»å‹æ£€æŸ¥ï¼‰

4. **æµ‹è¯•éªŒè¯**ï¼š
   - æµ‹è¯• Gateway è°ƒç”¨ï¼ˆä¼ é€’ dict/listï¼‰
   - æµ‹è¯• STDio è°ƒç”¨ï¼ˆä¼ é€’ JSON å­—ç¬¦ä¸²ï¼‰
   - éªŒè¯é”™è¯¯å¤„ç†

## ğŸš¨ é‡è¦ç»“è®º

1. **Spec çš„æ–¹å‘æ˜¯é”™è¯¯çš„**ï¼š
   - Spec åŸºäº Billing MCP çš„å®ç°ï¼ˆSTDio MCPï¼‰
   - ä½† RISP MCP é€šè¿‡ Gateway è°ƒç”¨ï¼Œå‚æ•°ä¼ é€’æ–¹å¼ä¸åŒ
   - éœ€è¦é‡æ–°è®¾è®¡ Spec

2. **å‚è€ƒä»£ç æ˜¯æ­£ç¡®çš„**ï¼š
   - ä½¿ç”¨ Pydantic æ¨¡å‹ + åŸç”Ÿ Python ç±»å‹
   - æ— éœ€ JSON å­—ç¬¦ä¸²è§£æ
   - åŒæ—¶æ”¯æŒ Gateway å’Œ STDio

3. **æ¨èæ–¹æ¡ˆ**ï¼š
   - çŸ­æœŸï¼šæ–¹æ¡ˆ Bï¼ˆæœ€å°æ”¹åŠ¨ï¼Œå‘åå…¼å®¹ï¼‰
   - é•¿æœŸï¼šæ–¹æ¡ˆ Aï¼ˆé‡æ„ä¸º Pydantic æ¨¡å‹ï¼Œç±»å‹å®‰å…¨ï¼‰

## ğŸ“š ç›¸å…³æ–‡ä»¶

- å‚è€ƒä»£ç ï¼š`costq/docs/01_å‚è€ƒä»£ç /backend/mcp/risp_mcp_server/`
- å½“å‰å®ç°ï¼š`src/costq-risp-mcp-server/handlers/ri_handler.py`
- Spec æ–‡ä»¶ï¼š`.kiro/specs/costq-risp-parameter-type-fix/`
- Billing MCPï¼š`src/billing-cost-management-mcp-server/`

## ğŸ”— ç›¸å…³é—®é¢˜

- AgentCore Gateway vs STDio MCP å‚æ•°ä¼ é€’å·®å¼‚
- Pydantic æ¨¡å‹åœ¨ MCP ä¸­çš„ä½¿ç”¨
- FastMCP ç±»å‹æ³¨è§£æœ€ä½³å®è·µ
