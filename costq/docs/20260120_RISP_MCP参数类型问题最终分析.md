# RISP MCP å‚æ•°ç±»å‹é—®é¢˜æœ€ç»ˆåˆ†æ

**æ—¥æœŸ**: 2026-01-20  
**é—®é¢˜**: RISP MCP Server åœ¨ Gateway éƒ¨ç½²åå‡ºç°å‚æ•°ç±»å‹éªŒè¯é”™è¯¯  
**é”™è¯¯ä¿¡æ¯**: `Field 'filter_expression' has invalid type: $.filter_expression: string found, object expected`

## ğŸ” è°ƒæŸ¥è¿‡ç¨‹

### 1. åˆæ­¥å‡è®¾ï¼ˆâŒ é”™è¯¯ï¼‰

**å‡è®¾**: Billing MCP ä½¿ç”¨ STDio ä¼ è¾“ï¼ŒRISP MCP ä½¿ç”¨ Gateway ä¼ è¾“ï¼Œå› æ­¤å‚æ•°ç±»å‹ä¸åŒã€‚

**éªŒè¯ç»“æœ**: 
- âœ… Billing MCP **ä¹Ÿéƒ¨ç½²åˆ° Gateway**ï¼ˆé€šè¿‡ `entrypoint.py`ï¼‰
- âœ… ä¸¤è€…éƒ½ä½¿ç”¨ç›¸åŒçš„ `parse_json()` å®ç°
- âŒ è¿™ä¸ªå‡è®¾ä¸æˆç«‹

### 2. ä»£ç å¯¹æ¯”åˆ†æ

#### Billing MCP çš„ `parse_json()` å®ç°
```python
# src/billing-cost-management-mcp-server/awslabs/billing_cost_management_mcp_server/utilities/aws_service_base.py
def parse_json(json_str: Optional[str], parameter_name: str) -> Any:
    if not json_str:
        return None
    try:
        return json.loads(json_str)
    except json.JSONDecodeError:
        raise ValueError(f'Invalid JSON format for {parameter_name} parameter: {json_str}')
```

#### RISP MCP çš„ `parse_json()` å®ç°
```python
# src/costq-risp-mcp-server/utils/formatters.py
def parse_json(json_str: Optional[str], parameter_name: str) -> Any:
    if not json_str:
        return None
    try:
        return json.loads(json_str)
    except json.JSONDecodeError:
        raise ValueError(f'Invalid JSON format for {parameter_name} parameter: {json_str}')
```

**ç»“è®º**: ä¸¤è€…çš„å®ç°**å®Œå…¨ç›¸åŒ**ï¼

### 3. éƒ¨ç½²æ–¹å¼å¯¹æ¯”

| ç‰¹æ€§ | Billing MCP | RISP MCP |
|------|-------------|----------|
| **Dockerfile CMD** | `ENTRYPOINT ["awslabs.billing-cost-management-mcp-server"]` | `CMD ["opentelemetry-instrument", "python", "server.py"]` |
| **å…¥å£ç‚¹** | `server.py:main()` (é€šè¿‡ pyproject.toml) | `server.py:main()` (ç›´æ¥) |
| **entrypoint.py** | âœ… å­˜åœ¨ï¼ˆå¯é€‰ï¼‰ | âŒ ä¸å­˜åœ¨ |
| **FastMCP åˆå§‹åŒ–** | `mcp = FastMCP(...)` | `app = FastMCP(...)` |
| **ä¼ è¾“æ–¹å¼** | `mcp.run()` (é»˜è®¤) | `app.run(transport="streamable-http")` |

### 4. å…³é”®å‘ç°ï¼šFastMCP ä¼ è¾“å±‚çš„å‚æ•°å¤„ç†

#### Billing MCP çš„ `server.py:main()`
```python
def main():
    asyncio.run(setup())
    mcp.run()  # âš ï¸ ä½¿ç”¨é»˜è®¤ä¼ è¾“ï¼ˆä»ç¯å¢ƒå˜é‡è¯»å–ï¼‰
```

#### RISP MCP çš„ `server.py:main()`
```python
def main():
    """Run the MCP server with streamable HTTP transport for AgentCore."""
    app.run(transport="streamable-http")  # âš ï¸ ç¡¬ç¼–ç ä¸º streamable-http
```

#### Billing MCP çš„ `entrypoint.py:main()`ï¼ˆå¯é€‰å¯åŠ¨æ–¹å¼ï¼‰
```python
def main():
    from awslabs.billing_cost_management_mcp_server.server import mcp, setup
    
    transport = os.environ.get("FASTMCP_TRANSPORT", "streamable-http")
    # ...
    asyncio.run(setup())
    
    if transport == "stdio":
        mcp.run(transport=transport)
    else:
        mcp.run(transport=transport, host=host, port=port, stateless_http=stateless)
```

## ğŸ¯ æ ¹æœ¬åŸå› åˆ†æ

### é—®é¢˜1: FastMCP çš„å‚æ•°åºåˆ—åŒ–è¡Œä¸º

FastMCP åœ¨ä¸åŒä¼ è¾“æ¨¡å¼ä¸‹çš„å‚æ•°å¤„ç†ï¼š

1. **STDio ä¼ è¾“**:
   - å‚æ•°é€šè¿‡ JSON-RPC ä¼ é€’
   - æ‰€æœ‰å‚æ•°éƒ½æ˜¯ JSON å­—ç¬¦ä¸²
   - éœ€è¦ `parse_json()` è§£æ

2. **Streamable-HTTP ä¼ è¾“ï¼ˆGatewayï¼‰**:
   - å‚æ•°é€šè¿‡ HTTP POST ä¼ é€’
   - **å‚æ•°å¯èƒ½å·²ç»è¢«ååºåˆ—åŒ–ä¸º Python å¯¹è±¡**
   - å¦‚æœå†è°ƒç”¨ `parse_json()`ï¼Œä¼šå°è¯•å¯¹ dict/list è°ƒç”¨ `json.loads()`ï¼Œå¯¼è‡´é”™è¯¯

### é—®é¢˜2: ä¸ºä»€ä¹ˆ Billing MCP å·¥ä½œæ­£å¸¸ï¼Ÿ

**å¯èƒ½çš„åŸå› **:

1. **Billing MCP ä½¿ç”¨é»˜è®¤ä¼ è¾“**:
   ```python
   mcp.run()  # ä»ç¯å¢ƒå˜é‡è¯»å– FASTMCP_TRANSPORT
   ```
   - å¦‚æœç¯å¢ƒå˜é‡è®¾ç½®ä¸º `stdio`ï¼Œåˆ™ä½¿ç”¨ STDio ä¼ è¾“
   - å¦‚æœæœªè®¾ç½®æˆ–è®¾ç½®ä¸º `streamable-http`ï¼Œåˆ™ä½¿ç”¨ HTTP ä¼ è¾“

2. **RISP MCP ç¡¬ç¼–ç ä¸º streamable-http**:
   ```python
   app.run(transport="streamable-http")  # å¼ºåˆ¶ä½¿ç”¨ HTTP ä¼ è¾“
   ```

3. **FastMCP ç‰ˆæœ¬å·®å¼‚**:
   - Billing MCP: `fastmcp>=2.14.0`
   - RISP MCP: `fastmcp>=2.14.0`
   - ç‰ˆæœ¬ç›¸åŒï¼Œä½†å¯èƒ½æœ‰å…¶ä»–é…ç½®å·®å¼‚

### é—®é¢˜3: å‚æ•°ç±»å‹å£°æ˜çš„å½±å“

#### Billing MCP çš„å‚æ•°å£°æ˜
```python
async def get_cost_and_usage(
    ctx: Context,
    ce_client,
    start_date: Optional[str] = None,
    end_date: Optional[str] = None,
    granularity: str = 'DAILY',
    metrics: Optional[str] = None,  # âš ï¸ å£°æ˜ä¸º str
    group_by: Optional[str] = None,  # âš ï¸ å£°æ˜ä¸º str
    filter_expr: Optional[str] = None,  # âš ï¸ å£°æ˜ä¸º str
    # ...
) -> Dict[str, Any]:
    # ç„¶ååœ¨å‡½æ•°å†…éƒ¨è°ƒç”¨ parse_json()
    metrics_list = parse_json(metrics, 'metrics')
    group_by_list = parse_json(group_by, 'group_by')
    filters = parse_json(filter_expr, 'filter')
```

#### RISP MCP çš„å‚æ•°å£°æ˜
```python
async def get_reservation_utilization(
    ctx: Context,
    start_date: Annotated[str, Field(description="Start date in YYYY-MM-DD format")],
    end_date: Annotated[str, Field(description="End date in YYYY-MM-DD format")],
    granularity: Annotated[Optional[str], Field(...)] = "MONTHLY",
    filter_expression: Optional[str] = None,  # âš ï¸ å£°æ˜ä¸º str
    # ...
) -> dict[str, Any]:
    # ç„¶ååœ¨å‡½æ•°å†…éƒ¨è°ƒç”¨ parse_json()
    parsed_filter = parse_json(filter_expression, 'filter_expression') if filter_expression else None
```

**ä¸¤è€…çš„å‚æ•°å£°æ˜å®Œå…¨ç›¸åŒï¼** éƒ½å£°æ˜ä¸º `Optional[str]`ï¼Œç„¶ååœ¨å‡½æ•°å†…éƒ¨è°ƒç”¨ `parse_json()`ã€‚

## ğŸ¤” ä¸ºä»€ä¹ˆ Billing MCP å·¥ä½œè€Œ RISP MCP ä¸å·¥ä½œï¼Ÿ

### å¯èƒ½çš„åŸå› 

1. **FastMCP çš„ç±»å‹å¼ºåˆ¶è½¬æ¢**:
   - å½“å‚æ•°å£°æ˜ä¸º `Optional[str]` æ—¶ï¼ŒFastMCP å¯èƒ½ä¼šå°è¯•å°†ä¼ å…¥çš„ dict/list è½¬æ¢ä¸º JSON å­—ç¬¦ä¸²
   - ä½†è¿™ä¸ªè¡Œä¸ºå¯èƒ½ä¸ä¸€è‡´æˆ–æœ‰ bug

2. **Gateway çš„å‚æ•°ä¼ é€’æ–¹å¼**:
   - Gateway å¯èƒ½åœ¨æŸäº›æƒ…å†µä¸‹ä¼ é€’ JSON å­—ç¬¦ä¸²
   - åœ¨å…¶ä»–æƒ…å†µä¸‹ä¼ é€’åŸç”Ÿ Python å¯¹è±¡
   - è¿™å–å†³äº Gateway çš„é…ç½®æˆ–ç‰ˆæœ¬

3. **MCP å·¥å…·æ³¨å†Œæ–¹å¼çš„å·®å¼‚**:
   - Billing MCP ä½¿ç”¨ `await mcp.import_server(cost_explorer_server)`
   - RISP MCP ä½¿ç”¨ `app.tool("get_ri_utilization")(get_reservation_utilization)`
   - ä¸åŒçš„æ³¨å†Œæ–¹å¼å¯èƒ½å¯¼è‡´å‚æ•°å¤„ç†ä¸åŒ

4. **FastMCP çš„ stateless_http é…ç½®**:
   - Billing MCP: `stateless_http=True` (åœ¨ entrypoint.py ä¸­)
   - RISP MCP: `stateless_http=True` (åœ¨ FastMCP åˆå§‹åŒ–ä¸­)
   - ä½†å®é™…è¿è¡Œæ—¶å¯èƒ½æœ‰å·®å¼‚

## ğŸ’¡ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: æ··åˆç±»å‹å¤„ç†ï¼ˆæ¨èï¼‰

ä¿®æ”¹ `parse_json()` å‡½æ•°ï¼ŒåŒæ—¶æ”¯æŒ JSON å­—ç¬¦ä¸²å’ŒåŸç”Ÿ Python å¯¹è±¡ï¼š

```python
def parse_json(json_input: Optional[str | dict | list], parameter_name: str) -> Any:
    """Parse JSON input that can be either a string or already-parsed object.
    
    Args:
        json_input: Can be:
            - JSON string (from STDio transport)
            - dict/list (from Gateway transport)
            - None
        parameter_name: Parameter name for error messages
    
    Returns:
        Parsed Python object or None
    
    Raises:
        ValueError: If JSON string is malformed
    """
    if not json_input:
        return None
    
    # If already a dict or list, return as-is (Gateway transport)
    if isinstance(json_input, (dict, list)):
        return json_input
    
    # If string, parse it (STDio transport)
    if isinstance(json_input, str):
        try:
            return json.loads(json_input)
        except json.JSONDecodeError:
            raise ValueError(f'Invalid JSON format for {parameter_name} parameter: {json_input}')
    
    # Unexpected type
    raise ValueError(f'Unexpected type for {parameter_name}: {type(json_input)}')
```

### æ–¹æ¡ˆ2: ä¿®æ”¹å‚æ•°ç±»å‹å£°æ˜

å°†å‚æ•°å£°æ˜ä¸º `dict | str | None`ï¼Œè®© FastMCP ä¸åšç±»å‹è½¬æ¢ï¼š

```python
async def get_reservation_utilization(
    ctx: Context,
    start_date: str,
    end_date: str,
    filter_expression: dict[str, Any] | str | None = None,  # âš ï¸ æ”¯æŒå¤šç§ç±»å‹
    # ...
) -> dict[str, Any]:
    # ä½¿ç”¨æ”¹è¿›çš„ parse_json()
    parsed_filter = parse_json(filter_expression, 'filter_expression')
```

### æ–¹æ¡ˆ3: æ£€æŸ¥ Billing MCP çš„å®é™…è¿è¡Œç¯å¢ƒ

éœ€è¦éªŒè¯ Billing MCP åœ¨ Gateway éƒ¨ç½²æ—¶çš„å®é™…å‚æ•°ç±»å‹ï¼š

1. æ·»åŠ æ—¥å¿—è®°å½•å‚æ•°ç±»å‹
2. æ£€æŸ¥ Gateway çš„é…ç½®
3. å¯¹æ¯”ä¸¤ä¸ª MCP çš„ Gateway Target é…ç½®

## ğŸ“‹ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **éªŒè¯ Billing MCP çš„å®é™…å‚æ•°ç±»å‹**:
   - åœ¨ Billing MCP çš„ handler ä¸­æ·»åŠ æ—¥å¿—
   - è®°å½• `filter_expr` å‚æ•°çš„å®é™…ç±»å‹
   - ç¡®è®¤ Gateway ä¼ é€’çš„æ˜¯å­—ç¬¦ä¸²è¿˜æ˜¯å¯¹è±¡

2. **å®æ–½æ–¹æ¡ˆ1ï¼ˆæ··åˆç±»å‹å¤„ç†ï¼‰**:
   - ä¿®æ”¹ RISP MCP çš„ `parse_json()` å‡½æ•°
   - æ”¯æŒåŒæ—¶å¤„ç†å­—ç¬¦ä¸²å’Œå¯¹è±¡
   - æµ‹è¯• STDio å’Œ Gateway ä¸¤ç§ä¼ è¾“æ–¹å¼

3. **æ›´æ–° Spec æ–‡æ¡£**:
   - æ›´æ–° requirements.md
   - æ›´æ–° design.md
   - æ›´æ–° tasks.md

## ğŸ”— ç›¸å…³æ–‡ä»¶

- `src/billing-cost-management-mcp-server/entrypoint.py`
- `src/billing-cost-management-mcp-server/awslabs/billing_cost_management_mcp_server/server.py`
- `src/billing-cost-management-mcp-server/awslabs/billing_cost_management_mcp_server/utilities/aws_service_base.py`
- `src/costq-risp-mcp-server/server.py`
- `src/costq-risp-mcp-server/utils/formatters.py`
- `src/costq-risp-mcp-server/handlers/ri_handler.py`
- `.kiro/specs/costq-risp-parameter-type-fix/requirements.md`
- `.kiro/specs/costq-risp-parameter-type-fix/design.md`
- `.kiro/specs/costq-risp-parameter-type-fix/tasks.md`

## ğŸ“ ç»“è®º

**æ ¹æœ¬åŸå› **: FastMCP åœ¨ä¸åŒä¼ è¾“æ¨¡å¼ä¸‹çš„å‚æ•°åºåˆ—åŒ–è¡Œä¸ºä¸ä¸€è‡´ï¼Œå¯¼è‡´ Gateway ä¼ é€’çš„å‚æ•°å¯èƒ½æ˜¯åŸç”Ÿ Python å¯¹è±¡è€Œä¸æ˜¯ JSON å­—ç¬¦ä¸²ã€‚

**æ¨èæ–¹æ¡ˆ**: ä¿®æ”¹ `parse_json()` å‡½æ•°ï¼ŒåŒæ—¶æ”¯æŒ JSON å­—ç¬¦ä¸²å’ŒåŸç”Ÿ Python å¯¹è±¡ï¼Œç¡®ä¿åœ¨ä¸¤ç§ä¼ è¾“æ¨¡å¼ä¸‹éƒ½èƒ½æ­£å¸¸å·¥ä½œã€‚

**å…³é”®æ•™è®­**: 
1. ä¸è¦å‡è®¾å‚æ•°ç±»å‹ï¼Œè¦éªŒè¯å®é™…ä¼ é€’çš„ç±»å‹
2. MCP å·¥å…·åº”è¯¥æ”¯æŒå¤šç§ä¼ è¾“æ–¹å¼ï¼ˆSTDio å’Œ HTTPï¼‰
3. å‚æ•°å¤„ç†å‡½æ•°åº”è¯¥å…·æœ‰å®¹é”™æ€§ï¼Œæ”¯æŒå¤šç§è¾“å…¥æ ¼å¼
